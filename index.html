<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- CSP في وضع المراقبة فقط (لا يعطل الميزات الحالية) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; connect-src 'self' https: data: blob:; font-src 'self' https: data:; frame-ancestors 'self'; report-to csp-endpoint; report-uri https://example.invalid/csp-report">
    <meta http-equiv="Content-Security-Policy-Report-Only" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; connect-src 'self' https: data: blob:; font-src 'self' https: data:; frame-ancestors 'self'; report-to csp-endpoint; report-uri https://example.invalid/csp-report">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#575657">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/icon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="./icons/icon-64.png">
    <!-- تعطيل تحميل خط Amiri مؤقتاً لتفادي تحذير OTS -->
    <!-- <link rel="preload" as="font" type="font/woff2" href="./fonts/Amiri-Regular.woff2" crossorigin> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="تطبيق ادارة المبيعات والمصروفات والمخزون ومتابعة الديون والمحلات وتقارير مفصلة للارباح والخسائر وحساب ارباح الشركاء - كل ماتحتاجه في مكان واحد">
    <meta name="version" content="01.06">
    <title>فاست لينك - حسابات</title>
    <meta name="application-name" content="فاست لينك - حسابات">
    <meta name="apple-mobile-web-app-title" content="فاست لينك - حسابات">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/dark-theme-fixes.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* @font-face مؤقتاً معطل بسبب ملف خط غير صالح
        @font-face {
            font-family: 'AmiriExport';
            font-style: normal;
            font-weight: 400;
            src: url('./fonts/Amiri-Regular.woff2') format('woff2');
            font-display: swap;
            unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF, U+FE70-FEFF;
        } */
        :root {
            --primary-color: #575657;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            direction: rtl;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            background: var(--primary-color);
            color: white;
            min-width: 250px;
            padding: 0;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .sidebar .logo {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            padding: 15px 20px;
            border-radius: 0;
            transition: all 0.3s;
            margin: 5px 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        
        .sidebar .nav-link:hover, 
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        
        .sidebar .nav-link i {
            margin-left: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header-bar {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px;
        }
        
        .page-title {
            font-weight: 700;
            color: var(--dark-color);
            margin: 0;
        }
        
        .section-content {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--primary-color);
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--light-color);
            padding: 12px 15px;
            text-align: right;
            font-weight: 600;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover td {
            background: rgba(52, 152, 219, 0.05);
        }
        
        .action-buttons .btn {
            margin-left: 5px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-title {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .store-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .store-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .store-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        .store-balance {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .balance-positive {
            color: var(--success-color);
        }
        
        .balance-negative {
            color: var(--accent-color);
        }
        
        .export-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .export-btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* تمت إزالة .currency::after لأن العملة تضاف من خلال formatNumber */
        
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(44, 62, 80, 0.25);
            border-color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #1a2530;
            border-color: #1a2530;
        }
        
        .package-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 4000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            display: none;
        }
        
        .notification.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .notification.success {
            background-color: var(--success-color);
        }
        
        .notification.error {
            background-color: var(--accent-color);
        }
        
        .notification.info {
            background-color: var(--secondary-color);
        }
        
        .formatted-number {
            text-align: left;
            direction: ltr;
            display: inline-block;
        }
        
        .profit-positive {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .profit-negative {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .partner-report-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* دعم الوضع الداكن لتقرير الشركاء */
        body.dark-theme .partner-report-card {
            background: linear-gradient(135deg, #1f2937, #111827);
            color: #e5e7eb;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }
        body.dark-theme .partner-report-card .table th,
        body.dark-theme .partner-report-card .table td {
            color: #e5e7eb;
            border-color: rgba(255,255,255,0.12);
        }
        body.dark-theme .partner-report-card .table thead th { background-color: rgba(255,255,255,0.06); }
        body.dark-theme .partner-report-card .partner-report-title { color: #f9fafb; }
        body.dark-theme .partner-report-card .partner-report-dates { color: #cbd5e1; }
        body.dark-theme .partner-report-card .btn-outline-primary { border-color: #60a5fa; color: #93c5fd; }
        body.dark-theme .partner-report-card .btn-outline-primary:hover { background-color: #3b82f6; color: #fff; }
        body.dark-theme .partner-report-card .btn-outline-danger { border-color: #f87171; color: #fca5a5; }
        body.dark-theme .partner-report-card .btn-outline-danger:hover { background-color: #ef4444; color: #fff; }
        body.dark-theme .input-group-text { background-color: #1f2937; color: #e5e7eb; border-color: #374151; }
        body.dark-theme #partnersEditorList .input-group-text { background-color: #1f2937; color: #e5e7eb; border-color: #374151; }
        
        /* أنماط أزرار الإجراءات في تقرير الشركاء */
        .partner-report-card .btn-sm {
            padding: 0.25rem 0.5rem;
            margin: 0 0.125rem;
            font-size: 0.875rem;
        }
        
        .partner-report-card .table td {
            vertical-align: middle;
        }
        
        .partner-report-card .table th:last-child,
        .partner-report-card .table td:last-child {
            text-align: center;
            white-space: nowrap;
        }
        
        .partner-report-card .btn-outline-primary:hover {
            background-color: #007bff;
            color: white;
        }
        
        .partner-report-card .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }
        
        .partner-report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .partner-report-title {
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        
        .partner-report-dates {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .partner-report-summary {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .summary-item {
            flex: 1;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* ============= أنماط المظهر الداكن ============= */
        body.dark-theme {
            background-color: #0f0f0f;
            color: #f0f0f0;
        }
        
        body.dark-theme .sidebar {
            background: linear-gradient(180deg, #1a1f2e 0%, #151923 100%);
        }
        
        body.dark-theme .main-content {
            background-color: #0f0f0f;
        }
        
        body.dark-theme .header-bar,
        body.dark-theme .section-content,
        body.dark-theme .stat-card,
        body.dark-theme .modal-content,
        body.dark-theme .card {
            background-color: #1a1f2e;
            color: #f0f0f0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            border: 1px solid #2a2f3e;
        }
        
        body.dark-theme .form-control,
        body.dark-theme .form-select {
            background-color: #252a3a;
            color: #f0f0f0;
            border-color: #3a3f4e;
        }
        
        body.dark-theme .form-control:focus,
        body.dark-theme .form-select:focus {
            background-color: #2a2f3e;
            color: #f0f0f0;
            border-color: #4a8eff;
            box-shadow: 0 0 0 0.2rem rgba(74, 142, 255, 0.25);
        }
        
        body.dark-theme .table {
            color: #f0f0f0;
        }
        
        body.dark-theme .table th {
            background-color: #252a3a !important;
            color: #ffffff !important;
            border-color: #3a3f4e !important;
            font-weight: 600;
        }
        
        body.dark-theme .table td {
            background-color: #1a1f2e !important;
            border-color: #2a2f3e !important;
            color: #f0f0f0 !important;
        }
        
        body.dark-theme .table thead th {
            background-color: #1f2937 !important;
            color: #ffffff !important;
        }
        
        /* إصلاح عناوين الجداول في جميع الأقسام */
        body.dark-theme .section-title,
        body.dark-theme .card-title,
        body.dark-theme .modal-title,
        body.dark-theme h1, 
        body.dark-theme h2, 
        body.dark-theme h3, 
        body.dark-theme h4, 
        body.dark-theme h5, 
        body.dark-theme h6 {
            color: #ffffff !important;
        }
        
        /* إصلاح النصوص في العرض الجدولي */
        body.dark-theme .data-table th,
        body.dark-theme .data-table td {
            color: #f0f0f0 !important;
        }
        
        /* إصلاح data-table بشكل خاص */
        body.dark-theme .data-table {
            background-color: #1a1f2e !important;
        }
        body.dark-theme .data-table th {
            background-color: #0f141f !important;
            color: #ffffff !important;
            border-color: #2a2f3e !important;
        }
        
        body.dark-theme .data-table td {
            background-color: #1a1f2e !important;
            color: #f0f0f0 !important;
            border-bottom-color: #2a2f3e !important;
        }
        
        body.dark-theme .data-table tr:hover td {
            background-color: #252a3a !important;
        }
        
        /* إصلاح كشف الحساب */
        body.dark-theme .account-statement th,
        body.dark-theme .account-statement td,
        body.dark-theme .statement-header,
        body.dark-theme .statement-details {
            color: #f0f0f0 !important;
        }
        
        body.dark-theme .table-striped tbody tr:nth-of-type(odd) {
            background-color: #202530;
        }
        
        body.dark-theme .table-striped tbody tr:nth-of-type(even) {
            background-color: #1a1f2e;
        }
        
        body.dark-theme .table-hover tbody tr:hover {
            background-color: #252a3a;
            color: #ffffff;
        }
        
        body.dark-theme .btn-primary {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        body.dark-theme .btn-secondary {
            background-color: #6b7280;
            border-color: #6b7280;
        }
        
        body.dark-theme .list-group-item {
            background-color: #374151;
            color: #e0e0e0;
            border-color: #4b5563;
        }
        
        body.dark-theme .list-group-item.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        body.dark-theme .modal-header,
        body.dark-theme .modal-footer {
            border-color: #4b5563;
        }
        
        body.dark-theme .close,
        body.dark-theme .btn-close {
            color: #e0e0e0;
            opacity: 0.8;
        }
        
        body.dark-theme .page-title {
            color: #e0e0e0;
        }
        
        body.dark-theme .section-title {
            color: #60a5fa;
            border-bottom-color: #4b5563;
        }
        
        body.dark-theme .text-muted {
            color: #9ca3af !important;
        }
        
        body.dark-theme .alert-info {
            background-color: #1e3a5f;
            color: #93c5fd;
            border-color: #2563eb;
        }
        
        body.dark-theme .alert-warning {
            background-color: #422006;
            color: #fbbf24;
            border-color: #d97706;
        }
        
        body.dark-theme .alert-danger {
            background-color: #450a0a;
            color: #fca5a5;
            border-color: #dc2626;
        }
        
        body.dark-theme .alert-success {
            background-color: #052e16;
            color: #86efac;
            border-color: #16a34a;
        }
        
        /* إصلاح مربعات التصدير والاستيراد */
        body.dark-theme .export-options label,
        body.dark-theme .import-section label {
            color: #f0f0f0;
        }
        
        body.dark-theme .export-options .form-check-input {
            background-color: #252a3a;
            border-color: #3a3f4e;
        }
        
        body.dark-theme .export-options .form-check-input:checked {
            background-color: #4a8eff;
            border-color: #4a8eff;
        }
        
        /* إصلاح منطقة table-responsive */
        body.dark-theme .table-responsive {
            background-color: transparent;
        }
        
        body.dark-theme .table-responsive .table {
            margin-bottom: 0;
        }
        
        /* إصلاح الأيقونات والنصوص الباهتة */
        body.dark-theme .fa, 
        body.dark-theme .fas, 
        body.dark-theme .far {
            color: #a0a0a0;
        }
        
        body.dark-theme .btn .fa,
        body.dark-theme .btn .fas,
        body.dark-theme .btn .far {
            color: inherit;
        }
        
        /* إصلاح حدود وخلفيات إضافية */
        body.dark-theme .border {
            border-color: #3a3f4e !important;
        }
        body.dark-theme .bg-light {
            background-color: #252a3a !important;
        }
        body.dark-theme .bg-white {
            background-color: #1a1f2e !important;
            color: #f0f0f0;
        }
        
        /* إصلاح ألوان النصوص الثانوية */
        body.dark-theme .text-secondary {
            color: #b0b0b0 !important;
        }
        
        body.dark-theme .text-muted {
            color: #888888 !important;
        }
        
        body.dark-theme .text-dark {
            color: #f0f0f0 !important;
        }
        
        /* إصلاح أقسام الإحصائيات */
        body.dark-theme .stat-card h3 {
            color: #ffffff;
        }
        
        body.dark-theme .stat-card p {
            color: #b0b0b0;
        }
        
        /* إصلاح القوائم المنسدلة */
        body.dark-theme .dropdown-menu {
            background-color: #252a3a;
            border-color: #3a3f4e;
        }
        
        body.dark-theme .dropdown-item {
            color: #f0f0f0;
        }
        
        body.dark-theme .dropdown-item:hover {
            background-color: #2a2f3e;
            color: #ffffff;
        }
        
        /* إصلاح شريط التقدم */
        body.dark-theme .progress {
            background-color: #252a3a;
        }
        
        /* إصلاح البطاقات */
        body.dark-theme .card-header {
            background-color: #252a3a;
            border-bottom-color: #3a3f4e;
            color: #f0f0f0;
        }
        
        body.dark-theme .card-footer {
            background-color: #252a3a;
            border-top-color: #3a3f4e;
            color: #f0f0f0;
        }
        
        /* إصلاحات إضافية للمظهر الداكن */
        body.dark-theme label {
            color: #f0f0f0 !important;
        }
        
        body.dark-theme .form-label {
            color: #f0f0f0 !important;
        }
        
        body.dark-theme .badge {
            background-color: #374151;
            color: #f0f0f0;
        }
        
        body.dark-theme .badge-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        
        body.dark-theme .badge-success {
            background-color: #10b981;
            color: #ffffff;
        }
        
        body.dark-theme .badge-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        
        body.dark-theme .badge-warning {
            background-color: #f59e0b;
            color: #ffffff;
        }
        
        body.dark-theme .badge-info {
            background-color: #3b82f6;
            color: #ffffff;
        }
        
        /* إصلاح التبويبات والقوائم */
        body.dark-theme .nav-tabs .nav-link {
            color: #a0a0a0;
            background-color: transparent;
            border-color: #3a3f4e;
        }
        
        body.dark-theme .nav-tabs .nav-link.active {
            color: #ffffff;
            background-color: #1a1f2e;
            border-color: #3a3f4e #3a3f4e #1a1f2e;
        }
        
        body.dark-theme .nav-tabs .nav-link:hover {
            color: #ffffff;
            border-color: #4a5568;
        }
        
        /* إصلاح أزرار الإغلاق والتحكم */
        body.dark-theme .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* إصلاح breadcrumb */
        body.dark-theme .breadcrumb {
            background-color: #252a3a;
        }
        
        body.dark-theme .breadcrumb-item.active {
            color: #a0a0a0;
        }
        
        body.dark-theme .breadcrumb-item a {
            color: #60a5fa;
        }
        
        /* إصلاح pagination */
        body.dark-theme .pagination .page-link {
            background-color: #252a3a;
            color: #f0f0f0;
            border-color: #3a3f4e;
        }
        
        body.dark-theme .pagination .page-link:hover {
            background-color: #374151;
            color: #ffffff;
            border-color: #4a5568;
        }
        
        body.dark-theme .pagination .page-item.active .page-link {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }
        
        /* إصلاح tooltips و popovers */
        body.dark-theme .tooltip-inner {
            background-color: #374151;
            color: #f0f0f0;
        }
        
        body.dark-theme .popover {
            background-color: #252a3a;
            border-color: #3a3f4e;
        }
        
        body.dark-theme .popover-header {
            background-color: #1f2937;
            color: #ffffff;
            border-bottom-color: #3a3f4e;
        }
        
        body.dark-theme .popover-body {
            color: #f0f0f0;
        }
        
        /* إصلاح date-header-row */
        body.dark-theme .date-header-row {
            background-color: #0f141f !important;
            color: #ffffff !important;
        }
        
        body.dark-theme .date-header-row td,
        body.dark-theme .date-header-row th {
            background-color: #0f141f !important;
            color: #ffffff !important;
            font-weight: bold;
        }
        
        /* إصلاح حقول البحث */
        body.dark-theme #storeSearchInput,
        body.dark-theme input[type="search"],
        body.dark-theme input[type="text"].search-input {
            background-color: #1a1f2e !important;
            color: #f0f0f0 !important;
            border-color: #3a3f4e !important;
        }
        
        body.dark-theme #storeSearchInput::placeholder,
        body.dark-theme input[type="search"]::placeholder {
            color: #808080 !important;
        }
        
        /* إصلاح table-responsive */
        body.dark-theme .table-responsive {
            background-color: transparent !important;
        }
        
        body.dark-theme .table-responsive table {
            background-color: #1a1f2e !important;
        }
        
        /* إصلاح الأزرار outline-dark */
        body.dark-theme .btn-outline-dark {
            color: #f0f0f0 !important;
            border-color: #f0f0f0 !important;
            background-color: transparent;
        }
        
        body.dark-theme .btn-outline-dark:hover {
            color: #0f0f0f !important;
            background-color: #f0f0f0 !important;
            border-color: #f0f0f0 !important;
        }
        
        /* إصلاح أزرار التصدير */
        body.dark-theme .export-btn {
            background-color: #252a3a !important;
            color: #f0f0f0 !important;
            border-color: #3a3f4e !important;
        }
        
        body.dark-theme .export-btn:hover {
            background-color: #374151 !important;
            color: #ffffff !important;
            border-color: #4a5568 !important;
        }
        
        /* إصلاح جميع الأزرار outline في الوضع الداكن */
        body.dark-theme .btn-outline-primary,
        body.dark-theme .btn-outline-secondary,
        body.dark-theme .btn-outline-success,
        body.dark-theme .btn-outline-danger,
        body.dark-theme .btn-outline-warning,
        body.dark-theme .btn-outline-info {
            background-color: transparent;
        }
        
        body.dark-theme .btn-outline-primary:hover {
            color: #fff !important;
        }
        
        /* تأكد من وضوح جميع النصوص في الجداول */
        body.dark-theme table,
        body.dark-theme table * {
            color: #f0f0f0 !important;
        }
        
        body.dark-theme table thead {
            background-color: #0f141f !important;
        }
        
        body.dark-theme table thead th {
            color: #ffffff !important;
            font-weight: 600 !important;
        }
        
        /* ============= تطبيق الألوان المخصصة ============= */
        :root {
            --primary-color: #575657;
            --secondary-color: #6c757d;
            --text-color: #212529;
            --font-size-base: 14px;
        }
        
        body.dark-theme {
            --text-color: #e0e0e0;
        }
        
        body {
            color: var(--text-color) !important;
            font-size: var(--font-size-base);
        }
        
        /* تطبيق لون النص على جميع العناصر */
        body * {
            color: inherit;
        }
        
        /* تطبيق لون النص المخصص */
        body[data-text-color] {
            color: var(--text-color) !important;
        }
        
        body[data-text-color] p,
        body[data-text-color] span,
        body[data-text-color] div,
        body[data-text-color] li,
        body[data-text-color] td,
        body[data-text-color] label,
        body[data-text-color] .form-control,
        body[data-text-color] .form-select {
            color: inherit !important;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--primary-color) 85%, black);
            border-color: color-mix(in srgb, var(--primary-color) 85%, black);
        }
        
        .text-primary {
            color: var(--primary-color) !important;
        }
        
        .bg-primary {
            background-color: var(--primary-color) !important;
        }
        
        .border-primary {
            border-color: var(--primary-color) !important;
        }
        
        /* ============= كثافة العرض ============= */
        /* كثافة فائقة الضغط */
        body[data-density="ultra-compact"] .section-content {
            padding: 8px;
        }
        
        body[data-density="ultra-compact"] .form-control,
        body[data-density="ultra-compact"] .form-select {
            padding: 0.15rem 0.3rem;
            font-size: 0.8rem;
            height: 28px;
        }
        
        body[data-density="ultra-compact"] .btn {
            padding: 0.15rem 0.3rem;
            font-size: 0.8rem;
            height: 28px;
        }
        body[data-density="ultra-compact"] .table td,
        body[data-density="ultra-compact"] .table th {
            padding: 0.25rem;
        }
        
        body[data-density="ultra-compact"] .card {
            padding: 8px;
        }
        
        body[data-density="ultra-compact"] .header-bar {
            padding: 8px 12px;
        }
        
        /* كثافة مضغوطة */
        body[data-density="compact"] .section-content {
            padding: 15px;
        }
        
        body[data-density="compact"] .form-control,
        body[data-density="compact"] .form-select {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        body[data-density="compact"] .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        body[data-density="compact"] .table td,
        body[data-density="compact"] .table th {
            padding: 0.5rem;
        }
        
        /* كثافة عادية (افتراضي) */
        body[data-density="normal"] .section-content {
            padding: 25px;
        }
        
        /* كثافة مريحة */
        body[data-density="comfortable"] .section-content {
            padding: 35px;
        }
        
        body[data-density="comfortable"] .form-control,
        body[data-density="comfortable"] .form-select {
            padding: 0.75rem 1rem;
            font-size: 1.125rem;
        }
        
        body[data-density="comfortable"] .btn {
            padding: 0.75rem 1.5rem;
            font-size: 1.125rem;
        }
        
        body[data-density="comfortable"] .table td,
        body[data-density="comfortable"] .table th {
            padding: 1rem;
        }
        
        /* كثافة واسعة */
        body[data-density="spacious"] .section-content {
            padding: 45px;
        }
        
        body[data-density="spacious"] .form-control,
        body[data-density="spacious"] .form-select {
            padding: 1rem 1.25rem;
            font-size: 1.25rem;
            height: 50px;
        }
        
        body[data-density="spacious"] .btn {
            padding: 1rem 2rem;
            font-size: 1.25rem;
            height: 50px;
        }
        
        body[data-density="spacious"] .table td,
        body[data-density="spacious"] .table th {
            padding: 1.25rem;
        }
        
        body[data-density="spacious"] .card {
            padding: 30px;
        }
        
        body[data-density="spacious"] .header-bar {
            padding: 25px 30px;
        }
        
        body[data-density="spacious"] .modal-header,
        body[data-density="spacious"] .modal-body,
        body[data-density="spacious"] .modal-footer {
            padding: 1.5rem;
        }
        
        /* ============= تعطيل التأثيرات الحركية ============= */
        body.no-animations * {
            animation: none !important;
            transition: none !important;
        }
        
        /* ============= الزوايا المستديرة ============= */
        body.no-rounded-corners .section-content,
        body.no-rounded-corners .header-bar,
        body.no-rounded-corners .stat-card,
        body.no-rounded-corners .card,
        body.no-rounded-corners .btn,
        body.no-rounded-corners .form-control,
        body.no-rounded-corners .form-select,
        body.no-rounded-corners .modal-content,
        body.no-rounded-corners .list-group-item {
            border-radius: 0 !important;
        }
        
        /* ============= أحجام الخطوط ============= */
        body[data-font-size="tiny"] {
            font-size: 10px;
        }
        
        body[data-font-size="small"] {
            font-size: 12px;
        }
        
        body[data-font-size="medium"] {
            font-size: 14px;
        }
        
        body[data-font-size="large"] {
            font-size: 16px;
        }
        
        body[data-font-size="xlarge"] {
            font-size: 18px;
        }
        
        body[data-font-size="huge"] {
            font-size: 20px;
        }
        
        body[data-font-size="massive"] {
            font-size: 24px;
        }
        
        /* تطبيق حجم الخط على جميع العناصر */
        body[data-font-size="tiny"] .form-control,
        body[data-font-size="tiny"] .form-select,
        body[data-font-size="tiny"] .btn,
        body[data-font-size="tiny"] h1,
        body[data-font-size="tiny"] h2,
        body[data-font-size="tiny"] h3,
        body[data-font-size="tiny"] h4,
        body[data-font-size="tiny"] h5,
        body[data-font-size="tiny"] h6 {
            font-size: calc(10px * var(--heading-scale, 1));
        }
        
        body[data-font-size="small"] .form-control,
        body[data-font-size="small"] .form-select,
        body[data-font-size="small"] .btn {
            font-size: 12px;
        }
        
        body[data-font-size="large"] .form-control,
        body[data-font-size="large"] .form-select,
        body[data-font-size="large"] .btn {
            font-size: 16px;
        }
        
        body[data-font-size="xlarge"] .form-control,
        body[data-font-size="xlarge"] .form-select,
        body[data-font-size="xlarge"] .btn {
            font-size: 18px;
        }
        
        body[data-font-size="huge"] .form-control,
        body[data-font-size="huge"] .form-select,
        body[data-font-size="huge"] .btn,
        body[data-font-size="huge"] h1,
        body[data-font-size="huge"] h2,
        body[data-font-size="huge"] h3,
        body[data-font-size="huge"] h4,
        body[data-font-size="huge"] h5,
        body[data-font-size="huge"] h6 {
            font-size: calc(20px * var(--heading-scale, 1));
        }
        
        body[data-font-size="massive"] .form-control,
        body[data-font-size="massive"] .form-select,
        body[data-font-size="massive"] .btn,
        body[data-font-size="massive"] h1,
        body[data-font-size="massive"] h2,
        body[data-font-size="massive"] h3,
        body[data-font-size="massive"] h4,
        body[data-font-size="massive"] h5,
        body[data-font-size="massive"] h6 {
            font-size: calc(24px * var(--heading-scale, 1.2));
        }
        
        /* ============= أوزان الخطوط ============= */
        body {
            font-weight: var(--font-weight-base, 400);
        }
        
        body[data-font-weight="thin"] {
            font-weight: 100;
        }
        
        body[data-font-weight="light"] {
            font-weight: 300;
        }
        
        body[data-font-weight="normal"] {
            font-weight: 400;
        }
        
        body[data-font-weight="medium"] {
            font-weight: 500;
        }
        
        body[data-font-weight="semibold"] {
            font-weight: 600;
        }
        
        body[data-font-weight="bold"] {
            font-weight: 700;
        }
        
        body[data-font-weight="extrabold"] {
            font-weight: 800;
        }
        
        body[data-font-weight="black"] {
            font-weight: 900;
        }
        
        /* تطبيق وزن الخط على جميع العناصر */
        body[data-font-weight] .form-control,
        body[data-font-weight] .form-select,
        body[data-font-weight] .btn,
        body[data-font-weight] p,
        body[data-font-weight] span,
        body[data-font-weight] div,
        body[data-font-weight] li,
        body[data-font-weight] td {
            font-weight: inherit;
        }
        
        /* العناوين دائماً أثقل قليلاً */
        body[data-font-weight] h1,
        body[data-font-weight] h2,
        body[data-font-weight] h3,
        body[data-font-weight] h4,
        body[data-font-weight] h5,
        body[data-font-weight] h6,
        body[data-font-weight] th,
        body[data-font-weight] .font-weight-bold,
        body[data-font-weight] .fw-bold {
            font-weight: calc(var(--font-weight-base, 400) + 200);
        }


        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar { display: none; }
            .main-content { 
                padding: 10px; 
                margin-left: 0;
                margin-right: 0;
            }
            
            .stats-container {
                flex-direction: column;
            }
            
            .export-options {
                flex-direction: column;
                align-items: stretch;
            }
            
            .export-btn {
                width: 100%;
                min-width: 0;
            }
            
            .partner-report-summary {
                flex-direction: column;
                gap: 15px;
            }
        }
        /* درج الجوال */
        .mobile-drawer { position: fixed; top: 0; left: -80vw; width: 80vw; max-width: 320px; height: 100vh; background: #2c3e50; color:#fff; box-shadow: 2px 0 10px rgba(0,0,0,0.15); transition: left 0.3s ease; z-index: 2100; padding: 16px; overflow-y: auto; }
        .mobile-drawer .nav-link{ color:#ecf0f1; }
        .mobile-drawer .nav-link i{ color:#ecf0f1; }
        .mobile-drawer .nav-link:hover{ background: rgba(255,255,255,0.1); border-radius:6px; }
        .mobile-drawer.open { left: 0; }
        .drawer-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2050; display: none; }
        .drawer-backdrop.show { display: block; }
        @media (min-width: 769px) { .mobile-drawer, .drawer-backdrop { display: none !important; } }

        .sidebar .nav-link.active, #mobileDrawer .nav-link.active{ color:#fff; background: rgba(255,255,255,0.1); border-radius:6px; }
        #mobileDrawer .nav-link i{ font-size: 1.1rem; width: 24px; }
        
        /* اختيار نوع المصروف (chips) */
        .expense-type-picker .chips{ display:flex; flex-wrap:wrap; gap:8px; }
        .expense-type-chip{ cursor:pointer; user-select:none; padding:6px 10px; border-radius:16px; background:#eef2f7; color:#2c3e50; border:1px solid #d8e0ea; transition:all 0.2s ease; }
        .expense-type-chip:hover{ background:#e6eef8; }
        .expense-type-chip.active{ background:#2c3e50; color:#fff; border-color:#2c3e50; }
        .expense-type-picker .form-control{ flex:1; }
        
        /* تذييل الصفحة */
        .site-footer{ 
            background: var(--primary-color); 
            color: var(--primary-color-text, #ecf0f1); 
            border-top: 1px solid rgba(255,255,255,0.1); 
        }
        
        .site-footer a {
            color: var(--primary-color-text, #ecf0f1);
            opacity: 0.8;
            text-decoration: none;
        }
        
        .site-footer a:hover {
            color: var(--primary-color-text, #ecf0f1);
            opacity: 1;
            text-decoration: underline;
        }
        .site-footer .developer{ font-weight: 600; }
        .site-footer .contact i{ margin-left:6px; }
        .site-footer small{ 
            color: var(--primary-color-text, #bdc3c7); 
            opacity: 0.8;
        }

        .notification { z-index: 1500; }
        
        /* زر برغر للجوال */
        .burger{ width:28px; height:20px; position:relative; display:inline-block; }
        .burger span{ position:absolute; right:0; height:2px; width:100%; background:#2c3e50; transition:transform 0.3s ease, opacity 0.3s ease; }
        .burger span:nth-child(1){ top:0; }
        .burger span:nth-child(2){ top:9px; }
        .burger span:nth-child(3){ bottom:0; }
        
        /* حركات بسيطة للأقسام */
        .section{ opacity: 0; transform: translateY(6px); transition: opacity 0.25s ease, transform 0.25s ease; }
        .section.show{ opacity:1; transform:none; }

        body.drawer-open{ overflow: hidden; }
        @media (max-width: 768px){ .main-content{ padding:12px; height: calc(100vh - 48px); overflow-y:auto; -webkit-overflow-scrolling: touch; } }
        
        /* أنماط قسم المحلات المحسّنة */
        .stores-list-container {
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .stores-list-container .list-group-item {
            border: none;
            border-bottom: 1px solid #e3e6f0;
            transition: all 0.3s ease;
        }
        
        .stores-list-container .list-group-item:last-child {
            border-bottom: none;
        }
        
        .stores-list-container .list-group-item:hover {
            background-color: #f1f3f5;
            transform: translateX(-5px);
        }
        
        .stores-list-container .list-group-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .stores-list-container .list-group-item.active .text-muted {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .stores-list-container .list-group-item.active .text-success {
            color: #a3e4a3 !important;
        }
        
        .stores-list-container .list-group-item.active .text-danger {
            color: #f8b4b4 !important;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            height: 100%;
            border: 2px solid #e3e6f0;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .info-card.border-success {
            border-color: #28a745;
        }
        
        .info-card.border-danger {
            border-color: #dc3545;
        }
        
        .info-card i {
            font-size: 2rem;
        }
        
        .info-card h6 {
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        /* أنماط الفلترة المتقدمة */
        .advanced-filter-section .card {
            border: 1px solid #e1e5eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
            overflow: visible !important; /* تغيير overflow للسماح بظهور القائمة المنسدلة */
        }
        
        .advanced-filter-section .card-body {
            padding: 1rem;
        }
        
        /* إصلاح التخطيط للشاشات الصغيرة */
        @media (max-width: 768px) {
            .advanced-filter-section .row {
                gap: 1rem;
            }
            
            .advanced-filter-section .col-md-6 {
                margin-bottom: 1rem;
                width: 100%;
            }
            
            /* إصلاح أزرار الفلترة على الجوال */
            .advanced-filter-section .d-flex.gap-2 {
                flex-wrap: wrap;
                justify-content: center !important;
                margin-top: 0.5rem;
            }
            
            .filter-type-btn {
                min-width: auto;
                padding: 0.375rem 0.75rem;
                font-size: 0.875rem;
                flex: 1;
                max-width: 120px;
            }
            
            .filter-selector-btn {
                font-size: 0.875rem;
                padding: 8px 12px;
            }
            
            .filter-title {
                font-size: 0.9rem;
            }
            
            .filter-subtitle {
                font-size: 0.75rem;
            }
        }
        
        /* إصلاح التخطيط لسطح المكتب */
        @media (min-width: 769px) {
            .advanced-filter-section .row {
                align-items: center;
            }
            
            .advanced-filter-section .col-md-6:first-child {
                padding-right: 0.5rem;
            }
            
            .advanced-filter-section .col-md-6:last-child {
                padding-left: 0.5rem;
            }
        }
        
        .filter-selector-wrapper {
            position: relative;
            width: 100%;
            z-index: 1000; /* إضافة z-index للعنصر الأب */
        }
        /* إصلاح عرض الأزرار */
        .advanced-filter-section .btn-group {
            display: flex;
            gap: 0.25rem;
        }
        
        @media (max-width: 768px) {
            .advanced-filter-section .btn-group {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        .filter-selector-btn {
            text-align: right;
            padding: 10px 15px;
            border: 2px solid #e1e5eb;
            background: white;
            transition: all 0.3s;
        }
        
        .filter-selector-btn:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }
        
        .filter-selector-btn.active {
            border-color: var(--primary-color);
            background: #f0f4ff;
        }
        
        .filter-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-subtitle {
            font-size: 12px;
        }
        
        .filter-icon {
            font-size: 20px;
            color: var(--primary-color);
        }
        
        /* القائمة المنسدلة */
        .filter-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            left: 0;
            background: white;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            margin-top: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            z-index: 9999 !important; /* رفع z-index لضمان الظهور فوق كل شيء */
            max-height: 400px;
            overflow-y: auto;
        }
        
        .filter-group-title {
            padding: 8px 15px;
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            background: #f8f9fa;
            text-transform: uppercase;
            border-bottom: 1px solid #e9ecef;
        }
        
        .filter-option {
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .filter-option:hover {
            background: #f8f9fa;
        }
        
        .filter-option.active {
            background: #e8f0fe;
            color: #1976d2;
        }
        
        .filter-option i {
            font-size: 20px;
            width: 30px;
            text-align: center;
        }
        
        .filter-option-text {
            flex: 1;
        }
        
        .filter-option-text small {
            display: block;
            margin-top: 2px;
        }
        
        .filter-type-btn {
            min-width: 120px;
        }
        
        .filter-type-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* ملخص الفلترة */
        .filter-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .filter-summary.show {
            display: block;
        }
        
        .filter-summary-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .filter-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .filter-summary-stat {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .filter-summary-stat .value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .filter-summary-stat .label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* التاريخ المخصص */
        .custom-date-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* كشف الحساب المتحرك */
        .account-statement-container {
            padding: 20px 0;
        }
        
        .account-statement-table {
            font-size: 14px;
        }
        
        .account-statement-table th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }
        
        .account-statement-table td {
            vertical-align: middle;
        }
        
        .date-header-row td {
            background: #e9ecef;
            font-weight: 600;
            padding: 10px;
        }
        
        .sale-row {
            background-color: rgba(220, 53, 69, 0.05);
        }
        
        .payment-row {
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        .opening-balance-row {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .total-row td {
            font-size: 16px;
            padding: 12px;
        }
        
        /* العرض الزمني القديم - محتفظ به للمستقبل */
        .timeline-container {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 40px;
            margin-bottom: 30px;
            border-left: 3px solid #e9ecef;
            padding-bottom: 20px;
        }
        
        .timeline-item:last-child {
            border-left: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .timeline-dot {
            position: absolute;
            left: -8px;
            top: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #6c757d;
            z-index: 2;
        }
        
        .timeline-dot.sale {
            border-color: #dc3545;
        }
        
        .timeline-dot.payment {
            border-color: #28a745;
        }
        
        .timeline-content {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .timeline-content:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .timeline-date {
            font-size: 14px;
            color: #6c757d;
        }
        
        .timeline-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .timeline-type.sale {
            background: #f8d7da;
            color: #721c24;
        }
        
        .timeline-type.payment {
            background: #d4edda;
            color: #155724;
        }
        
        .timeline-details {
            margin: 10px 0;
        }
        
        .timeline-amount {
            font-size: 20px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .timeline-amount.sale {
            color: #dc3545;
        }
        
        .timeline-amount.payment {
            color: #28a745;
        }
        
        .timeline-balance {
            background: #fff3cd;
            color: #856404;
            padding: 8px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .timeline-balance.positive {
            background: #d4edda;
            color: #155724;
        }
        
        .timeline-balance.negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .timeline-actions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }
        
        /* تجميع التواريخ */
        .timeline-date-group {
            background: #f8f9fa;
            padding: 10px 20px;
            margin: 20px 0 10px 0;
            border-radius: 30px;
            font-weight: 600;
            color: #495057;
            text-align: center;
            position: relative;
        }
        
        .timeline-date-group:before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -10px;
            transform: translateX(-50%);
            width: 2px;
            height: 10px;
            background: #dee2e6;
        }
        
        /* أزرار نوع العرض */
        .view-type-selector {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        .view-type-selector .btn-group {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
      </style>
    <!-- شاشة ترحيب (Splash) -->
    <style>
        #splashScreen { position: fixed; inset: 0; background: linear-gradient(180deg, var(--primary-color), #111); display: flex; align-items: center; justify-content: center; z-index: 20000; color: #fff; }
        #splashCard { text-align: center; padding: 24px; border-radius: 16px; background: rgba(255,255,255,0.06); backdrop-filter: blur(6px); box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        #splashLogo { width: 96px; height: 96px; object-fit: contain; border-radius: 16px; background: #ffffff22; padding: 8px; }
        #splashTitle { margin: 10px 0 4px; font-weight: 700; }
        #splashDesc { font-size: 13px; opacity: 0.9; margin-bottom: 6px; }
        #splashRights { font-size: 13px; opacity: 0.85; line-height: 1.5; }
        .fade-out { animation: splashFade 600ms ease forwards; }
        @keyframes splashFade { to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body>
    <div id="splashScreen" style="display:none;">
        <div id="splashCard">
            <img id="splashLogo" src="./icons/icon-128.png" alt="شعار التطبيق">
            <div id="splashTitle">فاست لينك - حسابات</div>
            <div id="splashDesc"></div>
            <div id="splashRights"></div>
        </div>
    </div>
    <!-- شريط علوي للجوال مع زر القائمة -->
    <div class="w-100 d-flex d-md-none align-items-center px-3 py-2 mobile-topbar" style="background:#f8f9fa;position:sticky;top:0;z-index:3001;direction:ltr;">
        <div class="d-flex align-items-center flex-grow-1">
            <button id="mobileSidebarToggle" class="btn btn-outline-secondary me-2" style="border-color:#2c3e50; margin-bottom:0;">
                <span class="burger"><span></span><span></span><span></span></span>
            </button>
            <span class="fw-bold">القائمة</span>
        </div>
        <span class="small text-muted" id="mobileTopDate" style="margin-left:auto;"></span>
    </div>


    <!-- إشعارات النظام -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle me-2"></i>
        <span id="notificationText"></span>
    </div>

    <!-- لوحة التحكم الرئيسية -->
    <div class="app-container">
        <!-- الشريط الجانبي -->
        <div class="sidebar">
            <div class="logo">
                <img src="./icons/icon-128.png" alt="شعار التطبيق" style="width:64px; height:64px; object-fit:contain; border-radius:12px; background:#ffffff22; padding:6px;">
                <h5>فاست لينك - حسابات</h5>
                <p class="text-white-50 small" id="appVersionLabel">الإصدار 01.06</p>
            </div>
            
            <ul class="nav flex-column mt-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-section="dashboard">
                        <i class="fas fa-home"></i> لوحة التحكم
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="packages">
                        <i class="fas fa-box"></i> الباقات والأسعار
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="inventory">
                        <i class="fas fa-cubes"></i> كمية الكروت
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="stores">
                        <i class="fas fa-store"></i> البقالات والمحلات
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="expenses">
                        <i class="fas fa-money-bill-wave"></i> المصروفات
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="reports">
                        <i class="fas fa-chart-bar"></i> التقارير
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="importExport">
                        <i class="fas fa-exchange-alt"></i> الاستيراد والتصدير
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="trash">
                        <i class="fas fa-trash"></i> سلة المحذوفات
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="settings">
                        <i class="fas fa-cog"></i> الإعدادات
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="about" onclick="if(window.switchSection) switchSection('about','حول التطبيق')">
                        <i class="fas fa-info-circle"></i> حول التطبيق
                    </a>
                </li>
            </ul>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="main-content">
            <!-- شريط العنوان -->
            <div class="header-bar">
                <h2 class="page-title">لوحة التحكم</h2>
                <div>
                    <span id="syncBadge" class="badge bg-secondary me-2 d-none">الحالة</span>
                    <span id="currentDate" class="text-muted me-3"></span>
                    <span class="badge bg-primary">
                        <i class="fas fa-user me-1"></i> مدير النظام
                    </span>
                    <button type="button" class="btn btn-outline-dark ms-2 d-none" data-bs-toggle="modal" data-bs-target="#githubSyncModal">
                        <i class="fab fa-github me-1"></i> مزامنة جيت هب
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2 d-none" data-bs-toggle="modal" data-bs-target="#backupManagerModal">
                        <i class="fas fa-database me-1"></i> النسخ الاحتياطي
                    </button>
                </div>
            </div>



            <!-- لوحة التحكم -->
            <div id="dashboard" class="section">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <label for="dashboardPeriod" class="mb-0">مدة الحساب:</label>
                    <select id="dashboardPeriod" class="form-select form-select-sm" style="width:auto;">
                        <option value="from_start" selected>من البداية</option>
                        <option value="day">خلال يوم</option>
                        <option value="week">خلال اسبوع</option>
                        <option value="month">خلال شهر</option>
                        <option value="this_month">خلال هذا الشهر</option>
                        <option value="prev_month">خلال الشهر السابق</option>
                    </select>
                    <label for="dashboardSparkGroup" class="mb-0 ms-3">تجميع الرسم:</label>
                    <select id="dashboardSparkGroup" class="form-select form-select-sm" style="width:auto;">
                        <option value="day" selected>يومي</option>
                        <option value="week">أسبوعي</option>
                    </select>
                </div>
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-title">عدد الباقات</div>
                        <div id="packagesCount" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">إجمالي الكروت</div>
                        <div id="totalCards" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">عدد المحلات</div>
                        <div id="storesCount" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">إجمالي المبيعات</div>
                        <div id="totalSales" class="stat-value currency">0</div>
                        <div id="spark_sales" class="sparkline text-primary mt-1"></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">إجمالي التسديدات</div>
                        <div id="totalPaymentsSum" class="stat-value currency">0</div>
                        <div id="spark_payments" class="sparkline text-success mt-1"></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">إجمالي الديون</div>
                        <div id="totalDebtsSum" class="stat-value currency">0</div>
                        <div id="spark_debts" class="sparkline text-danger mt-1"></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">إجمالي المصروفات</div>
                        <div id="totalExpensesSum" class="stat-value currency">0</div>
                        <div id="spark_expenses" class="sparkline text-warning mt-1"></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">صافي الأرباح</div>
                        <div id="netProfit" class="stat-value currency">0</div>
                        <div id="spark_net" class="sparkline text-info mt-1"></div>
                    </div>
                </div>

                <div class="section-content">
                    <h4 class="section-title">اختصارات سريعة</h4>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-success" id="qaAddSale"><i class="fas fa-cart-plus me-2"></i>إضافة بيع</button>
                        <button class="btn btn-info" id="qaAddPayment"><i class="fas fa-money-bill me-2"></i>تسديد دفعة</button>
                        <button class="btn btn-primary" id="qaAddInventory"><i class="fas fa-cubes me-2"></i>إضافة كمية كروت</button>
                        <button class="btn btn-warning" id="qaAddExpense"><i class="fas fa-receipt me-2"></i>إضافة مصروف جديد</button>
                        <button class="btn btn-secondary" id="qaAddStore"><i class="fas fa-store me-2"></i>إضافة محل جديد</button>
                        <button class="btn btn-dark" id="qaAddPackage"><i class="fas fa-box me-2"></i>إضافة باقة جديدة</button>
                    </div>
                </div>
            </div>

            <!-- قسم الباقات والأسعار -->
            <div id="packages" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">إدارة الباقات والأسعار
                        <button class="btn btn-primary" id="addPackageBtn">
                            <i class="fas fa-plus me-2"></i>إضافة باقة جديدة
                        </button>
                    </h4>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>اسم الباقة</th>
                                    <th>سعر التجزئة</th>
                                    <th>سعر الجملة</th>
                                    <th>سعر الموزعين</th>
                                    <th>تاريخ الإضافة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTable">
                                <!-- سيتم ملؤه بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- قسم كمية الكروت -->
            <div id="inventory" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">إدارة كمية الكروت
                        <button class="btn btn-primary" id="addInventoryBtn">
                            <i class="fas fa-plus me-2"></i>إضافة كمية جديدة
                        </button>
                    </h4>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>اسم الباقة</th>
                                    <th>الكمية المتوفرة</th>
                                    <th>إجمالي القيمة (تجزئة)</th>
                                    <th>إجمالي القيمة (جملة)</th>
                                    <th>إجمالي القيمة (موزعين)</th>
                                    <th>تاريخ الإضافة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable">
                                <!-- سيتم ملؤه بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- قسم البقالات والمحلات -->
            <div id="stores" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">إدارة البقالات والمحلات
                        <button class="btn btn-primary" id="addStoreBtn">
                            <i class="fas fa-plus me-2"></i>إضافة محل جديد
                        </button>
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <!-- شريط البحث والفلاتر -->
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" id="storeSearchInput" class="form-control" placeholder="بحث في المحلات...">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">نوع السعر</label>
                                        <select id="storePriceFilter" class="form-select form-select-sm">
                                            <option value="all">جميع الأنواع</option>
                                            <option value="retail">تجزئة</option>
                                            <option value="wholesale">جملة</option>
                                            <option value="distributor">موزعين</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label">ترتيب حسب</label>
                                        <select id="storeSortBy" class="form-select form-select-sm">
                                            <option value="name">الاسم</option>
                                            <option value="date">تاريخ الإضافة</option>
                                            <option value="balance">الرصيد</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- قائمة المحلات -->
                            <div class="stores-list-container" style="max-height: 600px; overflow-y: auto;">
                                <div id="storesList" class="list-group">
                                    <!-- سيتم ملؤه بالبيانات -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div id="storeHeader" class="card-header bg-primary text-white">
                                    اختر محلًا لعرض التفاصيل
                                </div>
                                <div class="card-body">
                                    <div id="storeDetails">
                                        <div class="text-center py-5">
                                            <i class="fas fa-store fa-3x text-muted mb-3"></i>
                                            <p>اختر محلًا من القائمة لعرض التفاصيل</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- قسم المصروفات -->
            <div id="expenses" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title d-flex flex-wrap align-items-center justify-content-between gap-2">
                        <span>إدارة المصروفات</span>
                        <div class="actions">
                            <button class="btn btn-primary" id="addExpenseBtn">
                                <i class="fas fa-plus me-2"></i>إضافة مصروف جديد
                            </button>
                            <button class="btn btn-outline-secondary" id="manageExpenseTypesBtn">
                                <i class="fas fa-tags me-2"></i>إدارة الأنواع
                            </button>
                        </div>
                            <div class="mt-3 row g-2 align-items-center">
                            <div class="col-12 col-md-auto d-flex align-items-center gap-2">
                                <label for="expensesPeriod" class="mb-0">مدة العرض:</label>
                                <select id="expensesPeriod" class="form-select form-select-sm" style="width:auto; min-width: 160px;">
                                    <option value="from_start" selected>من البداية</option>
                                    <option value="day">خلال يوم</option>
                                    <option value="week">خلال اسبوع</option>
                                    <option value="month">خلال شهر</option>
                                    <option value="this_month">خلال هذا الشهر</option>
                                    <option value="prev_month">خلال الشهر السابق</option>
                                    <option value="custom">خلال مدة محددة</option>
                                </select>
                            </div>
                            <div class="col-12 col-md d-flex flex-wrap gap-2 align-items-center" id="expensesCustomRange" style="display:none;">
                                <input type="date" id="expensesFrom" class="form-control form-control-sm" style="min-width: 140px;">
                                <span>إلى</span>
                                <input type="date" id="expensesTo" class="form-control form-control-sm" style="min-width: 140px;">
                                <button class="btn btn-sm btn-outline-primary" id="applyExpensesCustomRange">تطبيق</button>
                            </div>
                        </div>
                    </h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    إجمالي المصروفات (الفترة: <span id="currentMonth"></span>)
                                </div>
                                <div class="card-body">
                                    <p id="totalExpenses" class="h2 text-center currency">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <tbody id="expensesTable">
                                <!-- سيتم ملؤه بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="export-options mt-4">
                        <button class="btn btn-outline-success export-btn" data-type="expenses" data-format="excel">
                            <i class="fas fa-file-excel me-2"></i>تصدير Excel
                        </button>
                        <button class="btn btn-outline-secondary export-btn" data-type="expenses" data-format="txt">
                            <i class="fas fa-file-alt me-2"></i>تصدير TXT
                        </button>
                        <!-- زر تصدير PDF مخفي حالياً - يمكن تفعيله لاحقاً عند تطوير ميزة تصدير PDF الحقيقية
                        <button class="btn btn-outline-danger export-btn" data-type="expenses" data-format="pdf">
                            <i class="fas fa-file-pdf me-2"></i>تصدير PDF
                        </button>
                        -->
                        <button class="btn btn-outline-primary export-btn" data-type="expenses" data-format="printpage">
                            <i class="fas fa-file-alt me-2"></i>فتح صفحة التقرير
                        </button>
                    </div>
                </div>
            </div>
            <!-- قسم التقارير -->
            <div id="reports" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">التقارير المالية</h4>

                    
                    <div class="card mb-3" id="quickSummariesCard">
                        <div class="card-header bg-light">ملخصات مرئية</div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end mb-3">
                                <div class="col-12 col-md-auto">
                                    <label class="form-label mb-1">المدة</label>
                                    <select id="summariesPeriod" class="form-select form-select-sm" style="min-width:160px;">
                                        <option value="from_start">من البداية</option>
                                        <option value="day">خلال يوم</option>
                                        <option value="week">خلال أسبوع</option>
                                        <option value="month">خلال شهر</option>
                                        <option value="this_month" selected>خلال هذا الشهر</option>
                                        <option value="prev_month">خلال الشهر السابق</option>
                                        <option value="custom">مدى مخصص</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-auto" id="summariesCustomRange" style="display:none;">
                                    <label class="form-label mb-1 d-block">نطاق التاريخ</label>
                                    <div class="d-flex gap-2">
                                        <input type="date" id="summariesFromDate" class="form-control form-control-sm" />
                                        <input type="date" id="summariesToDate" class="form-control form-control-sm" />
                                        <button class="btn btn-sm btn-primary" id="applySummariesRange" type="button">تطبيق</button>
                                    </div>
                                </div>
                                <div class="col-12 col-md-auto ms-auto d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success" id="exportSummariesExcel"><i class="fas fa-file-excel me-1"></i>Excel</button>
                                    <button class="btn btn-sm btn-outline-secondary" id="exportSummariesTxt"><i class="fas fa-file-alt me-1"></i>مستند</button>
                                    <!-- زر تصدير PDF مخفي حالياً - يمكن تفعيله لاحقاً عند تطوير ميزة تصدير PDF الحقيقية
                                    <button class="btn btn-sm btn-outline-danger" id="exportSummariesPdf"><i class="fas fa-file-pdf me-1"></i>PDF</button>
                                    -->
                                    <button class="btn btn-sm btn-outline-primary" id="openSummariesReport"><i class="fas fa-file-alt me-1"></i>فتح التقرير</button>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-12 col-md-4">
                                    <h6 class="mb-2 d-flex justify-content-between"><span>المبيعات</span><span class="currency" id="quickSalesTotal">0</span></h6>
                                    <canvas id="chartSales" height="80"></canvas>
                                </div>
                                <div class="col-12 col-md-4">
                                    <h6 class="mb-2 d-flex justify-content-between"><span>التسديدات</span><span class="currency" id="quickPaymentsTotal">0</span></h6>
                                    <canvas id="chartPayments" height="80"></canvas>
                                </div>
                                <div class="col-12 col-md-4">
                                    <h6 class="mb-2 d-flex justify-content-between"><span>المصروفات</span><span class="currency" id="quickExpensesTotal">0</span></h6>
                                    <canvas id="chartExpenses" height="80"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4" id="debtsReportCard">
                        <div class="card-header bg-info text-white">
                            تقرير الديون للمحلات <small class="text-white-50">(الفترة الحالية)</small>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end mb-3">
                                <div class="col-12 col-md-auto">
                                    <label class="form-label mb-1">المدة</label>
                                    <select id="debtsPeriod" class="form-select form-select-sm" style="min-width:160px;">
                                        <option value="from_start">من البداية</option>
                                        <option value="day">خلال يوم</option>
                                        <option value="week">خلال أسبوع</option>
                                        <option value="month">خلال شهر</option>
                                        <option value="this_month" selected>خلال هذا الشهر</option>
                                        <option value="prev_month">خلال الشهر السابق</option>
                                        <option value="custom">مدى مخصص</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-auto" id="debtsCustomRange" style="display:none;">
                                    <label class="form-label mb-1 d-block">نطاق التاريخ</label>
                                    <div class="d-flex gap-2">
                                        <input type="date" id="debtsFromDate" class="form-control form-control-sm" />
                                        <input type="date" id="debtsToDate" class="form-control form-control-sm" />
                                        <button class="btn btn-sm btn-primary" id="applyDebtsRange" type="button">تطبيق</button>
                                    </div>
                                </div>
                                <div class="col-12 col-md-auto ms-auto d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success" id="exportDebtsExcel"><i class="fas fa-file-excel me-1"></i>Excel</button>
                                    <button class="btn btn-sm btn-outline-secondary" id="exportDebtsTxt"><i class="fas fa-file-alt me-1"></i>مستند</button>
                                    <!-- زر تصدير PDF مخفي حالياً - يمكن تفعيله لاحقاً عند تطوير ميزة تصدير PDF الحقيقية
                                    <button class="btn btn-sm btn-outline-danger" id="exportDebtsPdf"><i class="fas fa-file-pdf me-1"></i>PDF</button>
                                    -->
                                    <button class="btn btn-sm btn-outline-primary" id="openDebtsReport"><i class="fas fa-file-alt me-1"></i>فتح التقرير</button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mb-2"><span class="me-2">إجمالي الديون:</span><span id="debtsTotalSummary" class="currency">0</span></div>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>اسم المحل</th>
                                            <th>إجمالي المبيعات</th>
                                            <th>المدفوع</th>
                                            <th>المتبقي</th>
                                            <th>نوع السعر</th>
                                            <th>آخر عملية</th>
                                        </tr>
                                    </thead>
                                    <tbody id="debtReportTable">
                                        <!-- سيتم ملؤه بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4" id="profitReportCard">
                        <div class="card-header bg-warning text-dark">
                            تقرير الأرباح والخسائر <small class="text-dark-50">(الفترة الحالية)</small>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end mb-3">
                                <div class="col-12 col-md-auto">
                                    <label class="form-label mb-1">المدة</label>
                                    <select id="profitPeriod" class="form-select form-select-sm" style="min-width:160px;">
                                        <option value="from_start">من البداية</option>
                                        <option value="day">خلال يوم</option>
                                        <option value="week">خلال أسبوع</option>
                                        <option value="month">خلال شهر</option>
                                        <option value="this_month" selected>خلال هذا الشهر</option>
                                        <option value="prev_month">خلال الشهر السابق</option>
                                        <option value="custom">مدى مخصص</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-auto" id="profitCustomRange" style="display:none;">
                                    <label class="form-label mb-1 d-block">نطاق التاريخ</label>
                                    <div class="d-flex gap-2">
                                        <input type="date" id="profitFromDate" class="form-control form-control-sm" />
                                        <input type="date" id="profitToDate" class="form-control form-control-sm" />
                                        <button class="btn btn-sm btn-primary" id="applyProfitRange" type="button">تطبيق</button>
                                    </div>
                                </div>
                                <div class="col-12 col-md-auto ms-auto d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success" id="exportProfitExcel"><i class="fas fa-file-excel me-1"></i>Excel</button>
                                    <button class="btn btn-sm btn-outline-secondary" id="exportProfitTxt"><i class="fas fa-file-alt me-1"></i>مستند</button>
                                    <!-- زر تصدير PDF مخفي حالياً - يمكن تفعيله لاحقاً عند تطوير ميزة تصدير PDF الحقيقية
                                    <button class="btn btn-sm btn-outline-danger" id="exportProfitPdf"><i class="fas fa-file-pdf me-1"></i>PDF</button>
                                    -->
                                    <button class="btn btn-sm btn-outline-primary" id="openProfitReport"><i class="fas fa-file-alt me-1"></i>فتح التقرير</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>الوصف</th>
                                            <th>المبلغ</th>
                                            <th>التفاصيل</th>
                                        </tr>
                                    </thead>
                                    <tbody id="profitReportTable">
                                        <tr>
                                            <td>إجمالي المبيعات</td>
                                            <td id="totalSalesReport" class="currency">0</td>
                                            <td>مجموع مبيعات الكروت لجميع المحلات</td>
                                        </tr>
                                        <tr>
                                            <td>إجمالي التسديدات</td>
                                            <td id="totalPaymentsReport" class="currency">0</td>
                                            <td>مجموع التسديدات المسجلة في النظام</td>
                                        </tr>
                                        <tr>
                                            <td>إجمالي المصروفات</td>
                                            <td id="totalExpensesReport" class="currency">0</td>
                                            <td>مجموع المصروفات المسجلة في النظام</td>
                                        </tr>
                                        <tr>
                                            <td>صافي الربح/الخسارة</td>
                                            <td id="netProfitReport" class="currency">0</td>
                                            <td>الفرق بين إجمالي المبيعات والمصروفات</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4" id="comparisonReportCard">
                        <div class="card-header bg-light">تقرير مقارنة: هذا الشهر مقابل الشهر السابق</div>
                        <div class="card-body">
                            <div class="mb-2" id="comparisonReportSubtitle" style="font-size: 0.95rem; color: #555;"></div>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>المؤشر</th>
                                            <th>هذا الشهر</th>
                                            <th>الشهر السابق</th>
                                            <th>الفرق</th>
                                            <th>النسبة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparisonReportTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" id="partnerReportsCard">
                        <div class="card-header bg-secondary text-white">
                            تقارير الشركاء
                        </div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end mb-3">
                                <!-- إدارة الشركاء داخل تقرير الشركاء -->
                                <div class="col-12">
                                    <div class="border rounded p-2 bg-light">
                                        <div class="row g-2 align-items-end">
                                            <div class="col-12 col-md-3">
                                                <label class="form-label mb-1">عدد الشركاء</label>
                                                <input type="number" id="partnersEditorCount" class="form-control form-control-sm" min="1" style="width:140px" />
                                            </div>
                                            <div class="col-12 col-md-3">
                                                <label class="form-label mb-1">طريقة التوزيع</label>
                                                <select id="partnersEditorDistribution" class="form-select form-select-sm" style="width:160px">
                                                    <option value="equal">تقسيم متساوٍ</option>
                                                    <option value="percent">حسب نسب</option>
                                                </select>
                                            </div>
                                            <div class="col-12 col-md-6">
                                                <label class="form-label mb-1">سحب جديد (الشريك/المبلغ/التاريخ/الملاحظة)</label>
                                                <div class="d-flex gap-2 flex-wrap">
                                                    <select id="partnersAdjPartner" class="form-select form-select-sm" style="max-width:220px"></select>
                                                    <div class="input-group input-group-sm" style="max-width:200px">
                                                        <input type="text" id="partnersAdjAmount" class="form-control formatted-input" placeholder="المبلغ" inputmode="decimal" />
                                                        <span class="input-group-text" id="partnersAdjCurrencyLabel">ريال</span>
                                                    </div>
                                                    <input type="date" id="partnersAdjDate" class="form-control form-control-sm" style="max-width:170px" />
                                                    <input type="text" id="partnersAdjNotes" class="form-control form-control-sm" placeholder="ملاحظة/سبب" style="max-width:220px" />
                                                    <button class="btn btn-sm btn-outline-primary" id="partnersAdjAdd">إضافة</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2" id="partnersEditorList"></div>
                                        <div class="mt-2 d-flex gap-2 align-items-center">
                                            <button class="btn btn-sm btn-outline-secondary" id="toggleCarryover" type="button">ترحيل الرصيد لكل شريك</button>
                                            <small class="text-muted">قيَم موجبة/سالبة حسب الرصيد المرحّل السابق</small>
                                        </div>
                                        <div class="mt-2" id="partnersCarryoverList" style="display:none"></div>
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-info" id="toggleAdjustments" type="button">سحوبات الفترة السابقة/الحالية</button>
                                        </div>
                                        <div class="mt-2" id="partnersAdjustmentsList" style="display:none"></div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-auto">
                                    <label class="form-label mb-1">المدة</label>
                                    <select id="partnersPeriod" class="form-select form-select-sm" style="min-width:160px;">
                                        <option value="from_start">من البداية</option>
                                        <option value="day">خلال يوم</option>
                                        <option value="week">خلال أسبوع</option>
                                        <option value="month">خلال شهر</option>
                                        <option value="this_month" selected>خلال هذا الشهر</option>
                                        <option value="prev_month">خلال الشهر السابق</option>
                                        <option value="custom">مدى مخصص</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-auto" id="partnersCustomRange" style="display:none;">
                                    <label class="form-label mb-1 d-block">نطاق التاريخ</label>
                                    <div class="d-flex gap-2">
                                        <input type="date" id="partnersFromDate" class="form-control form-control-sm" />
                                        <input type="date" id="partnersToDate" class="form-control form-control-sm" />
                                        <button class="btn btn-sm btn-primary" id="applyPartnersRange" type="button">تطبيق</button>
                                    </div>
                                </div>
                                <div class="col-12 col-md-auto ms-auto d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success" id="exportPartnersExcel"><i class="fas fa-file-excel me-1"></i>Excel</button>
                                    <button class="btn btn-sm btn-outline-secondary" id="exportPartnersTxt"><i class="fas fa-file-alt me-1"></i>مستند</button>
                                    <!-- زر تصدير PDF مخفي حالياً - يمكن تفعيله لاحقاً عند تطوير ميزة تصدير PDF الحقيقية
                                    <button class="btn btn-sm btn-outline-danger" id="exportPartnersPdf"><i class="fas fa-file-pdf me-1"></i>PDF</button>
                                    -->
                                    <button class="btn btn-sm btn-outline-primary" id="openPartnersReport"><i class="fas fa-file-alt me-1"></i>فتح التقرير</button>
                                </div>
                            </div>
                            <div id="partnerReportsContainer">
                                <!-- سيتم ملؤه بالبيانات -->
                            </div>
                        </div>
                    </div>
                    


                    <!-- تم أرشفة التقارير التفصيلية -->
                    </div>
                </div>
            </div>
            <!-- قسم المحذوفات -->
            <div id="trash" class="section" style="display:none;">
                <div class="section-content">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="section-title mb-0">سلة المحذوفات</h4>
                        <button class="btn btn-danger btn-sm" onclick="if(typeof emptyTrash === 'function') emptyTrash()">
                            <i class="fas fa-trash-alt"></i> تفريغ السلة
                        </button>
                    </div>
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-12 col-md-auto d-flex gap-2 align-items-center">
                            <label for="trashFilterSection" class="mb-0">القسم:</label>
                            <select id="trashFilterSection" class="form-select form-select-sm" style="width:auto; min-width: 160px;">
                                <option value="all" selected>الكل</option>
                                <option value="expenses">المصروفات</option>
                                <option value="payments">التسديدات</option>
                                <option value="sales">المبيعات</option>
                                <option value="inventory">الكميات</option>
                                <option value="packages">الباقات</option>
                                <option value="stores">المحلات</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-auto d-flex gap-2 align-items-center">
                            <label for="trashSortBy" class="mb-0">ترتيب حسب:</label>
                            <select id="trashSortBy" class="form-select form-select-sm" style="width:auto; min-width: 160px;">
                                <option value="deletedAt_desc" selected>تاريخ الحذف (الأحدث)</option>
                                <option value="deletedAt_asc">تاريخ الحذف (الأقدم)</option>
                                <option value="section_asc">اسم القسم (تصاعدي)</option>
                                <option value="section_desc">اسم القسم (تنازلي)</option>
                            </select>
                        </div>
                        <div class="col-12 col-md">
                            <input id="trashSearch" class="form-control form-control-sm" placeholder="بحث..." />
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead><tr><th>القسم</th><th>تفاصيل</th><th>تاريخ الحذف</th><th>إجراءات</th></tr></thead>
                            <tbody id="trashTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- قسم الاستيراد والتصدير -->
            <div id="importExport" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">الاستيراد والتصدير</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    تصدير البيانات
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">اختر نوع البيانات للتصدير</label>
                                        <select id="exportDataType" class="form-select">
                                            <option value="all">جميع البيانات</option>
                                            <option value="packages">الباقات والأسعار</option>
                                            <option value="inventory">كمية الكروت</option>
                                            <option value="stores">البقالات والمحلات</option>
                                            <option value="expenses">المصروفات</option>
                                            <option value="reports">التقارير</option>
                                            <option value="sales">المبيعات</option>
                                            <option value="payments">التسديدات</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">اختر صيغة التصدير</label>
                                        <select id="exportFormat" class="form-select">
                                            <option value="json">JSON (للاستيراد لاحقاً)</option>
                                            <option value="excel">Excel</option>
                                            <option value="txt">TXT</option>
                                        </select>
                                    </div>
                                    
                                    <button id="exportDataBtn" class="btn btn-success w-100">
                                        <i class="fas fa-download me-2"></i>تصدير البيانات
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    استيراد البيانات
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">اختر ملف البيانات (JSON)</label>
                                        <input id="importFile" type="file" class="form-control">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">نوع البيانات المستوردة</label>
                                        <select id="importDataType" class="form-select">
                                            <option value="all">جميع البيانات</option>
                                            <option value="packages">الباقات والأسعار</option>
                                            <option value="inventory">كمية الكروت</option>
                                            <option value="stores">البقالات والمحلات</option>
                                            <option value="expenses">المصروفات</option>
                                            <option value="sales">المبيعات</option>
                                            <option value="payments">التسديدات</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="replaceData">
                                        <label class="form-check-label" for="replaceData">
                                            استبدال البيانات الحالية
                                        </label>
                                    </div>
                                    
                                    <button id="importDataBtn" class="btn btn-primary w-100">
                                        <i class="fas fa-upload me-2"></i>استيراد البيانات
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم الإعدادات -->
            <div id="settings" class="section" style="display:none;">
                <div class="header-bar">
                    <h3 class="page-title"><i class="fas fa-cog"></i> الإعدادات</h3>
                    <div>
                        <button class="btn btn-success btn-sm" onclick="AppSettings.save(true)">
                            <i class="fas fa-save"></i> حفظ التغييرات
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="AppSettings.undo()">
                            <i class="fas fa-undo"></i> تراجع
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="if(confirm('هل أنت متأكد من إعادة تعيين جميع الإعدادات؟')) AppSettings.reset()">
                            <i class="fas fa-redo"></i> إعادة تعيين
                        </button>
                    </div>
                </div>

                <div class="row">
                    <!-- القائمة الجانبية للإعدادات -->
                    <div class="col-md-3">
                        <div class="list-group" id="settingsTabs">
                            <a href="#" class="list-group-item list-group-item-action active" data-tab="display">
                                <i class="fas fa-palette"></i> العرض والمظهر
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-tab="financial">
                                <i class="fas fa-money-bill"></i> المالية والعملة
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-tab="notifications">
                                <i class="fas fa-bell"></i> التنبيهات
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-tab="backup">
                                <i class="fas fa-cloud-upload-alt"></i> النسخ الاحتياطي
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-tab="security">
                                <i class="fas fa-shield-alt"></i> الأمان
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-tab="reports">
                                <i class="fas fa-file-alt"></i> التقارير والطباعة
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-tab="performance">
                                <i class="fas fa-tachometer-alt"></i> الأداء
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-tab="sync">
                                <i class="fab fa-github"></i> المزامنة
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-tab="flags">
                                <i class="fas fa-flask"></i> الميزات التجريبية
                            </a>
                        </div>
                    </div>

                    <!-- محتوى الإعدادات -->
                    <div class="col-md-9">
                        <div class="section-content" id="settingsContent">
                            <!-- سيتم إضافة محتوى التبويبات هنا -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم حول التطبيق -->
            <div id="about" class="section" style="display:none;"></div>

        </div>
    </div>
    <!-- Modal لإضافة باقة جديدة -->
    <div class="modal fade" id="packageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="packageModalTitle">إضافة باقة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="packageForm">
                        <input type="hidden" id="packageId">
                        <div class="mb-3">
                            <label class="form-label">اسم الباقة *</label>
                            <input type="text" id="packageName" class="form-control" placeholder="أدخل اسم الباقة" required>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">سعر التجزئة (ر.ي)</label>
                                <input type="text" id="retailPrice" class="form-control formatted-input" placeholder="أدخل السعر">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">سعر الجملة (ر.ي)</label>
                                <input type="text" id="wholesalePrice" class="form-control formatted-input" placeholder="أدخل السعر">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">سعر الموزعين (ر.ي)</label>
                                <input type="text" id="distributorPrice" class="form-control formatted-input" placeholder="أدخل السعر">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ الإضافة</label>
                            <input type="date" id="packageDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="savePackageBtn">حفظ الباقة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة كمية جديدة -->
    <div class="modal fade" id="inventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inventoryModalTitle">إضافة كمية جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="inventoryForm">
                        <input type="hidden" id="inventoryId">
                        <div class="mb-3">
                            <label class="form-label">اختر الباقة *</label>
                            <select id="inventoryPackage" class="form-select" required>
                                <!-- سيتم ملؤه بالبيانات -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الكمية *</label>
                            <input type="text" id="inventoryQuantity" class="form-control formatted-input" placeholder="أدخل الكمية" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ الإضافة</label>
                            <input type="date" id="inventoryDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveInventoryBtn">حفظ الكمية</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة محل جديد -->
    <div class="modal fade" id="storeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="storeModalTitle">إضافة محل جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="storeForm">
                        <input type="hidden" id="storeId">
                        <div class="mb-3">
                            <label class="form-label">اسم المحل *</label>
                            <input type="text" id="storeName" class="form-control" placeholder="أدخل اسم المحل" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">نوع السعر *</label>
                            <select id="storePriceType" class="form-select" required>
                                <option value="retail">سعر التجزئة</option>
                                <option value="wholesale">سعر الجملة</option>
                                <option value="distributor">سعر الموزعين</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">رقم الهاتف</label>
                            <div class="input-group">
                                <input type="tel" id="storePhone" class="form-control" placeholder="مثال: 0771234567" dir="ltr">
                                <button type="button" class="btn btn-outline-secondary" id="selectContactBtn" title="اختر من جهات الاتصال">
                                    <i class="fas fa-address-book"></i>
                                </button>
                            </div>
                            <small class="text-muted">يمكنك الكتابة مباشرة أو الاختيار من جهات الاتصال</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ الإضافة</label>
                            <input type="date" id="storeDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveStoreBtn">حفظ المحل</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة مصروف جديد -->
    <div class="modal fade" id="expenseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expenseModalTitle">إضافة مصروف جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <input type="hidden" id="expenseId">
                        <div class="mb-3">
                            <label class="form-label">نوع المصروف *</label>
                            <div class="expense-type-picker">
                                <div class="chips" id="expenseTypeChips"></div>
                                <div class="mt-2 d-flex gap-2 align-items-center">
                                    <input type="text" id="expenseTypeCustom" class="form-control" placeholder="نوع مصروف مخصص">
                                    <button type="button" class="btn btn-outline-primary" id="addCustomExpenseType">إضافة</button>
                                </div>
                                <input type="hidden" id="expenseType" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">المبلغ (ر.ي)</label>
                            <input type="text" id="expenseAmount" class="form-control formatted-input" placeholder="أدخل المبلغ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ملاحظات (اختياري)</label>
                            <textarea id="expenseNotes" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ المصروف</label>
                            <input type="date" id="expenseDate" class="form-control">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="addLater">
                            <label class="form-check-label" for="addLater">
                                إضافة المبلغ لاحقًا
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveExpenseBtn">حفظ المصروف</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة بيع -->
    <div class="modal fade" id="saleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saleModalTitle">إضافة بيع</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="saleForm">
                        <input type="hidden" id="saleId">
                        <input type="hidden" id="saleStoreId">
                        <div class="mb-3">
                            <label class="form-label">اختر الباقة</label>
                            <select id="salePackage" class="form-select">
                                <option value="">اختر الباقة</option>
                                <option value="custom">مخصص (مبلغ مباشر)</option>
                                <!-- سيتم ملؤه بالبيانات -->
                            </select>
                            <div class="form-text text-muted">اختياري - يمكنك إدخال سبب مخصص بدلاً من ذلك</div>
                        </div>
                        <div class="mb-3" id="customReasonGroup" style="display:none;">
                            <label class="form-label">السبب المخصص *</label>
                            <input type="text" id="saleReason" class="form-control" placeholder="أدخل السبب (مثال: دين سابق، فاتورة سابقة)">
                        </div>
                        <div class="mb-3" id="quantityGroup">
                            <label class="form-label">الكمية *</label>
                            <input type="text" id="saleQuantity" class="form-control formatted-input" placeholder="أدخل الكمية">
                        </div>
                        <div class="mb-3" id="amountGroup" style="display:none;">
                            <label class="form-label">المبلغ (ر.ي) *</label>
                            <input type="text" id="saleAmount" class="form-control formatted-input" placeholder="أدخل المبلغ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ البيع</label>
                            <input type="date" id="saleDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveSaleBtn">حفظ البيع</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة تسديد -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">إضافة تسديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId">
                        <input type="hidden" id="paymentStoreId">
                        <div class="mb-3">
                            <label class="form-label">المبلغ (ر.ي) *</label>
                            <input type="text" id="paymentAmount" class="form-control formatted-input" placeholder="أدخل المبلغ" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ملاحظات (اختياري)</label>
                            <textarea id="paymentNotes" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ التسديد</label>
                            <input type="date" id="paymentDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="savePaymentBtn">حفظ التسديد</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal مزامنة جيت هب -->
    <div class="modal fade" id="githubSyncModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">مزامنة البيانات مع جيت هب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-0">
                        تم إخفاء إعدادات مزامنة GitHub في هذه النسخة. استخدم إدارة النسخ الاحتياطية بدلًا من ذلك.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                                        <button type="button" class="btn btn-outline-primary d-none" id="githubDownloadBtn">
                        <i class="fas fa-download me-1"></i> تحميل من جيت هب
                    </button>
                    <button type="button" class="btn btn-outline-success d-none" id="githubUploadBtn">
                        <i class="fas fa-upload me-1"></i> رفع إلى جيت هب
                    </button>
                    <button type="button" class="btn btn-primary d-none" id="githubCreateGistBtn">
                        <i class="fas fa-plus me-1"></i> إنشاء Gist جديد
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#backupManagerModal">
                        <i class="fas fa-database me-1"></i> إدارة النسخ الاحتياطية
                    </button>
                    <button type="button" class="btn btn-dark d-none" id="githubSaveSettingsBtn">
                        <i class="fas fa-save me-1"></i> حفظ الإعدادات
                    </button>
                    <div class="w-100 d-flex align-items-center justify-content-between mt-2">
                        <button type="button" class="btn btn-outline-secondary" id="localBackupSetupBtn">
                            <i class="fas fa-file-export me-1"></i> تفعيل النسخ المحلي التلقائي
                        </button>
                        <span id="localBackupStatus" class="text-muted small">غير مفعل</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal اختيار المحل للاختصارات -->
    <div class="modal fade" id="selectStoreModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectStoreModalTitle">اختر المحل</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">المحل/البقالة</label>
                    <select id="selectStoreSelect" class="form-select">
                        <!-- سيتم ملؤه بالبيانات -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="confirmSelectStoreBtn">متابعة</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // تهيئة التواريخ باللغة العربية
        moment.locale('ar');
        const today = moment().format('YYYY-MM-DD');
        document.getElementById('currentDate').textContent = toEnglishDigits(moment().format('YYYY-MM-DD'));
        document.getElementById('currentMonth').textContent = toEnglishDigits(moment().format('MMMM'));
        
        // هياكل البيانات الأساسية
        let data = {
            packages: [],
            inventory: [],
            stores: [],
            expenses: [],
            sales: [],
            payments: [],
            trash: []
        };
        
        // جعل البيانات متاحة عالمياً
        window.data = data;
        
        // تحويل أي أرقام عربية/فارسية إلى إنجليزية
        function toEnglishDigits(input) {
            if (input === null || input === undefined) return '';
            return String(input).replace(/[\u0660-\u0669]/g, d => String(d.charCodeAt(0) - 0x0660))
                                .replace(/[\u06F0-\u06F9]/g, d => String(d.charCodeAt(0) - 0x06F0));
        }
        
        // تنسيق الأرقام بفواصل كل ثلاثة أرقام وإرجاع أرقام إنجليزية
        function formatNumber(num) {
            if (num === null || num === undefined) return '';
            const n = Number(num) || 0;
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // تحويل الأرقام المنسقة إلى أرقام صحيحة (مع دعم الأرقام العربية)
        function parseFormattedNumber(str) {
            if (!str) return 0;
            const eng = toEnglishDigits(str);
            return parseFloat(eng.replace(/,/g, '')) || 0;
        }
        
        // تطبيق تنسيق الأرقام على جميع حقول الإدخال
        function setupFormattedInputs() {
            document.querySelectorAll('.formatted-input').forEach(input => {
                // عند التركيز على الحقل، إزالة التنسيق
                input.addEventListener('focus', function() {
                    this.value = toEnglishDigits(this.value).replace(/[^0-9.]/g, '');
                });
                
                // عند الإدخال، تطبيق التنسيق مع الحفاظ على موضع المؤشر
                input.addEventListener('input', function() {
                    const original = this.value;
                    const caret = this.selectionStart || 0;
                    // حوّل إلى أرقام إنجليزية وأزل أي محارف غير رقمية باستثناء النقطة
                    let plain = toEnglishDigits(original);
                    const isNegative = /^-/.test(plain);
                    plain = plain.replace(/[^0-9.]/g, '');
                    // لا تسمح بأكثر من نقطة عشرية
                    const parts = plain.split('.');
                    if (parts.length > 2) {
                        plain = parts[0] + '.' + parts.slice(1).join('');
                    }
                    // احسب عدد الأرقام قبل المؤشر القديم
                    const leftText = toEnglishDigits(original.slice(0, caret));
                    const leftDigitsCount = (leftText.match(/[0-9]/g) || []).length;
                    // شكل الرقم مع الفواصل
                    let numberPart = parts[0];
                    // إزالة الأصفار الزائدة في البداية (مع الحفاظ على صفر واحد)
                    numberPart = numberPart.replace(/^0+(\d)/, '$1');
                    const formattedInt = numberPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    const decimalPart = parts.length > 1 ? ('.' + parts[1]) : '';
                    let formatted = (isNegative ? '-' : '') + formattedInt + decimalPart;
                    // حدّث القيمة فقط إذا تغيّرت لتقليل وميض المؤشر
                    if (formatted !== this.value) this.value = formatted;
                    // أعد موضع المؤشر بناءً على عدد الأرقام اليسرى
                    let newCaret = 0, seenDigits = 0;
                    const val = this.value;
                    for (let i = 0; i < val.length; i++) {
                        if (/[0-9]/.test(val[i])) {
                            seenDigits++;
                            if (seenDigits >= leftDigitsCount) { newCaret = i + 1; break; }
                        } else if (val[i] === '.' && leftText.includes('.')) {
                            // إذا كان المؤشر القديم بعد النقطة، احترم ذلك
                            const leftDotIndex = leftText.indexOf('.');
                            const digitsBeforeDot = (leftText.slice(0, leftDotIndex).match(/[0-9]/g) || []).length;
                            if (leftDigitsCount === digitsBeforeDot) { newCaret = i + 1; break; }
                        }
                    }
                    // إن لم نجد موضعاً مناسباً، ضع المؤشر في نهاية النص
                    if (!newCaret) newCaret = this.value.length;
                    this.setSelectionRange(newCaret, newCaret);
                });
                
                // عند الخروج من الحقل، تطبيق التنسيق النهائي
                input.addEventListener('blur', function() {
                    const num = parseFormattedNumber(this.value);
                    this.value = num ? formatNumber(num) : '';
                });
            });
        }
        
        // إدارة المخزون
        function getTotalInventoryForPackage(packageId) {
            return data.inventory
                .filter(item => item.packageId === packageId)
                .reduce((sum, item) => sum + (item.quantity || 0), 0);
        }
        
        function deductFromInventory(packageId, quantity) {
            // تحقق أولاً من توفر الكمية
            const totalAvailable = getTotalInventoryForPackage(packageId);
            if (totalAvailable < quantity) {
                return false;
            }
            let remaining = quantity;
            for (const item of data.inventory) {
                if (item.packageId !== packageId) continue;
                const available = item.quantity || 0;
                if (available <= 0) continue;
                const toDeduct = Math.min(available, remaining);
                item.quantity = available - toDeduct;
                remaining -= toDeduct;
                if (remaining === 0) break;
            }
            return true;
        }
        
        function addToInventory(packageId, quantity) {
            const existing = data.inventory.find(i => i.packageId === packageId);
            if (existing) {
                existing.quantity = (existing.quantity || 0) + quantity;
            } else {
                data.inventory.push({ id: 'inv_' + Date.now(), packageId, quantity, createdAt: today });
            }
        }
        
        function checkLowStockForPackage(packageId) {
            const total = getTotalInventoryForPackage(packageId);
            if (total < 200) {
                const pkg = data.packages.find(p => p.id === packageId);
                const name = pkg ? pkg.name : packageId;
                showNotification(`تحذير: مخزون الباقة "${name}" أقل من 200 كرت`, 'error');
            }
        }
        
        // استرجاع البيانات من localStorage إن وجدت
        function loadData() {
            try {
                // محاولة تحميل البيانات المشفرة أولاً
                let parsedData = null;
                
                if (window.DataEncryption && window.DataEncryption.loadEncrypted) {
                    // محاولة تحميل البيانات المشفرة
                    parsedData = window.DataEncryption.loadEncrypted('networkCardsData');
                }
                
                // إذا فشل التحميل المشفر، حاول التحميل العادي
                if (!parsedData) {
                    const savedData = localStorage.getItem('networkCardsData');
                    if (savedData) {
                        try {
                            // التحقق من وجود توقيع (بيانات مشفرة)
                            const testParse = JSON.parse(savedData);
                            if (testParse.signature && testParse.data) {
                                // بيانات مشفرة لكن فشل فك التشفير
                                console.warn('البيانات مشفرة لكن فشل فك التشفير');
                                parsedData = testParse.data; // استخدم البيانات المشفرة كما هي
                            } else {
                                // بيانات غير مشفرة
                                parsedData = testParse;
                            }
                        } catch (e) {
                            console.error('خطأ في تحليل البيانات:', e);
                        }
                    }
                }
                
                if (parsedData) {
                    // التحقق من صحة البيانات
                    if (typeof parsedData === 'object' && parsedData !== null) {
                        // التأكد من وجود جميع الخصائص المطلوبة
                        data = {
                            packages: Array.isArray(parsedData.packages) ? parsedData.packages : [],
                            inventory: Array.isArray(parsedData.inventory) ? parsedData.inventory : [],
                            stores: Array.isArray(parsedData.stores) ? parsedData.stores : [],
                            expenses: Array.isArray(parsedData.expenses) ? parsedData.expenses : [],
                            sales: Array.isArray(parsedData.sales) ? parsedData.sales : [],
                            payments: Array.isArray(parsedData.payments) ? parsedData.payments : [],
                            trash: Array.isArray(parsedData.trash) ? parsedData.trash : []
                        };
                        // تحديث البيانات العامة
                        window.data = data;
                        showNotification('تم تحميل البيانات بنجاح', 'success');
                    } else {
                        throw new Error('تنسيق البيانات غير صحيح');
                    }
                } else {
                    // إذا لم توجد بيانات محفوظة، استخدم البيانات الافتراضية
                    window.data = data;
                    showNotification('لا توجد بيانات محفوظة، سيتم استخدام بيانات جديدة', 'info');
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showNotification('حدث خطأ في تحميل البيانات، سيتم استخدام بيانات جديدة', 'error');
                // إعادة تعيين البيانات إلى القيم الافتراضية
                data = {
                    packages: [],
                    inventory: [],
                    stores: [],
                    expenses: [],
                    sales: [],
                    payments: [],
                    trash: []
                };
                window.data = data;
            }
            
            // تحديث جميع الواجهات
            updateDashboard();
            renderPackagesTable();
            renderInventoryTable();
            renderStoresList();
            renderExpensesTable();
            updateReportStores();
            updateProfitReport();
            generateDebtReport();
        }
        
        // حفظ البيانات إلى localStorage
        function saveData() {
            try {
                // استخدام window.data مباشرة للتأكد من حفظ البيانات الصحيحة
                const dataToSave = window.data || data;
                
                // التحقق من صحة البيانات قبل الحفظ
                if (!dataToSave || typeof dataToSave !== 'object') {
                    throw new Error('البيانات غير صحيحة');
                }
                
                // التأكد من وجود جميع الخصائص المطلوبة
                const validData = {
                    packages: Array.isArray(dataToSave.packages) ? dataToSave.packages : [],
                    inventory: Array.isArray(dataToSave.inventory) ? dataToSave.inventory : [],
                    stores: Array.isArray(dataToSave.stores) ? dataToSave.stores : [],
                    expenses: Array.isArray(dataToSave.expenses) ? dataToSave.expenses : [],
                    sales: Array.isArray(dataToSave.sales) ? dataToSave.sales : [],
                    payments: Array.isArray(dataToSave.payments) ? dataToSave.payments : [],
                    trash: Array.isArray(dataToSave.trash) ? dataToSave.trash : []
                };
                
                // تحديث الكائن الأصلي بالبيانات الصحيحة
                data = validData;
                window.data = validData;
                
                // حفظ البيانات بالتشفير إذا كان متاحاً
                let saved = false;
                if (window.DataEncryption && window.DataEncryption.saveEncrypted) {
                    saved = window.DataEncryption.saveEncrypted('networkCardsData', validData);
                }
                
                // إذا فشل التشفير، احفظ بالطريقة العادية
                if (!saved) {
                    localStorage.setItem('networkCardsData', JSON.stringify(validData));
                }
                
                showNotification('تم حفظ البيانات بنجاح', 'success');
                
                // المزامنة مع GitHub إذا كانت مفعلة
                if (typeof githubSettings !== 'undefined' && githubSettings && githubSettings.autoSync && githubSettings.token && githubSettings.gistId) {
                    githubUploadData().catch(() => {});
                }
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                showNotification('حدث خطأ في حفظ البيانات', 'error');
            }
        }
        
        // تحديد فترة لوحة التحكم حسب اختيار المستخدم
        function getDashboardPeriodRange() {
            try {
                if (typeof PeriodManager!=='undefined' && PeriodManager.getDateRange) {
                    const r = PeriodManager.getDateRange();
                    return { from: r.from, to: r.to };
                }
            } catch(_) {}
            // fallback الآمن
            const today = moment().format('YYYY-MM-DD');
            return { from: '0000-01-01', to: today };
        }
        
        // فلترة مصفوفة حسب تاريخ ضمن الفترة
        function filterByDateRange(items, getDate) {
            const { from, to } = getDashboardPeriodRange();
            return (items||[]).filter(item => {
                try{ const d = formatDateEn(getDate(item) || ''); return d && d >= from && d <= to; }catch(_){ return false; }
            });
        }
        
        // تحديث لوحة التحكم
        function updateDashboard() {
            // تحديث الإحصائيات الثابتة
            document.getElementById('packagesCount').textContent = data.packages.length;
            document.getElementById('storesCount').textContent = data.stores.length;
            
            // إجمالي الكروت لا يعتمد على التاريخ
            const totalCards = data.inventory.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('totalCards').textContent = formatNumber(totalCards, false);
            
            // تطبيق الفلاتر الزمنية على مبيعات/تسديدات/مصروفات
            const filteredSales = filterByDateRange(data.sales, s => s.date);
            const filteredPayments = filterByDateRange(data.payments, p => p.date);
            const filteredExpenses = filterByDateRange(data.expenses, e => e.date);
            
            // إجمالي المبيعات
            const totalSales = filteredSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            document.getElementById('totalSales').textContent = formatNumber(totalSales);
            
            // إجمالي التسديدات
            const totalPaymentsSum = filteredPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            document.getElementById('totalPaymentsSum').textContent = formatNumber(totalPaymentsSum);
            
            // إجمالي الديون = مجموع (مبيعات كل محل - تسديداته) ضمن الفترة
            const totalDebtsSum = data.stores.reduce((sum, store) => {
                const storeSales = filteredSales.reduce((s, sale) => s + (sale.storeId === store.id ? (sale.total || 0) : 0), 0);
                const storePayments = filteredPayments.reduce((p, payment) => p + (payment.storeId === store.id ? (payment.amount || 0) : 0), 0);
                return sum + (storeSales - storePayments);
            }, 0);
            document.getElementById('totalDebtsSum').textContent = formatNumber(totalDebtsSum);
            
            // إجمالي المصروفات
            const totalExpensesSum = filteredExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const totalExpensesSumEl = document.getElementById('totalExpensesSum');
            if (totalExpensesSumEl) totalExpensesSumEl.textContent = formatNumber(totalExpensesSum);
            
            // صافي الأرباح = إجمالي التسديدات - إجمالي المصروفات ضمن الفترة
            const netProfit = totalPaymentsSum - totalExpensesSum;
            document.getElementById('netProfit').textContent = formatNumber(netProfit);

            // Sparklines مبسطة (ASCII) حسب التجميع اليومي/الأسبوعي ضمن الفترة
            try {
                const groupSel = document.getElementById('dashboardSparkGroup');
                const groupBy = groupSel ? groupSel.value : 'day';
                const { from, to } = getDashboardPeriodRange();
                // بناء مفاتيح التجميع
                function keyFor(dateStr){
                    const d = formatDateEn(dateStr);
                    if (!d) return '';
                    if (groupBy === 'week') {
                        // YYYY-Www تقريبية: استخدم بداية الأسبوع يوم السبت/الأحد حسب moment locale، هنا نبسط إلى أسبوع ISO تقريباً
                        const m = (typeof moment!=='undefined') ? moment(d) : null;
                        if (m) return m.isoWeekYear() + '-W' + String(m.isoWeek()).padStart(2,'0');
                        const dt = new Date(d); const onejan = new Date(dt.getFullYear(),0,1); const week = Math.ceil((((dt - onejan) / 86400000) + onejan.getDay()+1)/7); return dt.getFullYear()+ '-W' + String(week).padStart(2,'0');
                    }
                    return d;
                }
                function buildSeries(items, getDate, getAmount){
                    const seriesMap = new Map();
                    (items||[]).forEach(it=>{
                        const k = keyFor(getDate(it));
                        if (!k) return;
                        let v = seriesMap.get(k)||0; v += (getAmount(it)||0); seriesMap.set(k, v);
                    });
                    // ترتيب حسب المفتاح
                    const entries = Array.from(seriesMap.entries()).sort((a,b)=> a[0] < b[0] ? -1 : 1);
                    return entries.map(e=> e[1]);
                }
                const sSales = buildSeries(filteredSales, s=>s.date, s=> s.total||0);
                const sPays  = buildSeries(filteredPayments, p=>p.date, p=> p.amount||0);
                const sExp   = buildSeries(filteredExpenses, e=>e.date, e=> e.amount||0);
                const sDebt  = sSales.map((v,i)=> v - (sPays[i]||0));
                const sNet   = sPays.map((v,i)=> v - (sExp[i]||0));
                function asciiSpark(values){
                    const el = (v)=> '▁▂▃▄▅▆▇█'[v];
                    if (!values || values.length===0) return '';
                    const max = Math.max(...values, 1); const min = Math.min(...values, 0);
                    const range = Math.max(max - min, 1);
                    return values.map(x=> { const norm = Math.round(((x - min)/range)*7); return el(Math.min(7, Math.max(0, norm))); }).join('');
                }
                const mapIdToSeries = {
                    spark_sales: sSales,
                    spark_payments: sPays,
                    spark_expenses: sExp,
                    spark_debts: sDebt,
                    spark_net: sNet
                };
                Object.keys(mapIdToSeries).forEach(id=>{
                    const el = document.getElementById(id);
                    if (el) el.textContent = asciiSpark(mapIdToSeries[id]);
                });
            } catch(_) { /* تجاهل رسومات المصغرات عند الخطأ */ }
            
            // تحديث أحدث الباقات (غير مستخدم إذا لم توجد العناصر)
            const recentPackages = document.getElementById('recentPackages');
            if (recentPackages) {
                // استخدام DocumentFragment لتحسين الأداء
                if (window.$dom && window.$dom.schedule) {
                    window.$dom.schedule(() => {
                        const fragment = document.createDocumentFragment();
                        const packagesToShow = data.packages.slice(-3).reverse();
                        packagesToShow.forEach(pkg => {
                            const row = window.$safe && window.$safe.row ? 
                                window.$safe.row([
                                    pkg.name,
                                    {text: pkg.retailPrice ? formatNumber(pkg.retailPrice) : '-', className: 'currency'},
                                    {text: pkg.wholesalePrice ? formatNumber(pkg.wholesalePrice) : '-', className: 'currency'},
                                    {text: pkg.distributorPrice ? formatNumber(pkg.distributorPrice) : '-', className: 'currency'},
                                    formatNumber(data.inventory.filter(i => i.packageId === pkg.id).reduce((sum, i) => sum + i.quantity, 0))
                                ]) : null;
                            if (row) fragment.appendChild(row);
                        });
                        recentPackages.innerHTML = '';
                        recentPackages.appendChild(fragment);
                    });
                } else {
                    // الطريقة التقليدية مع تحسينات
                    const fragment = document.createDocumentFragment();
                    const packagesToShow = data.packages.slice(-3).reverse();
                    packagesToShow.forEach(pkg => {
                        const row = document.createElement('tr');
                        const cells = [
                            pkg.name,
                            pkg.retailPrice ? formatNumber(pkg.retailPrice) : '-',
                            pkg.wholesalePrice ? formatNumber(pkg.wholesalePrice) : '-',
                            pkg.distributorPrice ? formatNumber(pkg.distributorPrice) : '-',
                            formatNumber(data.inventory.filter(i => i.packageId === pkg.id).reduce((sum, i) => sum + i.quantity, 0))
                        ];
                        cells.forEach((content, index) => {
                            const td = document.createElement('td');
                            td.textContent = content;
                            if (index >= 1 && index <= 3) td.className = 'currency';
                            row.appendChild(td);
                        });
                        fragment.appendChild(row);
                    });
                    recentPackages.innerHTML = '';
                    recentPackages.appendChild(fragment);
                }
            }
            
            // تحديث أحدث المحلات (غير مستخدم إذا لم توجد العناصر)
            const recentStores = document.getElementById('recentStores');
            if (recentStores) {
                recentStores.innerHTML = '';
                const storesToShow = data.stores.slice(-3).reverse();
                storesToShow.forEach(store => {
                    const card = document.createElement('div');
                    card.className = 'store-card';
                    card.innerHTML = `
                        <div class="store-name">${store.name}</div>
                        <div class="store-balance">نوع السعر: ${getPriceTypeName(store.priceType)}</div>
                    `;
                    recentStores.appendChild(card);
                });
            }
        }
        
        // الحصول على اسم نوع السعر
        function getPriceTypeName(priceType) {
            switch(priceType) {
                case 'retail': return 'تجزئة';
                case 'wholesale': return 'جملة';
                case 'distributor': return 'موزعين';
                default: return 'غير معروف';
            }
        }
        
        // تحديث تقرير الأرباح
        function updateProfitReport() {
            const filteredSales = filterByDateRange(data.sales, s => s.date);
            const totalSales = filteredSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalSalesEl = document.getElementById('totalSalesReport');
            if (totalSalesEl) totalSalesEl.textContent = formatNumber(totalSales);
            
            const filteredExpenses = filterByDateRange(data.expenses, e => e.date);
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const totalExpensesEl = document.getElementById('totalExpensesReport');
            if (totalExpensesEl) totalExpensesEl.textContent = formatNumber(totalExpenses);
            
            const filteredPayments = filterByDateRange(data.payments, p => p.date);
            const totalPaymentsSum = filteredPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            const netProfit = totalPaymentsSum - totalExpenses;
            const netProfitElement = document.getElementById('netProfitReport');
            if (netProfitElement) {
                netProfitElement.textContent = formatNumber(netProfit);
                netProfitElement.className = netProfit >= 0 ? 'currency profit-positive' : 'currency profit-negative';
            }
        }
        // توليد تقارير الشركاء
        function generatePartnerReports() {
            const container = document.getElementById('partnerReportsContainer');
            container.innerHTML = '';
            
            // تاريخ التقرير
            const _rng = (typeof getPeriodRange==='function') ? getPeriodRange() : { fromDate: moment().startOf('month').format('YYYY-MM-DD'), toDate: moment().format('YYYY-MM-DD') };
            const fromDate = _rng.fromDate; const toDate = _rng.toDate;
            
            // حساب إجمالي المبيعات
            const totalSales = data.sales.reduce((sum, sale) => {
                if (sale.date >= fromDate && sale.date <= toDate) {
                    return sum + sale.total;
                }
                return sum;
            }, 0);
            
            // حساب إجمالي المصروفات
            const totalExpenses = data.expenses.reduce((sum, expense) => {
                if (expense.date >= fromDate && expense.date <= toDate) {
                    return sum + expense.amount;
                }
                return sum;
            }, 0);
            
            // حساب صافي الربح
            const netProfit = totalSales - totalExpenses;
            
            const report = document.createElement('div');
            report.className = 'partner-report-card';
            report.innerHTML = `
                <div class="partner-report-header">
                    <h5 class="partner-report-title">تقرير أداء الشركاء</h5>
                    <div class="partner-report-dates">
                        من ${moment(fromDate).format('D MMMM YYYY')} إلى ${moment(toDate).format('D MMMM YYYY')}
                    </div>
                </div>
                
                <div class="partner-report-summary">
                    <div class="summary-item">
                        <div class="summary-value currency">${formatNumber(totalSales)}</div>
                        <div class="summary-label">إجمالي المبيعات</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value currency">${formatNumber(totalExpenses)}</div>
                        <div class="summary-label">إجمالي المصروفات</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value currency ${netProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${formatNumber(netProfit)}</div>
                        <div class="summary-label">صافي الربح</div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نوع الإيراد/المصروف</th>
                                <th>المبلغ</th>
                                <th>التفاصيل</th>
                                <th>التاريخ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.sales.filter(sale => sale.date >= fromDate && sale.date <= toDate).map(sale => `
                                <tr>
                                    <td>بيع</td>
                                    <td class="currency">${formatNumber(sale.total)}</td>
                                    <td>${sale.reason || (sale.packageId ? 'بيع باقة' : 'بيع مخصص')}</td>
                                    <td>${sale.date}</td>
                                </tr>
                            `).join('')}
                            
                            ${data.expenses.filter(expense => expense.date >= fromDate && expense.date <= toDate).map(expense => `
                                <tr>
                                    <td>مصروف</td>
                                    <td class="currency">${formatNumber(expense.amount)}</td>
                                    <td>${expense.type}</td>
                                    <td>${expense.date}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-success" onclick="exportPartnerReport()">
                        <i class="fas fa-download me-2"></i>تصدير تقرير الشركاء
                    </button>
                </div>
            `;
            
            container.appendChild(report);
        }
        // واجهة إدارة الشركاء داخل بطاقة التقرير
        (function wirePartnersInlineEditor(){
            function getCfg(){ try{ return (typeof AppSettings!=='undefined')? ((AppSettings.getAll().reports||{}).partners||{}):{}; }catch(_){ return {}; } }
            function setCfg(cfg){ try{ AppSettings.update('reports.partners', cfg); } catch(_){} }
            function periodKey(){ try{ const pf = (typeof getPartnersPeriodRange==='function')?getPartnersPeriodRange():{fromDate:'',toDate:''}; return (pf.fromDate||'')+'_'+(pf.toDate||''); }catch(_){ return '_'; } }
            function renderAdjustments(){
                const cfg = getCfg();
                const rng = (typeof getPartnersPeriodRange==='function')?getPartnersPeriodRange():{fromDate:'',toDate:''};
                const listAll = Array.isArray(cfg.adjustmentsAll) ? cfg.adjustmentsAll : [];
                const listed = listAll.map((it,i)=>({ ...it, __i: i }))
                                      .filter(it => (typeof inPeriod==='function') ? inPeriod(it.date, rng.fromDate, rng.toDate) : true);
                const wrap = document.getElementById('partnersAdjustmentsList'); if (!wrap) return;
                const partners = (cfg.list||[]).reduce((m,p)=>{ m[p.id]=p.name||p.id; return m; },{});
                if (!listed.length){ wrap.innerHTML = '<div class="text-muted">لا توجد سحوبات ضمن الفترة الحالية</div>'; return; }
                let html = '<div class="table-responsive"><table class="table table-sm align-middle"><thead><tr><th>الشريك</th><th>المبلغ</th><th>التاريخ</th><th>ملاحظات</th><th>إجراءات</th></tr></thead><tbody>';
                listed.forEach((it,idx)=>{
                    html += '<tr data-key="'+it.__i+'">'
                        + '<td>'+ (partners[it.partnerId]||it.partnerId) +'</td>'
                        + '<td><div class="input-group"><input type="text" class="form-control formatted-input" inputmode="decimal" dir="ltr" value="'+((Number(it.amount)||0))+'" data-role="amount"><span class="input-group-text">ريال</span></div></td>'
                        + '<td><input type="date" class="form-control" value="'+(it.date||'')+'" data-role="date"></td>'
                        + '<td><textarea class="form-control" rows="2" placeholder="ملاحظات" data-role="notes">'+(it.notes||'')+'</textarea></td>'
                        + '<td><button class="btn btn-sm btn-outline-success" data-action="save">حفظ</button> <button class="btn btn-sm btn-outline-danger" data-action="delete">حذف</button></td>'
                        + '</tr>';
                });
                html += '</tbody></table></div>';
                wrap.innerHTML = html;
                if (typeof setupFormattedInputs==='function') setupFormattedInputs();
            }
            function refreshEditors(){
                const cfg = getCfg();
                const countEl = document.getElementById('partnersEditorCount');
                const distEl = document.getElementById('partnersEditorDistribution');
                const listWrap = document.getElementById('partnersEditorList');
                const selAdj = document.getElementById('partnersAdjPartner');
                const carryWrap = document.getElementById('partnersCarryoverList');
                const dateAdj = document.getElementById('partnersAdjDate');
                if (!countEl || !distEl || !listWrap || !selAdj) return;
                const count = parseInt(cfg.count)|| (cfg.list?cfg.list.length:2) || 2;
                countEl.value = count;
                const distribution = cfg.distribution || 'equal';
                distEl.value = distribution;
                const list = Array.isArray(cfg.list)&&cfg.list.length? cfg.list.slice(0, count) : Array.from({length:count}).map((_,i)=>({ id:'p'+(i+1), name:'الشريك '+(i+1), sharePercent:null }));
                cfg.count = count; cfg.list = list; setCfg(cfg);
                // أسماء الشركاء
                listWrap.innerHTML = '';
                const row = document.createElement('div'); row.className = 'row g-2 mt-2';
                list.forEach((p,idx)=>{
                    const col = document.createElement('div'); col.className='col-12 col-md-4';
                    col.innerHTML = '<div class="input-group input-group-sm">\
                        <span class="input-group-text">'+(idx+1)+'</span>\
                        <input type="text" class="form-control" value="'+(p.name||('الشريك '+(idx+1)))+'" data-idx="'+idx+'" data-role="name">\
                        '+(distribution==='percent'?'<input type="number" class="form-control" min="0" max="100" step="1" value="'+(p.sharePercent??'')+'" placeholder="%" data-idx="'+idx+'" data-role="percent">':'')+'\
                    </div>';
                    row.appendChild(col);
                });
                listWrap.appendChild(row);
                // قائمة الشريك في السحب
                selAdj.innerHTML = list.map(p=>'<option value="'+p.id+'">'+(p.name||'')+'</option>').join('');
                if (dateAdj && !dateAdj.value) { try { dateAdj.value = (new Date()).toISOString().slice(0,10); } catch(_){} }
                // قائمة الترحيل
                if (carryWrap) {
                    const carry = cfg.carryover || {};
                    carryWrap.innerHTML = '';
                    const crow = document.createElement('div'); crow.className = 'row g-2';
                    list.forEach((p,idx)=>{
                        const ccol = document.createElement('div'); ccol.className = 'col-12 col-md-4';
                        const val = (typeof carry[p.id] !== 'undefined') ? carry[p.id] : 0;
                        ccol.innerHTML = '<div class="input-group input-group-sm">\
                            <span class="input-group-text">'+(p.name||('الشريك '+(idx+1)))+'</span>\
                            <input type="text" class="form-control formatted-input" step="1" value="'+(val||0)+'" data-pid="'+p.id+'" data-role="carryover" placeholder="0">\
                        </div>';
                        crow.appendChild(ccol);
                    });
                    carryWrap.appendChild(crow);
                }
            }

            document.addEventListener('DOMContentLoaded', function(){
                const card = document.getElementById('partnerReportsCard'); if (!card) return;
                const countEl = document.getElementById('partnersEditorCount');
                const distEl = document.getElementById('partnersEditorDistribution');
                const listWrap = document.getElementById('partnersEditorList');
                const btnAdd = document.getElementById('partnersAdjAdd');
                const selAdj = document.getElementById('partnersAdjPartner');
                const amtAdj = document.getElementById('partnersAdjAmount');
                const dateAdj = document.getElementById('partnersAdjDate');
                const carryWrap = document.getElementById('partnersCarryoverList');
                const toggleCarry = document.getElementById('toggleCarryover');
                const adjWrap = document.getElementById('partnersAdjustmentsList');
                const toggleAdj = document.getElementById('toggleAdjustments');
                if (!countEl) return;
                refreshEditors();
                renderAdjustments();
                countEl.addEventListener('change', function(){
                    const cfg = getCfg(); const v = parseInt(this.value)||1; cfg.count = v; const list = (cfg.list||[]).slice(0,v); while(list.length<v){ list.push({ id:'p'+(list.length+1), name:'الشريك '+(list.length+1), sharePercent:null }); } cfg.list=list; setCfg(cfg); refreshEditors(); generatePartnerReports();
                });
                distEl.addEventListener('change', function(){ const cfg=getCfg(); cfg.distribution=this.value; setCfg(cfg); refreshEditors(); generatePartnerReports(); });
                listWrap.addEventListener('change', function(e){ const t=e.target; const role=t && t.getAttribute('data-role'); if(!role) return; const idx=parseInt(t.getAttribute('data-idx')); const cfg=getCfg(); if(!cfg.list||!cfg.list[idx]) return; if(role==='name'){ cfg.list[idx].name = t.value; } else if (role==='percent'){ cfg.list[idx].sharePercent = t.value?parseFloat(t.value):null; } setCfg(cfg); generatePartnerReports(); });
                if (btnAdd) btnAdd.addEventListener('click', function(){ const cfg=getCfg(); const notesEl=document.getElementById('partnersAdjNotes'); const pk=periodKey(); const list=(cfg.adjustments&&cfg.adjustments[pk])?cfg.adjustments[pk]:[]; const pid=selAdj.value; const amount=parseFormattedNumber(amtAdj.value)||0; const date=dateAdj.value; const notes=notesEl?notesEl.value:''; if (pid && amount>0){ list.push({ partnerId: pid, amount: amount, date: date, notes: notes }); cfg.adjustments = cfg.adjustments||{}; cfg.adjustments[pk]=list; // also flat list
                    const flat = Array.isArray(cfg.adjustmentsAll)?cfg.adjustmentsAll:[]; flat.push({ partnerId: pid, amount: amount, date: date, notes: notes }); cfg.adjustmentsAll = flat; setCfg(cfg); amtAdj.value=''; if (notesEl) notesEl.value=''; if (typeof showNotification==='function') showNotification('تم إضافة سحب الشريك', 'success'); generatePartnerReports(); renderAdjustments(); } });
                if (carryWrap) carryWrap.addEventListener('change', function(e){ const t=e.target; if(!t || t.getAttribute('data-role')!=='carryover') return; const pid=t.getAttribute('data-pid'); const cfg=getCfg(); cfg.carryover = cfg.carryover || {}; cfg.carryover[pid] = t.value?parseFormattedNumber(t.value):0; setCfg(cfg); if (typeof showNotification==='function') showNotification('تم تحديث الترحيل', 'info'); generatePartnerReports(); });
                if (toggleCarry) toggleCarry.addEventListener('click', function(){ const wrap = document.getElementById('partnersCarryoverList'); if (!wrap) return; wrap.style.display = (wrap.style.display==='none' || wrap.style.display==='') ? 'block' : 'none'; });
                if (toggleAdj) toggleAdj.addEventListener('click', function(){ if (!adjWrap) return; adjWrap.style.display = (adjWrap.style.display==='none' || adjWrap.style.display==='') ? 'block' : 'none'; });
                if (adjWrap) adjWrap.addEventListener('click', function(e){ const btn = e.target.closest('button'); if (!btn) return; const tr = btn.closest('tr'); if (!tr) return; const key = parseInt(tr.getAttribute('data-key')); const cfg = getCfg(); const listAll = Array.isArray(cfg.adjustmentsAll)?cfg.adjustmentsAll:[]; if (isNaN(key) || key<0 || key>=listAll.length) return; if (btn.getAttribute('data-action')==='delete') { listAll.splice(key,1); cfg.adjustmentsAll = listAll; setCfg(cfg); renderAdjustments(); generatePartnerReports(); return; } if (btn.getAttribute('data-action')==='save') { const amt = tr.querySelector('[data-role="amount"]'); const dt = tr.querySelector('[data-role="date"]'); const nt = tr.querySelector('[data-role="notes"]'); const updated = Object.assign({}, listAll[key]); updated.amount = amt && amt.value ? parseFormattedNumber(amt.value)||0 : 0; updated.date = dt ? dt.value : updated.date; updated.notes = nt ? nt.value : updated.notes; listAll[key] = updated; cfg.adjustmentsAll = listAll; setCfg(cfg); if (typeof showNotification==='function') showNotification('تم حفظ السحب', 'success'); generatePartnerReports(); renderAdjustments(); return; } });
                // تحسين تجربة الجوال لحقول جدول السحوبات
                const style = document.createElement('style');
                style.textContent = `
                #partnersAdjustmentsList .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
                #partnersAdjustmentsList table { min-width: 720px; }
                #partnersAdjustmentsList input.form-control { font-size:16px; height:44px; }
                #partnersAdjustmentsList textarea.form-control { font-size:16px; min-height:56px; max-height:120px; overflow:auto; resize:vertical; }
                @media (max-width: 480px) {
                  #partnersAdjustmentsList table { min-width: 640px; }
                }`;
                document.head.appendChild(style);
                // تلميح بصيغة منسقة للأرقام في المدخلات
                const amtInput = document.getElementById('partnersAdjAmount'); if (amtInput) amtInput.addEventListener('input', function(){ this.title = (typeof formatNumber==='function') ? formatNumber(parseFloat(this.value)||0) : this.title; });
                if (carryWrap) carryWrap.addEventListener('input', function(e){ const t=e.target; if (t && t.getAttribute('data-role')==='carryover'){ t.title = (typeof formatNumber==='function') ? formatNumber(parseFloat(t.value)||0) : t.title; }});
                document.addEventListener('partners-report-rendered', function(){ try{ refreshEditors(); renderAdjustments(); }catch(_){} });

                // إخفاء/إظهار تسمية العملة عند تحرير المبلغ لتفادي الالتباس
                document.addEventListener('focusin', function(e){
                    const el = e.target;
                    if (!el || el.tagName !== 'INPUT') return;
                    const isAmount = (el.id === 'partnersAdjAmount') || (el.getAttribute('data-role') === 'amount');
                    if (!isAmount) return;
                    const group = el.parentElement && el.parentElement.classList.contains('input-group') ? el.parentElement : null;
                    const lbl = group ? group.querySelector('.input-group-text') : null;
                    if (lbl) lbl.style.display = 'none';
                });
                document.addEventListener('focusout', function(e){
                    const el = e.target;
                    if (!el || el.tagName !== 'INPUT') return;
                    const isAmount = (el.id === 'partnersAdjAmount') || (el.getAttribute('data-role') === 'amount');
                    if (!isAmount) return;
                    const group = el.parentElement && el.parentElement.classList.contains('input-group') ? el.parentElement : null;
                    const lbl = group ? group.querySelector('.input-group-text') : null;
                    if (lbl) lbl.style.display = '';
                });
            });
        })();
        
        // تصدير تقرير الشركاء
        function exportPartnerReport() {
            // تاريخ التقرير
            const _rng = (typeof getPeriodRange==='function') ? getPeriodRange() : { fromDate: moment().startOf('month').format('YYYY-MM-DD'), toDate: moment().format('YYYY-MM-DD') };
            const fromDate = _rng.fromDate; const toDate = _rng.toDate;
            
            // حساب إجمالي المبيعات
            const totalSales = data.sales.reduce((sum, sale) => {
                if (sale.date >= fromDate && sale.date <= toDate) {
                    return sum + sale.total;
                }
                return sum;
            }, 0);
            
            const totalExpenses = data.expenses.reduce((sum, expense) => {
                if (expense.date >= fromDate && expense.date <= toDate) {
                    return sum + expense.amount;
                }
                return sum;
            }, 0);
            
            const netProfit = totalSales - totalExpenses;
            
            // إنشاء بيانات التقرير
            const reportData = {
                fromDate: fromDate,
                toDate: toDate,
                totalSales: totalSales,
                totalExpenses: totalExpenses,
                netProfit: netProfit,
                sales: data.sales.filter(sale => sale.date >= fromDate && sale.date <= toDate),
                expenses: data.expenses.filter(expense => expense.date >= fromDate && expense.date <= toDate)
            };
            
            // اسم الملف مع تاريخ اليوم
            const filename = `تقرير_الشركاء_${moment().format('YYYYMMDD')}.json`;
            
            // إنشاء ملف JSON وتنزيله
            const dataStr = JSON.stringify(reportData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('تم تصدير تقرير الشركاء بنجاح', 'success');
        }
        
        // عرض جدول الباقات
        function renderPackagesTable() {
            const table = document.getElementById('packagesTable');
            table.innerHTML = '';
            
            data.packages.forEach(pkg => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pkg.name}</td>
                    <td class="currency">${pkg.retailPrice ? formatNumber(pkg.retailPrice) : '-'}</td>
                    <td class="currency">${pkg.wholesalePrice ? formatNumber(pkg.wholesalePrice) : '-'}</td>
                    <td class="currency">${pkg.distributorPrice ? formatNumber(pkg.distributorPrice) : '-'}</td>
                    <td>${pkg.createdAt}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-package" data-id="${pkg.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-package" data-id="${pkg.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                table.appendChild(row);
            });
            
            // إضافة معالجات الأحداث للأزرار
            document.querySelectorAll('.edit-package').forEach(btn => {
                btn.addEventListener('click', () => editPackage(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-package').forEach(btn => {
                btn.addEventListener('click', () => deletePackage(btn.dataset.id));
            });
        }
        
        // عرض جدول المخزون
        function renderInventoryTable() {
            const table = document.getElementById('inventoryTable');
            table.innerHTML = '';
            
            data.inventory.forEach(item => {
                const pkg = data.packages.find(p => p.id === item.packageId);
                if (!pkg) return;
                
                const retailValue = item.quantity * (pkg.retailPrice || 0);
                const wholesaleValue = item.quantity * (pkg.wholesalePrice || 0);
                const distributorValue = item.quantity * (pkg.distributorPrice || 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pkg.name}</td>
                    <td>${formatNumber(item.quantity)}</td>
                    <td class="currency">${formatNumber(retailValue)}</td>
                    <td class="currency">${formatNumber(wholesaleValue)}</td>
                    <td class="currency">${formatNumber(distributorValue)}</td>
                    <td>${item.createdAt}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-inventory" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-inventory" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                table.appendChild(row);
            });
            
            // إضافة معالجات الأحداث للأزرار
            document.querySelectorAll('.edit-inventory').forEach(btn => {
                btn.addEventListener('click', () => editInventory(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-inventory').forEach(btn => {
                btn.addEventListener('click', () => deleteInventory(btn.dataset.id));
            });
        }
        
        // عرض قائمة المحلات
        function renderStoresList() {
            const list = document.getElementById('storesList');
            list.innerHTML = '';
            
            data.stores.forEach(store => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.dataset.id = store.id;
                item.innerHTML = `
                    <div>${store.name}</div>
                    <small class="text-muted">نوع السعر: ${getPriceTypeName(store.priceType)}</small>
                `;
                item.addEventListener('click', () => showStoreDetails(store.id));
                list.appendChild(item);
            });
        }
        // عرض تفاصيل المحل
        function showStoreDetails(storeId) {
            const store = data.stores.find(s => s.id === storeId);
            if (!store) return;
            
            document.getElementById('storeHeader').textContent = `تفاصيل المحل: ${store.name}`;
            const details = document.getElementById('storeDetails');
            
            // حساب الرصيد
            const sales = data.sales.filter(s => s.storeId === storeId);
            const payments = data.payments.filter(p => p.storeId === storeId);
            
            const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalPayments = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const balance = totalSales - totalPayments;
            
            details.innerHTML = `
                <div class="d-flex justify-content-between mb-4">
                    <div>
                        <h5>الرصيد الحالي:</h5>
                        <p class="h4 ${balance >= 0 ? 'text-success' : 'text-danger'} currency">${formatNumber(Math.abs(balance))}</p>
                    </div>
                    <div>
                        <h5>نوع السعر:</h5>
                        <p class="h5">${getPriceTypeName(store.priceType)}</p>
                    </div>
                    <div>
                        <button class="btn btn-success" id="addSaleBtn" data-store="${storeId}"><i class="fas fa-plus me-2"></i>إضافة بيع</button>
                        <button class="btn btn-info" id="addPaymentBtn" data-store="${storeId}"><i class="fas fa-money-bill me-2"></i>تسديد دفعة</button>
                        <button class="btn btn-warning edit-store" data-id="${storeId}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger delete-store" data-id="${storeId}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                
                <h5>عمليات البيع</h5>
                <div class="table-responsive mb-4">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>السبب/الباقة</th>
                                <th>الكمية/المبلغ</th>
                                <th>الإجمالي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="storeSalesTable">
                            <!-- سيتم ملؤه بالبيانات -->
                        </tbody>
                    </table>
                </div>
                
                <h5>عمليات التسديد</h5>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>المبلغ</th>
                                <th>ملاحظات</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="storePaymentsTable">
                            <!-- سيتم ملؤه بالبيانات -->
                        </tbody>
                    </table>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">من تاريخ</label>
                                <input type="date" id="storeFromDate" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">إلى تاريخ</label>
                                <input type="date" id="storeToDate" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" id="storeApplyFilterBtn">تطبيق الفترة للتصدير</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="export-options mt-2">
                    <button type="button" class="btn btn-outline-success export-btn" data-type="store" data-store="${storeId}" data-format="excel">
                        <i class="fas fa-file-excel me-2"></i>تصدير Excel
                    </button>
                    <button type="button" class="btn btn-outline-secondary export-btn" data-type="store" data-store="${storeId}" data-format="txt">
                        <i class="fas fa-file-alt me-2"></i>تصدير TXT
                    </button>
                    <button type="button" class="btn btn-outline-dark export-btn" data-type="store" data-store="${storeId}" data-format="json">
                        <i class="fas fa-file-code me-2"></i>تصدير JSON
                    </button>
                    <!-- زر تصدير PDF مخفي حالياً - يمكن تفعيله لاحقاً عند تطوير ميزة تصدير PDF الحقيقية
                    <button type="button" class="btn btn-outline-danger export-btn" data-type="store" data-store="${storeId}" data-format="pdf">
                        <i class="fas fa-file-pdf me-2"></i>تصدير PDF
                    </button>
                    -->
                    <button type="button" class="btn btn-outline-primary export-btn" data-type="store" data-store="${storeId}" data-format="printpage">
                        <i class="fas fa-file-alt me-2"></i>فتح صفحة التقرير
                    </button>
                    <button type="button" class="btn btn-outline-info export-btn" data-type="store" data-store="${storeId}" data-format="statement">
                        <i class="fas fa-file-invoice me-2"></i>كشف حساب متحرك
                    </button>
                </div>
            `;
            
            // تعبئة جدول المبيعات
            const salesTable = document.getElementById('storeSalesTable');
            salesTable.innerHTML = '';
            sales.forEach(sale => {
                const pkg = sale.packageId ? data.packages.find(p => p.id === sale.packageId) : null;
                const isCustom = sale.packageId === 'custom';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.date}</td>
                    <td>${sale.reason || (pkg ? pkg.name : 'غير معروف')}</td>
                    <td>${isCustom ? ('<span class=\"currency\">' + formatNumber(sale.amount) + '</span>') : sale.quantity}</td>
                    <td class="currency">${formatNumber(sale.total)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-sale" data-id="${sale.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-sale" data-id="${sale.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                salesTable.appendChild(row);
            });
            
            // تعبئة جدول التسديدات
            const paymentsTable = document.getElementById('storePaymentsTable');
            paymentsTable.innerHTML = '';
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.date}</td>
                    <td class="currency">${formatNumber(payment.amount)}</td>
                    <td>${payment.notes || ''}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-payment" data-id="${payment.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-payment" data-id="${payment.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                paymentsTable.appendChild(row);
            });
            
            // إضافة معالجات الأحداث للأزرار الجديدة
            document.getElementById('addSaleBtn').addEventListener('click', () => addSale(storeId));
            document.getElementById('addPaymentBtn').addEventListener('click', () => addPayment(storeId));
            
            document.querySelector('.edit-store').addEventListener('click', () => editStore(storeId));
            document.querySelector('.delete-store').addEventListener('click', () => deleteStore(storeId));
            
            document.querySelectorAll('.edit-sale').forEach(btn => {
                btn.addEventListener('click', () => editSale(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-sale').forEach(btn => {
                btn.addEventListener('click', () => deleteSale(btn.dataset.id));
            });
            
            document.querySelectorAll('.edit-payment').forEach(btn => {
                btn.addEventListener('click', () => editPayment(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-payment').forEach(btn => {
                btn.addEventListener('click', () => deletePayment(btn.dataset.id));
            });
        }
        
        // إضافة بيع جديد
        function addSale(storeId) {
            // تعبئة قائمة الباقات
            const select = document.getElementById('salePackage');
            select.innerHTML = '';
            select.innerHTML = '<option value="">اختر الباقة</option>';
            select.innerHTML += '<option value="custom">مخصص (مبلغ مباشر)</option>';
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.id;
                option.textContent = pkg.name;
                select.appendChild(option);
            });
            
            // إضافة معالج الحدث لتغيير خيار الباقة
            select.addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                document.getElementById('customReasonGroup').style.display = isCustom ? 'block' : 'none';
                document.getElementById('quantityGroup').style.display = isCustom ? 'none' : 'block';
                document.getElementById('amountGroup').style.display = isCustom ? 'block' : 'none';
                
                if (isCustom) {
                    document.getElementById('saleReason').value = '';
                    document.getElementById('saleAmount').value = '';
                } else {
                    document.getElementById('saleQuantity').value = '';
                }
            });
            
            document.getElementById('saleModalTitle').textContent = 'إضافة بيع';
            document.getElementById('saleId').value = '';
            document.getElementById('saleStoreId').value = storeId;
            document.getElementById('saleReason').value = '';
            document.getElementById('saleQuantity').value = '';
            document.getElementById('saleAmount').value = '';
            document.getElementById('saleDate').value = today;
            document.getElementById('customReasonGroup').style.display = 'none';
            document.getElementById('amountGroup').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('saleModal'));
            modal.show();
        }
        
        // حفظ البيع
        function saveSale() {
            const id = document.getElementById('saleId').value;
            const storeId = document.getElementById('saleStoreId').value;
            const packageId = document.getElementById('salePackage').value;
            const reason = document.getElementById('saleReason').value;
            const quantity = parseFormattedNumber(document.getElementById('saleQuantity').value) || 0;
            const amount = parseFormattedNumber(document.getElementById('saleAmount').value) || 0;
            const date = document.getElementById('saleDate').value || today;
            
            if (!storeId || (!packageId && !reason)) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            const isCustom = packageId === 'custom';
            const store = data.stores.find(s => s.id === storeId);
            const pkg = packageId && !isCustom ? data.packages.find(p => p.id === packageId) : null;
            
            let pricePerUnit = 0;
            let total = 0;
            
            if (isCustom) {
                // بيع مخصص
                pricePerUnit = amount;
                total = amount;
            } else if (pkg && store) {
                // تحديد السعر حسب نوع سعر المحل
                switch(store.priceType) {
                    case 'retail':
                        pricePerUnit = pkg.retailPrice || 0;
                        break;
                    case 'wholesale':
                        pricePerUnit = pkg.wholesalePrice || 0;
                        break;
                    case 'distributor':
                        pricePerUnit = pkg.distributorPrice || 0;
                        break;
                    default:
                        pricePerUnit = pkg.retailPrice || 0;
                }
                total = quantity * pricePerUnit;
                // تحقق من توفر المخزون وخصمه
                if (quantity <= 0) {
                    showNotification('الكمية غير صحيحة', 'error');
                    return;
                }
                const ok = deductFromInventory(packageId, quantity);
                if (!ok) {
                    showNotification('الكمية المطلوبة غير متوفرة في المخزون', 'error');
                    return;
                }
            }
            
            if (id) {
                // تحديث البيع الحالي
                const sale = data.sales.find(s => s.id === id);
                if (sale) {
                    // إذا كان البيع السابق ليس مخصصاً وكان له كمية وباقة، قم بإرجاع الكمية القديمة إلى المخزون أولاً
                    if (sale.packageId && sale.packageId !== 'custom' && sale.quantity) {
                        addToInventory(sale.packageId, sale.quantity);
                    }
                    sale.packageId = packageId;
                    sale.reason = reason;
                    sale.quantity = quantity;
                    sale.amount = amount;
                    sale.pricePerUnit = pricePerUnit;
                    sale.total = total;
                    sale.date = date;
                }
                showNotification('تم تحديث البيع بنجاح', 'success');
            } else {
                // إضافة بيع جديد
                const newId = 'sale_' + Date.now();
                data.sales.push({
                    id: newId,
                    storeId: storeId,
                    packageId: packageId,
                    reason: reason,
                    quantity: quantity,
                    amount: amount,
                    pricePerUnit: pricePerUnit,
                    total: total,
                    date: date
                });
                showNotification('تم إضافة البيع بنجاح', 'success');
            }
            
            // تنبيه انخفاض المخزون
            if (!isCustom && packageId) {
                checkLowStockForPackage(packageId);
            }
            
            saveData();
            renderInventoryTable();
            showStoreDetails(storeId);
            updateDashboard();
            updateProfitReport();
            generateDebtReport();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('saleModal'));
            modal.hide();
            setTimeout(cleanupModalBackdrops, 300);
        }
        // تحرير بيع
        function editSale(id) {
            const sale = data.sales.find(s => s.id === id);
            if (!sale) return;
            
            // تعبئة قائمة الباقات
            const select = document.getElementById('salePackage');
            select.innerHTML = '';
            select.innerHTML = '<option value="">اختر الباقة</option>';
            select.innerHTML += '<option value="custom">مخصص (مبلغ مباشر)</option>';
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.id;
                option.textContent = pkg.name;
                option.selected = pkg.id === sale.packageId;
                select.appendChild(option);
            });
            
            // تحديد حالة الخيار المخصص
            const isCustom = sale.packageId === 'custom';
            if (isCustom) {
                select.value = 'custom';
            }
            
            // إضافة معالج الحدث لتغيير خيار الباقة
            select.addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                document.getElementById('customReasonGroup').style.display = isCustom ? 'block' : 'none';
                document.getElementById('quantityGroup').style.display = isCustom ? 'none' : 'block';
                document.getElementById('amountGroup').style.display = isCustom ? 'block' : 'none';
                
                if (isCustom) {
                    document.getElementById('saleReason').value = sale.reason || '';
                    document.getElementById('saleAmount').value = formatNumber(sale.amount) || '';
                } else {
                    document.getElementById('saleQuantity').value = formatNumber(sale.quantity) || '';
                }
            });
            
            document.getElementById('saleModalTitle').textContent = 'تعديل البيع';
            document.getElementById('saleId').value = sale.id;
            document.getElementById('saleStoreId').value = sale.storeId;
            document.getElementById('saleReason').value = sale.reason || '';
            document.getElementById('saleQuantity').value = formatNumber(sale.quantity) || '';
            document.getElementById('saleAmount').value = formatNumber(sale.amount) || '';
            document.getElementById('saleDate').value = sale.date;
            document.getElementById('customReasonGroup').style.display = isCustom ? 'block' : 'none';
            document.getElementById('quantityGroup').style.display = isCustom ? 'none' : 'block';
            document.getElementById('amountGroup').style.display = isCustom ? 'block' : 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('saleModal'));
            modal.show();
        }
        
        // حذف بيع
        function deleteSale(id) {
            const sale = data.sales.find(s => s.id === id);
            if (!sale) return;
            
            if (confirm('هل أنت متأكد من حذف هذا البيع؟')) {
                // إذا كان البيع مرتبطاً بباقة وكمية، أعد الكمية إلى المخزون
                if (sale.packageId && sale.packageId !== 'custom' && sale.quantity) {
                    addToInventory(sale.packageId, sale.quantity);
                }
                data.sales = data.sales.filter(s => s.id !== id);
                saveData();
                renderInventoryTable();
                showStoreDetails(sale.storeId);
                updateDashboard();
                updateProfitReport();
                generateDebtReport();
                showNotification('تم حذف البيع بنجاح', 'success');
            }
        }
        
        // إضافة تسديد جديد
        function addPayment(storeId) {
            document.getElementById('paymentModalTitle').textContent = 'إضافة تسديد';
            document.getElementById('paymentId').value = '';
            document.getElementById('paymentStoreId').value = storeId;
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNotes').value = '';
            document.getElementById('paymentDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }
        
        // حفظ التسديد
        function savePayment() {
            const id = document.getElementById('paymentId').value;
            const storeId = document.getElementById('paymentStoreId').value;
            const amount = parseFormattedNumber(document.getElementById('paymentAmount').value);
            const notes = document.getElementById('paymentNotes').value;
            const date = document.getElementById('paymentDate').value || today;
            
            if (!storeId || isNaN(amount) || amount <= 0) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (id) {
                // تحديث التسديد الحالي
                const payment = data.payments.find(p => p.id === id);
                if (payment) {
                    payment.amount = amount;
                    payment.notes = notes;
                    payment.date = date;
                }
                showNotification('تم تحديث التسديد بنجاح', 'success');
            } else {
                // إضافة تسديد جديد
                const newId = 'payment_' + Date.now();
                data.payments.push({
                    id: newId,
                    storeId: storeId,
                    amount: amount,
                    notes: notes,
                    date: date
                });
                showNotification('تم إضافة التسديد بنجاح', 'success');
            }
            
            saveData();
            showStoreDetails(storeId);
            updateDashboard();
            updateProfitReport();
            generateDebtReport();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();
            setTimeout(cleanupModalBackdrops, 300);
        }
        
        // تحرير تسديد
        function editPayment(id) {
            const payment = data.payments.find(p => p.id === id);
            if (!payment) return;
            
            document.getElementById('paymentModalTitle').textContent = 'تعديل التسديد';
            document.getElementById('paymentId').value = payment.id;
            document.getElementById('paymentStoreId').value = payment.storeId;
            document.getElementById('paymentAmount').value = formatNumber(payment.amount);
            document.getElementById('paymentNotes').value = payment.notes || '';
            document.getElementById('paymentDate').value = payment.date;
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }
        
        // حذف تسديد
        function deletePayment(id) {
            const payment = data.payments.find(p => p.id === id);
            if (!payment) return;
            
            if (confirm('هل أنت متأكد من حذف هذا التسديد؟')) {
                data.payments = data.payments.filter(p => p.id !== id);
                saveData();
                showStoreDetails(payment.storeId);
                updateDashboard();
                updateProfitReport();
                generateDebtReport();
                showNotification('تم حذف التسديد بنجاح', 'success');
            }
        }
        
        // إضافة باقة جديدة
        function addPackage() {
            document.getElementById('packageModalTitle').textContent = 'إضافة باقة جديدة';
            document.getElementById('packageId').value = '';
            document.getElementById('packageName').value = '';
            document.getElementById('retailPrice').value = '';
            document.getElementById('wholesalePrice').value = '';
            document.getElementById('distributorPrice').value = '';
            document.getElementById('packageDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('packageModal'));
            modal.show();
        }
        // تحرير باقة موجودة
        function editPackage(id) {
            const pkg = data.packages.find(p => p.id === id);
            if (!pkg) return;
            
            document.getElementById('packageModalTitle').textContent = 'تعديل الباقة';
            document.getElementById('packageId').value = pkg.id;
            document.getElementById('packageName').value = pkg.name;
            document.getElementById('retailPrice').value = pkg.retailPrice ? formatNumber(pkg.retailPrice) : '';
            document.getElementById('wholesalePrice').value = pkg.wholesalePrice ? formatNumber(pkg.wholesalePrice) : '';
            document.getElementById('distributorPrice').value = pkg.distributorPrice ? formatNumber(pkg.distributorPrice) : '';
            document.getElementById('packageDate').value = pkg.createdAt || today;
            
            const modal = new bootstrap.Modal(document.getElementById('packageModal'));
            modal.show();
        }
        
        // حذف باقة
        function deletePackage(id) {
            if (confirm('هل أنت متأكد من حذف هذه الباقة؟')) {
                data.packages = data.packages.filter(p => p.id !== id);
                saveData();
                renderPackagesTable();
                updateDashboard();
                showNotification('تم حذف الباقة بنجاح', 'success');
            }
        }
        
        // حفظ الباقة (إضافة/تعديل)
        function savePackage() {
            const id = document.getElementById('packageId').value;
            const name = document.getElementById('packageName').value;
            const retailPrice = parseFormattedNumber(document.getElementById('retailPrice').value) || null;
            const wholesalePrice = parseFormattedNumber(document.getElementById('wholesalePrice').value) || null;
            const distributorPrice = parseFormattedNumber(document.getElementById('distributorPrice').value) || null;
            const date = document.getElementById('packageDate').value || today;
            
            if (!name) {
                showNotification('يرجى إدخال اسم الباقة', 'error');
                return;
            }
            
            if (id) {
                // تحديث الباقة الحالية
                const pkg = data.packages.find(p => p.id === id);
                if (pkg) {
                    pkg.name = name;
                    pkg.retailPrice = retailPrice;
                    pkg.wholesalePrice = wholesalePrice;
                    pkg.distributorPrice = distributorPrice;
                    pkg.createdAt = date;
                }
                showNotification('تم تحديث الباقة بنجاح', 'success');
            } else {
                // إضافة باقة جديدة
                const newId = 'pkg_' + Date.now();
                data.packages.push({
                    id: newId,
                    name: name,
                    retailPrice: retailPrice,
                    wholesalePrice: wholesalePrice,
                    distributorPrice: distributorPrice,
                    createdAt: date
                });
                showNotification('تم إضافة الباقة بنجاح', 'success');
            }
            
            saveData();
            renderPackagesTable();
            updateDashboard();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('packageModal'));
            modal.hide();
            setTimeout(cleanupModalBackdrops, 300);
        }
        
        // إضافة كمية جديدة
        function addInventory() {
            // تعبئة قائمة الباقات
            const select = document.getElementById('inventoryPackage');
            select.innerHTML = '';
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.id;
                option.textContent = pkg.name;
                select.appendChild(option);
            });
            
            document.getElementById('inventoryModalTitle').textContent = 'إضافة كمية جديدة';
            document.getElementById('inventoryId').value = '';
            document.getElementById('inventoryQuantity').value = '';
            document.getElementById('inventoryDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
            modal.show();
        }
        
        // تحرير كمية موجودة
        function editInventory(id) {
            const item = data.inventory.find(i => i.id === id);
            if (!item) return;
            
            // تعبئة قائمة الباقات
            const select = document.getElementById('inventoryPackage');
            select.innerHTML = '';
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.id;
                option.textContent = pkg.name;
                option.selected = pkg.id === item.packageId;
                select.appendChild(option);
            });
            
            document.getElementById('inventoryModalTitle').textContent = 'تعديل الكمية';
            document.getElementById('inventoryId').value = item.id;
            document.getElementById('inventoryQuantity').value = formatNumber(item.quantity);
            document.getElementById('inventoryDate').value = item.createdAt || today;
            
            const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
            modal.show();
        }
        
        // حذف كمية
        function deleteInventory(id) {
            if (confirm('هل أنت متأكد من حذف هذه الكمية؟')) {
                data.inventory = data.inventory.filter(i => i.id !== id);
                saveData();
                renderInventoryTable();
                updateDashboard();
                showNotification('تم حذف الكمية بنجاح', 'success');
            }
        }
        
        // حفظ الكمية (إضافة/تعديل)
        function saveInventory() {
            const id = document.getElementById('inventoryId').value;
            const packageId = document.getElementById('inventoryPackage').value;
            const quantity = parseFormattedNumber(document.getElementById('inventoryQuantity').value);
            const date = document.getElementById('inventoryDate').value || today;
            
            if (!packageId || isNaN(quantity) || quantity <= 0) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (id) {
                // تحديث الكمية الحالية
                const item = data.inventory.find(i => i.id === id);
                if (item) {
                    item.packageId = packageId;
                    item.quantity = quantity;
                    item.createdAt = date;
                }
                showNotification('تم تحديث الكمية بنجاح', 'success');
            } else {
                // إضافة كمية جديدة
                const newId = 'inv_' + Date.now();
                data.inventory.push({
                    id: newId,
                    packageId: packageId,
                    quantity: quantity,
                    createdAt: date
                });
                showNotification('تم إضافة الكمية بنجاح', 'success');
            }
            
            saveData();
            renderInventoryTable();
            updateDashboard();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryModal'));
            modal.hide();
            setTimeout(cleanupModalBackdrops, 300);
        }
        
        // إضافة محل جديد
        function addStore() {
            document.getElementById('storeModalTitle').textContent = 'إضافة محل جديد';
            document.getElementById('storeId').value = '';
            document.getElementById('storeName').value = '';
            document.getElementById('storePriceType').value = 'retail';
            document.getElementById('storeDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('storeModal'));
            modal.show();
        }
        
        // تحرير محل موجود
        function editStore(id) {
            const store = data.stores.find(s => s.id === id);
            if (!store) return;
            
            document.getElementById('storeModalTitle').textContent = 'تعديل المحل';
            document.getElementById('storeId').value = store.id;
            document.getElementById('storeName').value = store.name;
            document.getElementById('storePriceType').value = store.priceType;
            document.getElementById('storeDate').value = store.createdAt || today;
            
            const modal = new bootstrap.Modal(document.getElementById('storeModal'));
            modal.show();
        }
        
        // حذف محل
        function deleteStore(id) {
            if (confirm('هل أنت متأكد من حذف هذا المحل؟')) {
                data.stores = data.stores.filter(s => s.id !== id);
                saveData();
                renderStoresList();
                updateDashboard();
                updateReportStores();
                generateDebtReport();
                showNotification('تم حذف المحل بنجاح', 'success');
            }
        }
        
        // حفظ المحل (إضافة/تعديل)
        function saveStore() {
            const id = document.getElementById('storeId').value;
            const name = document.getElementById('storeName').value;
            const priceType = document.getElementById('storePriceType').value;
            const date = document.getElementById('storeDate').value || today;
            
            if (!name) {
                showNotification('يرجى إدخال اسم المحل', 'error');
                return;
            }
            
            if (id) {
                // تحديث المحل الحالي
                const store = data.stores.find(s => s.id === id);
                if (store) {
                    store.name = name;
                    store.priceType = priceType;
                    store.createdAt = date;
                }
                showNotification('تم تحديث المحل بنجاح', 'success');
            } else {
                // إضافة محل جديد
                const newId = 'store_' + Date.now();
                data.stores.push({
                    id: newId,
                    name: name,
                    priceType: priceType,
                    createdAt: date
                });
                showNotification('تم إضافة المحل بنجاح', 'success');
            }
            
            saveData();
            renderStoresList();
            updateDashboard();
            updateReportStores();
            generateDebtReport();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('storeModal'));
            modal.hide();
            setTimeout(cleanupModalBackdrops, 300);
        }
        
        // إضافة مصروف جديد
        function addExpense() {
            document.getElementById('expenseModalTitle').textContent = 'إضافة مصروف جديد';
            document.getElementById('expenseId').value = '';
            document.getElementById('expenseType').value = '';
            const chipsWrap = document.getElementById('expenseTypeChips');
            if (chipsWrap) chipsWrap.innerHTML = '';
            const customInp = document.getElementById('expenseTypeCustom');
            if (customInp) customInp.value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseNotes').value = '';
            document.getElementById('expenseDate').value = today;
            document.getElementById('addLater').checked = false;
            
            const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
            modal.show();
        }
        
        // تحرير مصروف موجود
        function editExpense(id) {
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) return;
            
            document.getElementById('expenseModalTitle').textContent = 'تعديل المصروف';
            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseType').value = expense.type;
            const customInp = document.getElementById('expenseTypeCustom');
            if (customInp) customInp.value = '';
            document.getElementById('expenseAmount').value = formatNumber(expense.amount);
            document.getElementById('expenseNotes').value = expense.notes || '';
            document.getElementById('expenseDate').value = expense.date || today;
            document.getElementById('addLater').checked = expense.addLater || false;
            
            const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
            modal.show();
        }
        
        // حذف مصروف
        function deleteExpense(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                data.expenses = data.expenses.filter(e => e.id !== id);
                saveData();
                renderExpensesTable();
                updateDashboard();
                updateProfitReport();
                showNotification('تم حذف المصروف بنجاح', 'success');
            }
        }
        
        // حفظ المصروف (إضافة/تعديل)
        function saveExpense() {
            const id = document.getElementById('expenseId').value;
            const type = document.getElementById('expenseType').value;
            const amount = parseFormattedNumber(document.getElementById('expenseAmount').value) || 0;
            const notes = document.getElementById('expenseNotes').value;
            const date = document.getElementById('expenseDate').value || today;
            const addLater = document.getElementById('addLater').checked;
            
            if (!type) {
                showNotification('يرجى إدخال نوع المصروف', 'error');
                return;
            }
            
            if (id) {
                // تحديث المصروف الحالي
                const expense = data.expenses.find(e => e.id === id);
                if (expense) {
                    expense.type = type;
                    expense.amount = amount;
                    expense.notes = notes;
                    expense.date = date;
                    expense.addLater = addLater;
                }
                showNotification('تم تحديث المصروف بنجاح', 'success');
            } else {
                // إضافة مصروف جديد
                const newId = 'exp_' + Date.now();
                data.expenses.push({
                    id: newId,
                    type: type,
                    amount: amount,
                    notes: notes,
                    date: date,
                    addLater: addLater
                });
                showNotification('تم إضافة المصروف بنجاح', 'success');
            }
            // حفظ نوع المصروف المختار ضمن الاقتراحات
            try {
                const saved = JSON.parse(localStorage.getItem('expenseTypes')||'[]');
                if (type && !saved.includes(type)) {
                    saved.push(type);
                    localStorage.setItem('expenseTypes', JSON.stringify(saved));
                }
            } catch(_) {}
            
            
            saveData();
            renderExpensesTable();
            updateDashboard();
            updateProfitReport();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('expenseModal'));
            modal.hide();
            setTimeout(cleanupModalBackdrops, 300);
        }
        


        // ربط تغييرات واجهة فترة المصروفات
        (function(){
            const sel = document.getElementById('expensesPeriod');
            const rangeWrap = document.getElementById('expensesCustomRange');
            const applyBtn = document.getElementById('applyExpensesCustomRange');
            function syncRangeVisibility(){ if (!rangeWrap || !sel) return; rangeWrap.style.display = sel.value === 'custom' ? 'flex' : 'none'; }
            if (sel){ sel.addEventListener('change', () => { syncRangeVisibility(); renderExpensesTable(); updateDashboard(); updateProfitReport(); }); }
            if (applyBtn){ applyBtn.addEventListener('click', () => { renderExpensesTable(); updateDashboard(); updateProfitReport(); }); }
            syncRangeVisibility();
        })();
        
        // تحديث قائمة المحلات في التقارير
        function updateReportStores() {
            // البحث عن العنصر الصحيح reportsStoreFilter بدلاً من reportStoreSelect
            const select = document.getElementById('reportsStoreFilter');
            if (!select) return;
            
            // حفظ القيمة الحالية
            const currentValue = select.value;
            
            // مسح الخيارات الحالية باستثناء "جميع المحلات"
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // إضافة المحلات
            data.stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.name;
                select.appendChild(option);
            });
            
            // استعادة القيمة المحددة إذا كانت لا تزال موجودة
            if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }
        }
        
        // توليد تقرير الديون
        function generateDebtReport() {
            const table = document.getElementById('debtReportTable');
            table.innerHTML = '';
            
            // حساب إجمالي الديون
            const totalDebts = data.stores.reduce((sum, store) => {
                const storeSales = data.sales.filter(s => s.storeId === store.id);
                const storePayments = data.payments.filter(p => p.storeId === store.id);
                
                const totalSales = storeSales.reduce((s, sale) => s + sale.total, 0);
                const totalPayments = storePayments.reduce((p, payment) => p + payment.amount, 0);
                
                return sum + (totalSales - totalPayments);
            }, 0);
            
            document.getElementById('totalDebts').textContent = formatNumber(totalDebts);
            
            data.stores.forEach(store => {
                const storeSales = data.sales.filter(s => s.storeId === store.id);
                const storePayments = data.payments.filter(p => p.storeId === store.id);
                
                const totalSales = storeSales.reduce((sum, sale) => sum + sale.total, 0);
                const totalPayments = storePayments.reduce((sum, payment) => sum + payment.amount, 0);
                const remaining = totalSales - totalPayments;
                
                const lastSale = storeSales.length > 0 ? 
                    storeSales.reduce((latest, sale) => sale.date > latest ? sale.date : latest, '') : '';
                
                const lastPayment = storePayments.length > 0 ? 
                    storePayments.reduce((latest, payment) => payment.date > latest ? payment.date : latest, '') : '';
                
                const lastTransaction = lastSale > lastPayment ? lastSale : lastPayment;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${store.name}</td>
                    <td class="currency">${formatNumber(totalSales)}</td>
                    <td class="currency">${formatNumber(totalPayments)}</td>
                    <td class="currency ${remaining > 0 ? 'text-danger' : 'text-success'}">${formatNumber(Math.abs(remaining))}</td>
                    <td>${getPriceTypeName(store.priceType)}</td>
                    <td>${lastTransaction || 'لا يوجد'}</td>
                `;
                table.appendChild(row);
            });
        }
        // تصدير البيانات
        function exportData() {
            const dataType = document.getElementById('exportDataType').value;
            const format = document.getElementById('exportFormat').value;
            
            let exportData;
            let title = '';
            let filename = `تصدير_${dataType}_${moment().format('YYYYMMDD')}`;
            
            switch(dataType) {
                case 'packages':
                    exportData = data.packages;
                    title = 'الباقات والأسعار';
                    break;
                case 'inventory':
                    exportData = data.inventory;
                    title = 'كمية الكروت';
                    break;
                case 'stores':
                    exportData = data.stores;
                    title = 'البقالات والمحلات';
                    break;
                case 'expenses':
                    exportData = (window.__getFilteredExpensesForExport ? window.__getFilteredExpensesForExport() : data.expenses);
                    title = 'المصروفات (حسب الفلتر الحالي)';
                    break;
                case 'sales':
                    exportData = data.sales;
                    title = 'المبيعات';
                    break;
                case 'payments':
                    exportData = data.payments;
                    title = 'التسديدات';
                    break;
                case 'reports':
                    exportData = {
                        debtReport: generateDebtReportData(),
                        profitReport: generateProfitReportData(),
                        expensesFiltered: (window.__getFilteredExpensesForExport ? window.__getFilteredExpensesForExport() : data.expenses)
                    };
                    title = 'التقارير';
                    filename = `تقرير_${moment().format('YYYYMMDD')}`;
                    break;
                default:
                    exportData = data;
                    title = 'جميع البيانات';
                    filename = `نسخة_احتياطية_${moment().format('YYYYMMDD')}`;
            }
            
            if (format === 'json') {
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير البيانات إلى ملف JSON', 'success');
            } else if (format === 'excel') {
                // إنشاء ورقة عمل
                let wb;
                if (Array.isArray(exportData)) {
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, title);
                } else {
                    // كائن متعدد الأقسام (مثل التقارير)
                    wb = XLSX.utils.book_new();
                    Object.keys(exportData).forEach(key => {
                        const ws = XLSX.utils.json_to_sheet(exportData[key]);
                        XLSX.utils.book_append_sheet(wb, ws, key);
                    });
                }
                
                // تصدير إلى Excel
                XLSX.writeFile(wb, `${filename}.xlsx`);
                showNotification('تم تصدير البيانات إلى ملف Excel', 'success');
            } else if (format === 'txt') {
                // إنشاء نص بسيط
                let txtContent = `${title}\n\n`;
                txtContent += `تاريخ التصدير: ${moment().format('YYYY-MM-DD')}\n\n`;
                
                if (Array.isArray(exportData) && exportData.length > 0) {
                    // العناوين
                    const headers = Object.keys(exportData[0]).join('\t');
                    txtContent += headers + '\n';
                    
                    // البيانات
                    exportData.forEach(item => {
                        txtContent += Object.values(item).join('\t') + '\n';
                    });
                } else if (typeof exportData === 'object') {
                    // كائن متعدد الأقسام
                    Object.keys(exportData).forEach(key => {
                        txtContent += `\n===== ${key} =====\n\n`;
                        const section = exportData[key];
                        if (Array.isArray(section) && section.length > 0) {
                            const headers = Object.keys(section[0]).join('\t');
                            txtContent += headers + '\n';
                            section.forEach(item => {
                                txtContent += Object.values(item).join('\t') + '\n';
                            });
                        }
                    });
                }
                
                // تنزيل الملف
                const blob = new Blob([txtContent], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير البيانات إلى ملف TXT', 'success');
            }
        }

        function buildStoreReportHTML(store, periodText, mappedSalesForExport, mappedPaymentsForExport, totalSales, totalPayments, remaining) {
            const baseUrl = (function(){ try { return new URL('.', location.href).href; } catch(e) { return location.href.substring(0, location.href.lastIndexOf('/') + 1); } })();
            const fontUrl = baseUrl + 'fonts/Amiri-Regular.woff2';

            function buildSalesRows() {
                let rows = '';
                for (const s of mappedSalesForExport) {
                    rows += '<tr>' +
                        '<td>' + s.التاريخ + '</td>' +
                        '<td>' + s.التفاصيل + '</td>' +
                        '<td>' + s.الباقة + '</td>' +
                        '<td>' + s.الكمية_أو_المبلغ + '</td>' +
                        '<td>' + (s.الإجمالي || 0).toLocaleString('en-US') + ' ر.ي</td>' +
                    '</tr>';
                }
                return rows;
            }

            function buildPaymentRows() {
                let rows = '';
                for (const p of mappedPaymentsForExport) {
                    rows += '<tr>' +
                        '<td>' + p.التاريخ + '</td>' +
                        '<td>' + (p.المبلغ || 0).toLocaleString('en-US') + ' ر.ي</td>' +
                        '<td>' + (p.ملاحظات || '') + '</td>' +
                    '</tr>';
                }
                return rows;
            }

            let html = '';
            html += '<!doctype html>';
            html += '<html lang="ar" dir="rtl">';
            html += '<head><meta charset="utf-8">';
            html += '<title>' + (window.APP_NAME || 'فاست لينك - حسابات') + ' | كشف حساب: ' + store.name + '</title>';
            html += '<style>' +
                    '.app-brandline{ text-align:center; font-size:12px; color:#0ea5e9; margin:4px 0; font-weight:600; }' +
                    "@font-face { font-family:'AmiriExport'; src: url('" + fontUrl + "') format('woff2'); font-weight:400; font-style:normal; }" +
                    "body { font-family:'AmiriExport','Arial',sans-serif; padding:16px; }" +
                    '.summary{ display:flex; gap:12px; justify-content:flex-end; margin:10px 0; }' +
                    '.box{ border:1px solid #ddd; padding:8px 12px; }' +
                    'table{ width:100%; border-collapse:collapse; text-align:right; margin-top:8px; }' +
                    'th,td{ border:1px solid #ccc; padding:6px; }' +
                    'h3,h4{ margin:12px 0 6px; text-align:right; }' +
                    '.actions{ display:flex; justify-content:flex-start; margin-bottom:12px; gap:8px; }' +
                    '.actions button{ padding:8px 12px; border:1px solid #2c3e50; background:#2c3e50; color:#fff; border-radius:6px; font-size:14px; }' +
                    '@media print { .actions{ display:none } }' +
                    '@page{ size:A4; margin:12mm; }' +
                '</style></head>';
            html += '<body>';
            html += '<div class="app-brandline">' + (window.APP_NAME || 'فاست لينك - حسابات') + '</div>';
            html += '<div class="actions"><button onclick="window.print()">حفظ التقرير كـ PDF</button></div>';
            html += '<h3>كشف حساب: ' + store.name + '</h3>';
            html += '<div>الفترة: ' + periodText + ' | تاريخ التصدير: ' + (new Date()).toISOString().slice(0,10) + '</div>';
            html += '<div class="summary">' +
                        '<div class="box">إجمالي المبيعات: ' + (totalSales||0).toLocaleString('en-US') + ' ر.ي</div>' +
                        '<div class="box">إجمالي التسديدات: ' + (totalPayments||0).toLocaleString('en-US') + ' ر.ي</div>' +
                        '<div class="box">المتبقي: ' + (remaining||0).toLocaleString('en-US') + ' ر.ي</div>' +
                    '</div>';
            html += '<h4>المبيعات</h4>';
            if (mappedSalesForExport.length > 0) {
                html += '<table><thead><tr><th>التاريخ</th><th>التفاصيل</th><th>الباقة</th><th>الكمية/المبلغ</th><th>الإجمالي</th></tr></thead><tbody>' +
                        buildSalesRows() +
                        '</tbody></table>';
            } else {
                html += '<div>لا توجد مبيعات ضمن الفترة</div>';
            }
            html += '<h4>التسديدات</h4>';
            if (mappedPaymentsForExport.length > 0) {
                html += '<table><thead><tr><th>التاريخ</th><th>المبلغ</th><th>ملاحظات</th></tr></thead><tbody>' +
                        buildPaymentRows() +
                        '</tbody></table>';
            } else {
                html += '<div>لا توجد تسديدات ضمن الفترة</div>';
            }
            html += '</body></html>';
            return html;
        }

        // تصدير تفاصيل المحل
        async function exportStoreData(storeId, format) {
            const store = data.stores.find(s => (s.id + '') === (storeId + ''));
            if (!store) {
                showNotification('تعذر تحديد المحل للتصدير', 'error');
                return;
            }
            
            var fromInput = document.getElementById('storeFromDate');
            var toInput = document.getElementById('storeToDate');
            const fromDate = (fromInput && fromInput.value) || '';
            const toDate = (toInput && toInput.value) || '';
            
            const salesAll = data.sales.filter(s => (s.storeId + '') === (storeId + ''));
            const paymentsAll = data.payments.filter(p => (p.storeId + '') === (storeId + ''));
            
            function parseDate(d) {
                if (!d) return null;
                const m = moment(d, [moment.ISO_8601, 'YYYY-MM-DD', 'YYYY-M-D', 'DD/MM/YYYY', 'D/M/YYYY'], true);
                if (m.isValid()) return m;
                const n = new Date(d);
                return isNaN(n.getTime()) ? null : moment(n);
            }
            
            function inRange(d) {
                if (!fromDate && !toDate) return true;
                const md = parseDate(d);
                if (!md) return true;
                if (fromDate) {
                    const mf = parseDate(fromDate);
                    if (mf && md.isBefore(mf, 'day')) return false;
                }
                if (toDate) {
                    const mt = parseDate(toDate);
                    if (mt && md.isAfter(mt, 'day')) return false;
                }
                return true;
            }
            
            let storeSales = salesAll.filter(s => inRange(s.date));
            let storePayments = paymentsAll.filter(p => inRange(p.date));
            if ((fromDate || toDate) && storeSales.length === 0 && storePayments.length === 0) {
                storeSales = salesAll.slice();
                storePayments = paymentsAll.slice();
            }
            
            // حساب ملخصات
            const totalSales = storeSales.reduce((sum, s) => sum + (s.total || 0), 0);
            const totalPayments = storePayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const remaining = totalSales - totalPayments;
            
            // إرفاق أسماء الباقات
            const packageIdToName = new Map(data.packages.map(p => [p.id + '', p.name]));
            const mappedSalesForExport = storeSales.map(s => ({
                التاريخ: s.date,
                التفاصيل: s.reason || (s.packageId ? 'بيع باقة' : 'بيع مخصص'),
                الباقة: s.packageId && s.packageId !== 'custom' ? (packageIdToName.get(s.packageId + '') || 'غير معروف') : 'مخصص',
                الكمية_أو_المبلغ: s.packageId === 'custom' ? s.amount : s.quantity,
                الإجمالي: s.total
            }));
            const mappedPaymentsForExport = storePayments.map(p => ({
                التاريخ: p.date,
                المبلغ: p.amount,
                ملاحظات: p.notes || ''
            }));
            
            const filename = `تفاصيل_${store.name.replace(/\s+/g, '_')}_${moment().format('YYYYMMDD')}`;
            const periodText = `${fromDate || 'من البداية'} إلى ${toDate || 'حتى الآن'}`;
            
            if (format === 'json') {
                const arabic = {
                    المحل: { اسم: store.name, نوع_السعر: getPriceTypeName(store.priceType) },
                    الفترة: periodText,
                    الملخص: { إجمالي_المبيعات: totalSales, إجمالي_التسديدات: totalPayments, المتبقي: remaining },
                    المبيعات: mappedSalesForExport,
                    التسديدات: mappedPaymentsForExport
                };
                const dataStr = JSON.stringify(arabic, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('تم تصدير بيانات المحل إلى ملف JSON', 'success');
            } else if (format === 'excel') {
                const wb = XLSX.utils.book_new();
                const storeWs = XLSX.utils.json_to_sheet([{ اسم: store.name, نوع_السعر: getPriceTypeName(store.priceType), الفترة: periodText }]);
                XLSX.utils.book_append_sheet(wb, storeWs, 'المحل');
                const summaryWs = XLSX.utils.json_to_sheet([{ إجمالي_المبيعات: totalSales, إجمالي_التسديدات: totalPayments, المتبقي: remaining }]);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'الملخص');
                if (mappedSalesForExport.length > 0) {
                    const salesWs = XLSX.utils.json_to_sheet(mappedSalesForExport);
                    XLSX.utils.book_append_sheet(wb, salesWs, 'المبيعات');
                }
                if (mappedPaymentsForExport.length > 0) {
                    const paymentsWs = XLSX.utils.json_to_sheet(mappedPaymentsForExport);
                    XLSX.utils.book_append_sheet(wb, paymentsWs, 'التسديدات');
                }
                XLSX.writeFile(wb, `${filename}.xlsx`);
                showNotification('تم تصدير بيانات المحل إلى ملف Excel', 'success');
            } else if (format === 'txt') {
                let txtContent = `تفاصيل المحل: ${store.name}\n\n`;
                txtContent += `الفترة: ${periodText}\n`;
                txtContent += `إجمالي المبيعات: ${totalSales}\n`;
                txtContent += `إجمالي التسديدات: ${totalPayments}\n`;
                txtContent += `المتبقي: ${remaining}\n\n`;
                txtContent += "===== المبيعات =====\n\n";
                if (mappedSalesForExport.length > 0) {
                    txtContent += ['التاريخ','التفاصيل','الباقة','الكمية/المبلغ','الإجمالي'].join('\t') + '\n';
                    mappedSalesForExport.forEach(s => {
                        txtContent += [s.التاريخ, s.التفاصيل, s.الباقة, s.الكمية_أو_المبلغ, s.الإجمالي].join('\t') + '\n';
                    });
                } else {
                    txtContent += "لا توجد مبيعات\n";
                }
                txtContent += "\n===== التسديدات =====\n\n";
                if (mappedPaymentsForExport.length > 0) {
                    txtContent += ['التاريخ','المبلغ','ملاحظات'].join('\t') + '\n';
                    mappedPaymentsForExport.forEach(p => {
                        txtContent += [p.التاريخ, p.المبلغ, p.ملاحظات].join('\t') + '\n';
                    });
                } else {
                    txtContent += "لا توجد تسديدات\n";
                }
                const blob = new Blob([txtContent], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('تم تصدير بيانات المحل إلى ملف TXT', 'success');
            } else if (format === 'printpage') {
                try {
                    const html = buildStoreReportHTML(store, periodText, mappedSalesForExport, mappedPaymentsForExport, totalSales, totalPayments, remaining);
                    const win = window.open('', '_blank');
                    if (!win || !win.document) { showNotification('يمنع المتصفح النوافذ المنبثقة. الرجاء السماح بها.', 'error'); return; }
                    win.document.open();
                    win.document.write(html);
                    win.document.close();
                    showNotification('تم فتح صفحة التقرير.', 'success');
                } catch (e) {
                    showNotification('تعذر فتح صفحة التقرير', 'error');
                }
            } else if (format === 'pdf') {
                // إعادة استخدام صفحة التقرير للطباعة كـ PDF
                try {
                    const html = buildStoreReportHTML(store, periodText, mappedSalesForExport, mappedPaymentsForExport, totalSales, totalPayments, remaining);
                    const win = window.open('', '_blank');
                    if (!win || !win.document) { showNotification('يمنع المتصفح النوافذ المنبثقة. الرجاء السماح بها للتصدير.', 'error'); return; }
                    win.document.open();
                    win.document.write(html);
                    win.document.close();
                    // محاولة تشغيل الطباعة تلقائياً بعد التحميل في تلك الصفحة عبر زرها
                    showNotification('تم فتح صفحة الطباعة. اضغط حفظ كـ PDF.', 'success');
                } catch (e) {
                    showNotification('حدث خطأ أثناء إنشاء PDF', 'error');
                }
            }
        }



        

        


        
        // توليد بيانات تقرير الديون
        function generateDebtReportData() {
            if (!data || !data.stores || data.stores.length === 0) {
                return [];
            }
            
            return data.stores.map(store => {
                const storeSales = (data.sales || []).filter(s => s.storeId === store.id);
                const storePayments = (data.payments || []).filter(p => p.storeId === store.id);
                
                const totalSales = storeSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const totalPayments = storePayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                const remaining = totalSales - totalPayments;
                
                return {
                    'اسم المحل': store.name || 'غير محدد',
                    'إجمالي المبيعات': totalSales,
                    'المدفوع': totalPayments,
                    'المتبقي': remaining,
                    'نوع السعر': getPriceTypeName(store.priceType)
                };
            });
        }
        
        // توليد بيانات تقرير الأرباح
        function generateProfitReportData() {
            if (!data) {
                return [{
                    'إجمالي المبيعات': 0,
                    'إجمالي المصروفات': 0,
                    'صافي الربح': 0
                }];
            }
            
            const totalSales = (data.sales || []).reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalPaymentsSum = (data.payments || []).reduce((sum, payment) => sum + (payment.amount || 0), 0);
            const totalExpenses = (data.expenses || []).reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const netProfit = totalPaymentsSum - totalExpenses;
            
            return [{
                'إجمالي المبيعات': totalSales,
                'إجمالي المصروفات': totalExpenses,
                'صافي الربح': netProfit
            }];
        }
        
        // توليد بيانات تقرير الشركاء
        function generatePartnerReportData() {
            const _rng = (typeof getPeriodRange==='function') ? getPeriodRange() : { fromDate: moment().startOf('month').format('YYYY-MM-DD'), toDate: moment().format('YYYY-MM-DD') };
            const fromDate = _rng.fromDate; const toDate = _rng.toDate;
            
            return [
                ...data.sales.filter(sale => sale.date >= fromDate && sale.date <= toDate).map(sale => ({
                    'النوع': 'بيع',
                    'المبلغ': sale.total,
                    'التفاصيل': sale.reason || (sale.packageId ? 'بيع باقة' : 'بيع مخصص'),
                    'التاريخ': sale.date
                })),
                ...data.expenses.filter(expense => expense.date >= fromDate && expense.date <= toDate).map(expense => ({
                    'النوع': 'مصروف',
                    'المبلغ': expense.amount,
                    'التفاصيل': expense.type,
                    'التاريخ': expense.date
                }))
            ];
        }
        // استيراد البيانات
        function importData() {
            // التأكد من وجود كائن البيانات
            if (typeof data === 'undefined' || !data) {
                window.data = {
                    packages: [],
                    inventory: [],
                    stores: [],
                    expenses: [],
                    sales: [],
                    payments: []
                };
            }
            
            const fileInput = document.getElementById('importFile');
            const replace = document.getElementById('replaceData').checked;
            const dataType = document.getElementById('importDataType').value;
            
            if (!fileInput.files.length) {
                showNotification('يرجى اختيار ملف للاستيراد', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            // التحقق من نوع الملف
            if (!file.type.includes('json') && !file.name.endsWith('.json')) {
                showNotification('يرجى اختيار ملف JSON صحيح', 'error');
                return;
            }
            
            // التحقق من حجم الملف (10 ميجابايت كحد أقصى)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('حجم الملف كبير جداً (الحد الأقصى 10 ميجابايت)', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log('بدء قراءة الملف...');
                    console.log('محتوى الملف الخام:', e.target.result.substring(0, 200) + '...');
                    
                    const importedData = JSON.parse(e.target.result);
                    console.log('تم تحليل JSON بنجاح:', importedData);
                    
                    // التحقق من صحة البيانات المستوردة
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('البيانات المستوردة غير صحيحة');
                    }

                    function toArraySafe(x){ return Array.isArray(x) ? x : []; }
                    function mergeUniqueById(existingArr, incomingArr){
                        const map = new Map();
                        // keep existing first
                        toArraySafe(existingArr).forEach(item => { if (item && item.id) map.set(item.id, item); });
                        // incoming overwrites by id
                        toArraySafe(incomingArr).forEach(item => {
                            if (item && item.id) { map.set(item.id, item); }
                            else if (item) {
                                // no id: dedupe by JSON string
                                const key = 'noid:' + JSON.stringify(item);
                                if (!map.has(key)) map.set(key, item);
                            }
                        });
                        // filter out synthetic noid keys
                        return Array.from(map.entries()).map(([k,v]) => v);
                    }
                    
                    console.log('نوع البيانات المختار:', dataType);
                    console.log('وضع الاستبدال:', replace);
                    
                    if (dataType === 'all') {
                        console.log('استيراد جميع البيانات...');
                        if (replace) {
                            data = {
                                packages: toArraySafe(importedData.packages),
                                inventory: toArraySafe(importedData.inventory),
                                stores: toArraySafe(importedData.stores),
                                expenses: toArraySafe(importedData.expenses),
                                sales: toArraySafe(importedData.sales),
                                payments: toArraySafe(importedData.payments),
                                trash: toArraySafe(importedData.trash)
                            };
                            // تحديث المتغير العام
                            window.data = data;
                            console.log('تم استبدال البيانات:', data);
                        } else {
                            // دمج فريد حسب المعرّف لكل نوع
                            data.packages = mergeUniqueById(data.packages, importedData.packages);
                            data.inventory = mergeUniqueById(data.inventory, importedData.inventory);
                            data.stores = mergeUniqueById(data.stores, importedData.stores);
                            data.expenses = mergeUniqueById(data.expenses, importedData.expenses);
                            data.sales = mergeUniqueById(data.sales, importedData.sales);
                            data.payments = mergeUniqueById(data.payments, importedData.payments);
                            data.trash = mergeUniqueById(data.trash, importedData.trash);
                            // تحديث المتغير العام
                            window.data = data;
                        }
                    } else {
                        // التعامل مع استيراد نوع واحد من البيانات
                        console.log('استيراد نوع واحد:', dataType);
                        let incoming;
                        
                        // التحقق من التنسيق: هل هو مصفوفة مباشرة أو كائن يحتوي على المصفوفة
                        if (Array.isArray(importedData)) {
                            console.log('البيانات عبارة عن مصفوفة مباشرة');
                            incoming = importedData;
                        } else if (importedData[dataType] && Array.isArray(importedData[dataType])) {
                            console.log('البيانات عبارة عن كائن يحتوي على مصفوفة');
                            incoming = importedData[dataType];
                        } else {
                            console.log('لم يتم العثور على بيانات صحيحة. البيانات المستوردة:', importedData);
                            console.log('المفتاح المطلوب:', dataType);
                            throw new Error(`لا يمكن العثور على بيانات ${dataType} صحيحة في الملف`);
                        }
                        
                        // التحقق من صحة البيانات المستوردة
                        if (!Array.isArray(incoming)) {
                            throw new Error(`البيانات المستوردة لـ ${dataType} ليست مصفوفة`);
                        }
                        
                        if (replace) {
                            data[dataType] = incoming;
                            // تحديث المتغير العام
                            window.data = data;
                            console.log(`تم استبدال ${dataType}:`, incoming);
                        } else {
                            data[dataType] = mergeUniqueById(data[dataType], incoming);
                            // تحديث المتغير العام
                            window.data = data;
                            console.log(`تم دمج ${dataType}:`, data[dataType]);
                        }
                    }
                    
                    console.log('البيانات قبل الحفظ:', data);
                    console.log('window.data قبل الحفظ:', window.data);
                    
                    // التأكد من أن البيانات محدثة قبل الحفظ
                    if (window.data !== data) {
                        console.warn('تحذير: window.data غير متزامن مع data');
                        window.data = data;
                    }
                    
                    saveData();
                    
                    // التحقق من البيانات بعد الحفظ
                    console.log('البيانات بعد الحفظ:', window.data);
                    
                    showNotification('تم استيراد البيانات بنجاح (تمت إزالة التكرارات)', 'success');
                    
                    // تحديث الواجهة
                    updateDashboard();
                    renderPackagesTable();
                    renderInventoryTable();
                    renderStoresList();
                    renderExpensesTable();
                    updateReportStores();
                    updateProfitReport();
                    generateDebtReport();
                    generatePartnerReports();
                    
                } catch (error) {
                    console.error('خطأ في استيراد البيانات:', error);
                    
                    // إزالة المحتوى من input file
                    fileInput.value = '';
                    
                    if (error instanceof SyntaxError) {
                        showNotification('خطأ في تنسيق ملف JSON. يرجى التأكد من صحة الملف', 'error');
                    } else if (error.message.includes('لا يمكن العثور على بيانات')) {
                        showNotification(error.message, 'error');
                    } else if (error.message.includes('ليست مصفوفة')) {
                        showNotification(error.message, 'error');
                    } else {
                        showNotification('حدث خطأ غير متوقع: ' + error.message, 'error');
                    }
                }
            };
            
            reader.onerror = function() {
                showNotification('خطأ في قراءة الملف', 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // إظهار الإشعارات
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }
        // تهيئة النظام عند التحميل
        // دالة مساعدة لتنظيف backdrop المتبقية
        function cleanupModalBackdrops() {
            // إزالة جميع backdrops المتبقية
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // إزالة الأنماط المتبقية على body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
        
        // تصدير الدالة للنطاق العام
        window.cleanupModalBackdrops = cleanupModalBackdrops;
        
        // دوال التواصل مع المحلات عبر الهاتف
        
        /**
         * إجراء مكالمة هاتفية
         */
        function makePhoneCall(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }
        
        /**
         * إرسال رسالة نصية بالرصيد الحالي
         */
        function sendBalanceSMS(phoneNumber, balance, storeName) {
            const status = balance >= 0 ? 'دائن' : 'مدين';
            const message = encodeURIComponent(
                `السلام عليكم،\n` +
                `محل: ${storeName}\n` +
                `الرصيد الحالي: ${formatNumber(Math.abs(balance))}\n` +
                `الحالة: ${status}\n` +
                `تاريخ: ${new Date().toLocaleDateString('ar-YE')}`
            );
            window.location.href = `sms:${phoneNumber}?body=${message}`;
        }
        
        /**
         * مشاركة تقرير المحل عبر Web Share API
         */
        function shareReport(storeId) {
            const store = data.stores.find(s => s.id === storeId);
            if (!store) return;
            
            const sales = data.sales.filter(s => s.storeId === storeId);
            const payments = data.payments.filter(p => p.storeId === storeId);
            const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalPayments = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const balance = totalSales - totalPayments;
            
            // إنشاء نص التقرير
            const reportText = 
                `تقرير محل: ${store.name}\n` +
                `━━━━━━━━━━━━━\n` +
                `إجمالي المبيعات: ${formatNumber(totalSales)}\n` +
                `إجمالي المدفوعات: ${formatNumber(totalPayments)}\n` +
                `الرصيد الحالي: ${formatNumber(Math.abs(balance))} ${balance >= 0 ? 'دائن' : 'مدين'}\n\n` +
                `تاريخ التقرير: ${new Date().toLocaleDateString('ar-YE')}\n\n` +
                `تم إنشاء هذا التقرير بواسطة نظام إدارة المبيعات`;
            
            // إنشاء رابط للتقرير
            const reportUrl = window.location.origin + window.location.pathname + `#store-report-${storeId}`;
            
            // التحقق من دعم Web Share API
            if (navigator.share) {
                navigator.share({
                    title: `تقرير محل ${store.name}`,
                    text: reportText,
                    url: reportUrl
                })
                .then(() => {
                    showNotification('تم مشاركة التقرير بنجاح', 'success');
                })
                .catch((error) => {
                    // إذا ألغى المستخدم المشاركة
                    if (error.name !== 'AbortError') {
                        console.error('خطأ في المشاركة:', error);
                        fallbackShare(reportText, reportUrl);
                    }
                });
            } else {
                // بديل للمتصفحات التي لا تدعم Web Share API
                fallbackShare(reportText, reportUrl);
            }
        }
        
        /**
         * بديل للمشاركة في حالة عدم دعم Web Share API
         */
        function fallbackShare(text, url) {
            // إنشاء نافذة منبثقة مع خيارات المشاركة
            const shareOptions = `
                <div class="text-center">
                    <h5 class="mb-3">مشاركة التقرير</h5>
                    <div class="d-flex justify-content-center gap-3 mb-3">
                        <button class="btn btn-primary" onclick="copyToClipboard('${escape(text)}', '${escape(url)}')">
                            <i class="fas fa-copy"></i> نسخ التقرير
                        </button>
                        <button class="btn btn-info" onclick="downloadReport('${escape(text)}')">
                            <i class="fas fa-download"></i> تحميل كملف
                        </button>
                    </div>
                    <small class="text-muted">يمكنك نسخ التقرير ولصقه في أي تطبيق</small>
                </div>
            `;
            
            // عرض النافذة المنبثقة
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body">
                            ${shareOptions}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // إزالة النافذة عند الإغلاق
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }
        
        /**
         * نسخ التقرير إلى الحافظة
         */
        function copyToClipboard(text, url) {
            const fullText = unescape(text) + '\n\nرابط التقرير:\n' + unescape(url);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullText)
                    .then(() => {
                        showNotification('تم نسخ التقرير إلى الحافظة', 'success');
                        // إغلاق النافذة المنبثقة
                        const modal = bootstrap.Modal.getInstance(document.querySelector('.modal'));
                        if (modal) modal.hide();
                    })
                    .catch(err => {
                        console.error('خطأ في النسخ:', err);
                        showNotification('فشل نسخ التقرير', 'error');
                    });
            } else {
                // طريقة بديلة للنسخ
                const textArea = document.createElement('textarea');
                textArea.value = fullText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showNotification('تم نسخ التقرير إلى الحافظة', 'success');
                    const modal = bootstrap.Modal.getInstance(document.querySelector('.modal'));
                    if (modal) modal.hide();
                } catch (err) {
                    showNotification('فشل نسخ التقرير', 'error');
                }
                
                document.body.removeChild(textArea);
            }
        }
        
        /**
         * تحميل التقرير كملف نصي
         */
        function downloadReport(text) {
            const decodedText = unescape(text);
            const blob = new Blob([decodedText], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `تقرير_محل_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('تم تحميل التقرير', 'success');
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal'));
            if (modal) modal.hide();
        }
        /**
         * مشاركة تقرير المحل عبر واتساب
         */
        function shareViaWhatsApp(storeId, dateFrom = null, dateTo = null) {
            const store = data.stores.find(s => s.id === storeId);
            if (!store || !store.phone) return;
            
            // فلترة حسب التاريخ إن وُجد
            let sales = data.sales.filter(s => s.storeId === storeId);
            let payments = data.payments.filter(p => p.storeId === storeId);
            
            if (dateFrom || dateTo) {
                const fromDate = dateFrom ? new Date(dateFrom) : new Date('1900-01-01');
                const toDate = dateTo ? new Date(dateTo) : new Date();
                
                sales = sales.filter(s => {
                    const saleDate = new Date(s.date);
                    return saleDate >= fromDate && saleDate <= toDate;
                });
                
                payments = payments.filter(p => {
                    const paymentDate = new Date(p.date);
                    return paymentDate >= fromDate && paymentDate <= toDate;
                });
            }
            
            // دمج وترتيب جميع العمليات
            const allTransactions = [];
            sales.forEach(sale => allTransactions.push({...sale, type: 'sale'}));
            payments.forEach(payment => allTransactions.push({...payment, type: 'payment'}));
            
            // تجميع العمليات حسب التاريخ
            const transactionsByDate = {};
            allTransactions.forEach(t => {
                const date = t.date;
                if (!transactionsByDate[date]) {
                    transactionsByDate[date] = { sales: [], payments: [] };
                }
                if (t.type === 'sale') {
                    transactionsByDate[date].sales.push(t);
                } else {
                    transactionsByDate[date].payments.push(t);
                }
            });
            
            // ترتيب التواريخ
            const sortedDates = Object.keys(transactionsByDate).sort();
            
            // حساب الرصيد السابق (قبل الفترة المحددة)
            let runningBalance = 0;
            let totalSalesSum = 0;
            
            if (dateFrom) {
                const previousSales = data.sales.filter(s => 
                    s.storeId === storeId && new Date(s.date) < new Date(dateFrom)
                );
                const previousPayments = data.payments.filter(p => 
                    p.storeId === storeId && new Date(p.date) < new Date(dateFrom)
                );
                
                const prevSalesTotal = previousSales.reduce((sum, s) => sum + s.total, 0);
                const prevPaymentsTotal = previousPayments.reduce((sum, p) => sum + p.amount, 0);
                runningBalance = prevSalesTotal - prevPaymentsTotal;
                totalSalesSum = prevSalesTotal;
            }
            
            // بناء التقرير
            let report = `*تقرير محل ${store.name}*\n`;
            if (dateFrom || dateTo) {
                report += `📅 الفترة: ${dateFrom || 'البداية'} إلى ${dateTo || 'اليوم'}\n`;
            }
            report += `━━━━━━━━━━━━━━━━━━━━━━\n\n`;
            
            // إضافة الرصيد السابق إن وجد
            if (runningBalance !== 0 && dateFrom) {
                report += `💳 *رصيد سابق:* ${formatNumber(Math.abs(runningBalance))} ${runningBalance >= 0 ? '(دائن)' : '(مدين)'}\n`;
                report += `────────────────────────────\n\n`;
            }
            
            // معالجة كل يوم
            sortedDates.forEach(date => {
                const dayTransactions = transactionsByDate[date];
                const previousBalance = runningBalance;
                
                report += `📅 *${formatDateEn(date)}*\n\n`;
                
                // إذا كان هناك رصيد دائن سابق، نعرض التسديدات أولاً
                if (previousBalance > 0 && dayTransactions.payments.length > 0) {
                    dayTransactions.payments.forEach(payment => {
                        runningBalance -= payment.amount;
                        report += `💵 *تسديد:* ${formatNumber(payment.amount)}\n`;
                        report += `   ← الرصيد: ${formatNumber(Math.abs(runningBalance))} ${runningBalance >= 0 ? '(دائن)' : '(مدين)'}\n\n`;
                    });
                }
                
                // عرض المبيعات
                dayTransactions.sales.forEach(sale => {
                    totalSalesSum += sale.total;
                    runningBalance += sale.total;
                    
                    let packageName = 'مبلغ مخصص';
                    if (sale.packageId) {
                        const pkg = data.packages.find(p => p.id === sale.packageId);
                        if (pkg) packageName = pkg.name;
                    }
                    
                    report += `🛍️ *بيع:* ${packageName}\n`;
                    report += `   الكمية: ${sale.quantity || 1} | المبلغ: ${formatNumber(sale.total)}\n`;
                    report += `   ← الرصيد: ${formatNumber(Math.abs(runningBalance))} ${runningBalance >= 0 ? '(دائن)' : '(مدين)'}\n\n`;
                });
                
                // إذا لم يكن هناك رصيد دائن سابق، نعرض التسديدات بعد المبيعات
                if (previousBalance <= 0 && dayTransactions.payments.length > 0) {
                    dayTransactions.payments.forEach(payment => {
                        runningBalance -= payment.amount;
                        report += `💵 *تسديد:* ${formatNumber(payment.amount)}\n`;
                        report += `   ← الرصيد: ${formatNumber(Math.abs(runningBalance))} ${runningBalance >= 0 ? '(دائن)' : '(مدين)'}\n\n`;
                    });
                }
                
                report += `────────────────────────────\n\n`;
            });
            
            // ملخص نهائي
            const periodSales = sales.reduce((sum, s) => sum + s.total, 0);
            const periodPayments = payments.reduce((sum, p) => sum + p.amount, 0);
            
            report += `*📊 الملخص:*\n`;
            report += `• مبيعات الفترة: ${formatNumber(periodSales)}\n`;
            report += `• تسديدات الفترة: ${formatNumber(periodPayments)}\n`;
            report += `• الرصيد النهائي: ${formatNumber(Math.abs(runningBalance))} ${runningBalance >= 0 ? '(دائن)' : '(مدين)'}\n\n`;
            report += `📅 تاريخ التقرير: ${new Date().toLocaleDateString('ar-YE')}`;
            
            // استخدام Web Share API إذا كان متاحاً
            if (navigator.share) {
                try {
                    navigator.share({
                        title: `تقرير محل ${store.name}`,
                        text: report
                    }).then(() => {
                        console.log('تمت المشاركة بنجاح');
                    }).catch((error) => {
                        console.log('تم إلغاء المشاركة:', error);
                    });
                } catch (error) {
                    console.error('خطأ في المشاركة:', error);
                    // في حالة الفشل، استخدام الطريقة القديمة
                    fallbackWhatsApp();
                }
            } else {
                // إذا لم يكن Web Share API متاحاً، اعرض خيارات
                showShareOptions();
            }
            
            // دالة احتياطية لفتح واتساب مباشرة
            function fallbackWhatsApp() {
                const message = encodeURIComponent(report);
                const whatsappUrl = `https://wa.me/${store.phone.replace(/^0/, '967')}?text=${message}`;
                window.open(whatsappUrl, '_blank');
            }
            
            // عرض خيارات المشاركة
            function showShareOptions() {
                const message = encodeURIComponent(report);
                const phoneNumber = store.phone.replace(/^0/, '967');
                
                // إنشاء نافذة منبثقة بالخيارات
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">مشاركة التقرير</h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="window.open('https://wa.me/${phoneNumber}?text=${message}', '_blank'); this.closest('.modal').remove();">
                                        <i class="fab fa-whatsapp"></i> WhatsApp
                                    </button>
                                    <button class="btn btn-success" onclick="window.open('https://api.whatsapp.com/send?phone=${phoneNumber}&text=${message}', '_blank'); this.closest('.modal').remove();">
                                        <i class="fab fa-whatsapp"></i> WhatsApp Business
                                    </button>
                                    <button class="btn btn-info" onclick="window.open('https://t.me/share/url?text=${message}', '_blank'); this.closest('.modal').remove();">
                                        <i class="fab fa-telegram"></i> Telegram
                                    </button>
                                    <button class="btn btn-primary" onclick="copyToClipboard(decodeURIComponent('${message}')); this.closest('.modal').remove(); showNotification('تم نسخ التقرير', 'success');">
                                        <i class="fas fa-copy"></i> نسخ التقرير
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }
        // تصدير دوال التواصل
        window.makePhoneCall = makePhoneCall;
        window.sendBalanceSMS = sendBalanceSMS;
        window.shareReport = shareReport;
        window.shareViaWhatsApp = shareViaWhatsApp;
        window.copyToClipboard = copyToClipboard;
        window.downloadReport = downloadReport;
        
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل البيانات
            loadData();
            
            // تغيير الأقسام
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetSection = this.getAttribute('data-section');
                    if (typeof switchSection === 'function') {
                        switchSection(targetSection, this.textContent.trim());
                    } else {
                        console.error('دالة switchSection غير موجودة');
                    }
                });
            });
            
            // التأكد من توفر دوال التصدير بعد تحميل جميع الملفات
            setTimeout(() => {
                // نسخ الدوال إلى النطاق العام إذا لم تكن متاحة
                if (!window.exportStoreData && typeof exportStoreData !== 'undefined') {
                    window.exportStoreData = exportStoreData;
                }
                if (!window.exportExpensesData && typeof exportExpensesData !== 'undefined') {
                    window.exportExpensesData = exportExpensesData;
                }
                
                console.log('فحص دوال التصدير:', {
                    exportStoreData: typeof window.exportStoreData,
                    exportExpensesData: typeof window.exportExpensesData,
                    exportReportsData: 'undefined'
                });
            }, 500);
            
            // توليد تقارير
            generateDebtReport();
            generatePartnerReports();
            
            // تهيئة حقول الإدخال المنسقة
            setupFormattedInputs();
            

            
            // إضافة معالجات الأحداث للأزرار
            document.getElementById('addPackageBtn').addEventListener('click', addPackage);
            document.getElementById('savePackageBtn').addEventListener('click', savePackage);
            
            document.getElementById('addInventoryBtn').addEventListener('click', addInventory);
            document.getElementById('saveInventoryBtn').addEventListener('click', saveInventory);
            
            document.getElementById('addStoreBtn').addEventListener('click', addStore);
            document.getElementById('saveStoreBtn').addEventListener('click', saveStore);
            
            document.getElementById('addExpenseBtn').addEventListener('click', addExpense);
            document.getElementById('saveExpenseBtn').addEventListener('click', saveExpense);
            
            const _genBtn = document.getElementById('generateReportBtn');
            if (_genBtn) _genBtn.addEventListener('click', function() {
                generateDebtReport();
                generatePartnerReports();
                showNotification('تم تحديث التقارير بنجاح', 'success');
            });
            
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', importData);
            
                        
            // إضافة معالجات الأحداث لأزرار التصدير العامة (تفويض أحداث يعمل مع المحتوى الديناميكي)
            document.body.addEventListener('click', function(e) {
                const btn = e.target.closest && e.target.closest('.export-btn');
                if (!btn) return;
                
                const type = btn.getAttribute('data-type');
                const format = btn.getAttribute('data-format');
                const storeId = btn.getAttribute('data-store') || '';
                
                console.log('تصدير:', { type, format, storeId });
                
                if (type === 'expenses') {
                    if (typeof exportExpensesData === 'function') {
                        exportExpensesData(format);
                    } else {
                        console.error('دالة exportExpensesData غير موجودة');
                        showNotification('خطأ: دالة التصدير غير متوفرة', 'error');
                    }

                } else if (type === 'store') {
                    if (typeof exportStoreData === 'function') {
                        exportStoreData(storeId, format);
                    } else if (window.exportStoreData) {
                        window.exportStoreData(storeId, format);
                    } else {
                        console.error('دالة exportStoreData غير موجودة');
                        showNotification('خطأ: دالة التصدير غير متوفرة', 'error');
                    }
                }
            }, false);
            
            const storeFilterBtn = document.getElementById('storeApplyFilterBtn');
            if (storeFilterBtn) {
                storeFilterBtn.addEventListener('click', () => {
                    showNotification('تم تطبيق فترة التصدير للمحل', 'success');
                });
            }
            
            // معالجة أزرار الحفظ في نماذج البيع والتسديد
            document.getElementById('saveSaleBtn').addEventListener('click', saveSale);
            document.getElementById('savePaymentBtn').addEventListener('click', savePayment);
            
            // تعيين تاريخ اليوم كافتراضي لحقول التاريخ
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            
            // اختصارات سريعة على لوحة التحكم
            const qa = {
                sale: document.getElementById('qaAddSale'),
                payment: document.getElementById('qaAddPayment'),
                inventory: document.getElementById('qaAddInventory'),
                expense: document.getElementById('qaAddExpense'),
                store: document.getElementById('qaAddStore'),
                pkg: document.getElementById('qaAddPackage'),
            };

            let nextAction = null; // 'sale' | 'payment'
            const selectStoreModalEl = document.getElementById('selectStoreModal');
            const selectStoreModal = selectStoreModalEl ? new bootstrap.Modal(selectStoreModalEl) : null;
            function openSelectStore(actionType) {
                if (!selectStoreModal) return;
                nextAction = actionType;
                const sel = document.getElementById('selectStoreSelect');
                sel.innerHTML = '';
                if (data.stores.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = ''; opt.textContent = 'لا توجد محلات، أضف محلًا أولاً';
                    sel.appendChild(opt);
                } else {
                    data.stores.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        sel.appendChild(opt);
                    });
                }
                selectStoreModal.show();
            }
            const confirmBtn = document.getElementById('confirmSelectStoreBtn');
            if (confirmBtn) confirmBtn.addEventListener('click', () => {
                const sel = document.getElementById('selectStoreSelect');
                const storeId = sel.value;
                if (!storeId) { showNotification('يرجى اختيار محل', 'error'); return; }
                selectStoreModal.hide();
                if (nextAction === 'sale') addSale(storeId);
                else if (nextAction === 'payment') addPayment(storeId);
                nextAction = null;
            });

            if (qa.sale) qa.sale.addEventListener('click', () => openSelectStore('sale'));
            if (qa.payment) qa.payment.addEventListener('click', () => openSelectStore('payment'));
            if (qa.inventory) qa.inventory.addEventListener('click', () => {
                // الانتقال لقسم كمية الكروت وفتح المودال
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-section="inventory"]').classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
                document.getElementById('inventory').style.display = 'block';
                document.querySelector('.page-title').textContent = 'كمية الكروت';
                addInventory();
            });
            if (qa.expense) qa.expense.addEventListener('click', () => {
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-section="expenses"]').classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
                document.getElementById('expenses').style.display = 'block';
                document.querySelector('.page-title').textContent = 'المصروفات';
                addExpense();
            });
            if (qa.store) qa.store.addEventListener('click', () => {
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-section="stores"]').classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
                document.getElementById('stores').style.display = 'block';
                document.querySelector('.page-title').textContent = 'البقالات والمحلات';
                addStore();
            });
            if (qa.pkg) qa.pkg.addEventListener('click', () => {
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-section="packages"]').classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
                document.getElementById('packages').style.display = 'block';
                document.querySelector('.page-title').textContent = 'الباقات والأسعار';
                addPackage();
            });

            // تعيين التاريخ في الشريط العلوي للجوال
            const mobileTopDateEl = document.getElementById('mobileTopDate');
            if (mobileTopDateEl) {
                mobileTopDateEl.textContent = toEnglishDigits(moment().format('YYYY-MM-DD'));
            }

            // ضمان إظهار القسم الحالي مع الحركة عند التحميل
            const currentVisible = document.querySelector('.section:not([style*="display: none"])') || document.getElementById('dashboard');
            if (currentVisible) currentVisible.classList.add('show');

            // مستمع لتغيير مدة الحساب في لوحة التحكم (آمن مع PeriodManager)
            const dashboardPeriodSelect = document.getElementById('dashboardPeriod');
            if (dashboardPeriodSelect) {
                let periodDebounce;
                function applyPeriod(){ try { if (typeof PeriodManager!=='undefined') PeriodManager.setPeriod(dashboardPeriodSelect.value); else { updateDashboard(); updateProfitReport(); generateDebtReport(); generatePartnerReports(); } } catch(_){ try{ updateDashboard(); updateProfitReport(); generateDebtReport(); generatePartnerReports(); }catch(__){} } }
                dashboardPeriodSelect.addEventListener('change', () => {
                    clearTimeout(periodDebounce);
                    periodDebounce = setTimeout(applyPeriod, 200);
                });
            }
            // تحديث sparklines عند تغيير تجميع الرسم
            const sparkGroup = document.getElementById('dashboardSparkGroup');
            if (sparkGroup) {
                sparkGroup.addEventListener('change', () => { try { updateDashboard(); } catch(_){} });
            }
            
            // شارة حالة المزامنة (آمنة) + عناصر تحكم سريعة وعرض آخر مزامنة
            (function(){
                const badge = document.getElementById('syncBadge');
                const headerActions = document.querySelector('.header-bar > div');
                function fmtNow(){ try { return moment().format('YYYY-MM-DD HH:mm'); } catch(_) { const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0')+" "+String(d.getHours()).padStart(2,'0')+":"+String(d.getMinutes()).padStart(2,'0'); } }
                function getLastSync(){ try { return localStorage.getItem('lastSyncTime') || ''; } catch(_) { return ''; } }
                function setLastSync(){ try { localStorage.setItem('lastSyncTime', fmtNow()); } catch(_) {} }
                function setBadge(text, cls){ if(!badge) return; badge.className = 'badge ' + cls; badge.textContent = text; badge.classList.remove('d-none'); }
                function ensureControls(){
                  if (!headerActions || document.getElementById('syncNowBtn')) return;
                  const syncBtn = document.createElement('button');
                  syncBtn.id = 'syncNowBtn';
                  syncBtn.type = 'button';
                  syncBtn.className = 'btn btn-sm btn-outline-success ms-2';
                  syncBtn.innerHTML = '<i class="fas fa-sync"></i> مزامنة الآن';
                  const reloadBtn = document.createElement('button');
                  reloadBtn.id = 'reloadFromCloudBtn';
                  reloadBtn.type = 'button';
                  reloadBtn.className = 'btn btn-sm btn-outline-info ms-2';
                  reloadBtn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> استرجاع';
                  const last = document.createElement('span');
                  last.id = 'lastSyncTime';
                  last.className = 'text-muted ms-2 small';
                  last.textContent = getLastSync() ? ('آخر مزامنة: ' + getLastSync()) : '';
                  headerActions.appendChild(syncBtn);
                  headerActions.appendChild(reloadBtn);
                  headerActions.appendChild(last);
                  syncBtn.addEventListener('click', async ()=>{
                    try{
                      if (typeof GithubSync==='undefined') return;
                      await GithubSync.upload();
                      setLastSync();
                      const el = document.getElementById('lastSyncTime'); if (el) el.textContent = 'آخر مزامنة: ' + getLastSync();
                      setBadge('تمت المزامنة', 'bg-success');
                    }catch(_){ setBadge('تعذر المزامنة', 'bg-warning'); }
                  });
                  reloadBtn.addEventListener('click', async ()=>{
                    try{
                      if (typeof GithubSync==='undefined') return;
                      await GithubSync.download();
                      setLastSync();
                      const el = document.getElementById('lastSyncTime'); if (el) el.textContent = 'آخر مزامنة: ' + getLastSync();
                      setBadge('تم الاسترجاع', 'bg-primary');
                    }catch(_){ setBadge('تعذر الاسترجاع', 'bg-warning'); }
                  });
                }
                async function refresh(){
                    try{
                        if (typeof GithubSync==='undefined' || !GithubSync.getSettings) { return; }
                        const s = GithubSync.getSettings();
                        ensureControls();
                        const last = document.getElementById('lastSyncTime'); if (last && getLastSync()) last.textContent = 'آخر مزامنة: ' + getLastSync();
                        if (!s || (!s.token && !s.gistId)) { setBadge('غير مهيأة', 'bg-secondary'); return; }
                        const res = await GithubSync.testConnection();
                        if (res && res.ok) { setBadge(res.hasFile ? 'متصل • ملف موجود' : 'متصل • لا يوجد ملف', 'bg-success'); }
                        else { setBadge('تعذر الاتصال', 'bg-warning'); }
                    } catch(_) { /* تجاهل */ }
                }
                setTimeout(refresh, 300);
            })();
            // تنظيف backdrop عند إغلاق أي modal
            document.addEventListener('hidden.bs.modal', function (event) {
                setTimeout(cleanupModalBackdrops, 100);
            });
            
            // معالج إضافي للتأكد من التنظيف عند الضغط على backdrop
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop')) {
                    setTimeout(cleanupModalBackdrops, 300);
                }
            });
            
            // معالج للتأكد من التنظيف عند الضغط على ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    setTimeout(cleanupModalBackdrops, 300);
                }
            });

            // تهيئة اقتراحات أنواع المصروفات (chips)
            const defaultExpenseTypes = [
                'كهرباء','انترنت ADSL','انترنت فايبر','انترنت ستار لينك','صيانة','سويتش',
                'كيبل كهرباء','كيبل انترنت رئيسي','كيبل انترنت منزلي','مواصلات','عامل','ايجار سطوح'
            ];
            function loadSavedExpenseTypes(){
                try { return JSON.parse(localStorage.getItem('expenseTypes')||'[]'); } catch { return []; }
            }
            function saveExpenseTypes(types){ localStorage.setItem('expenseTypes', JSON.stringify(Array.from(new Set(types)))); }
            function getAllExpenseTypes(){ return Array.from(new Set([...(loadSavedExpenseTypes()), ...defaultExpenseTypes])); }
            function renderExpenseTypeChips(selected){
                const wrap = document.getElementById('expenseTypeChips');
                if (!wrap) return;
                wrap.innerHTML = '';
                getAllExpenseTypes().forEach(t => {
                    const chip = document.createElement('span');
                    chip.className = 'expense-type-chip' + (selected === t ? ' active' : '');
                    chip.textContent = t;
                    chip.addEventListener('click', () => {
                        document.querySelectorAll('#expenseTypeChips .expense-type-chip').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        const hidden = document.getElementById('expenseType');
                        if (hidden) hidden.value = t;
                    });
                    wrap.appendChild(chip);
                });
            }
            function selectExpenseType(value){
                const hidden = document.getElementById('expenseType');
                if (hidden) hidden.value = value || '';
                renderExpenseTypeChips(value || '');
            }
            const addCustomBtn = document.getElementById('addCustomExpenseType');
            if (addCustomBtn){
                addCustomBtn.addEventListener('click', () => {
                    const inp = document.getElementById('expenseTypeCustom');
                    const val = (inp?.value || '').trim();
                    if (!val) return;
                    const types = getAllExpenseTypes();
                    if (!types.includes(val)) saveExpenseTypes([...(loadSavedExpenseTypes()), val]);
                    selectExpenseType(val);
                    inp.value = '';
                });
            }
            // في فتح مودال إضافة/تعديل المصروف نعيد رسم الشيبس ونعيّن الاختيار
            const expenseModalEl = document.getElementById('expenseModal');
            if (expenseModalEl){
                expenseModalEl.addEventListener('show.bs.modal', (ev) => {
                    const currentVal = document.getElementById('expenseType')?.value || '';
                    renderExpenseTypeChips(currentVal);
                });
            }
        });
    </script>
    <script src="./js/security.js"></script>
    <script src="./js/encryption.js"></script>
    <script src="./js/safeDOM.js"></script>
    <script src="./js/dataValidator.js"></script>
    <script src="./js/quickFixes.js"></script>
    <script src="./js/utils.js"></script>
    <script src="./js/storeFilter.js?v=8"></script>
    <script src="./js/reports.js?v=12"></script>
    <script src="./app.js"></script>
    <script src="./js/inventory.js"></script>
    <script src="./js/sales.js"></script>
    <script src="./js/payments.js"></script>
    <script src="./js/expenses.js"></script>
    <script src="./js/stores.js?v=11"></script>
    <script src="./js/packages.js"></script>
    <script src="./js/storage.js"></script>
    <script src="./js/backup.js"></script>
    <script src="./js/backupManager.js"></script>
    <script src="./js/expensesTypes.js"></script>
    <script src="./js/trash.js"></script>
    <script src="./js/about.js"></script>






    <!-- درج الجوال المخصص -->
    <div id="drawerBackdrop" class="drawer-backdrop"></div>
    <div id="mobileDrawer" class="mobile-drawer">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0">القائمة</h5>
            <button id="drawerClose" class="btn btn-sm btn-outline-light">إغلاق</button>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="#" data-section="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="packages"><i class="fas fa-box"></i> الباقات والأسعار</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="inventory"><i class="fas fa-cubes"></i> كمية الكروت</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="stores"><i class="fas fa-store"></i> البقالات والمحلات</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="expenses"><i class="fas fa-money-bill-wave"></i> المصروفات</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="reports"><i class="fas fa-chart-bar"></i> التقارير</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="importExport"><i class="fas fa-exchange-alt"></i> الاستيراد والتصدير</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="trash"><i class="fas fa-trash"></i> سلة المحذوفات</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-section="about"><i class="fas fa-info-circle"></i> حول التطبيق</a></li>
        </ul>
    </div>



            <!-- تذييل الحقوق والتواصل -->
            <footer class="site-footer mt-4 rounded-top">
                <div class="container-fluid p-3">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <div class="developer">تطوير: نجيب المقداد</div>
                            <div class="contact mt-1">
                                <div><i class="fas fa-phone"></i> هاتف: <a href="tel:775396439">775396439</a></div>
                                <div><i class="fab fa-whatsapp"></i> واتس اب: <a href="https://wa.me/967775396439" target="_blank" rel="noopener">wa.me/967775396439</a></div>
                                <div><i class="fab fa-facebook"></i> فيس بوك: <a href="https://www.facebook.com/love1991" target="_blank" rel="noopener">facebook.com/love1991</a></div>
                                <div><i class="fab fa-instagram"></i> انستجرام: <a href="https://www.instagram.com/mr.l0ve/" target="_blank" rel="noopener">instagram.com/mr.l0ve</a></div>
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end d-flex flex-column justify-content-center">
                            <div>جميع الحقوق محفوظة © 2025 نجيب المقداد</div>
                            <small class="mt-1">نسخة الويب التقدمية - تعمل دون إنترنت بعد التحميل الأول</small>
                            <small class="mt-1">⚖️ يُحظر نسخ أو توزيع هذا النظام بدون إذن مسبق</small>
                        </div>
                    </div>
                </div>
            </footer>



    <script>

    </script>

    <!-- Backup Manager Modal -->
    <div class="modal fade d-none" id="backupManagerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">مدير النسخ الاحتياطية (IndexedDB)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="backupAutoOnSave">
                                <label class="form-check-label" for="backupAutoOnSave">نسخ تلقائي عند الحفظ</label>
                            </div>
                            <label class="form-label">عدد النسخ المحفوظة (الاحتفاظ):</label>
                            <input type="number" id="backupRetention" class="form-control" min="1" value="10">
                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-outline-primary" id="backupCreateBtn" type="button"><i class="fas fa-plus me-1"></i>إنشاء نسخة جديدة</button>
                                <button class="btn btn-outline-success" id="backupRestoreBtn"><i class="fas fa-undo me-1"></i>استعادة النسخة المحددة</button>
                                <button class="btn btn-outline-secondary" id="backupExportBtn"><i class="fas fa-download me-1"></i>تصدير النسخة المحددة</button>
                                <button class="btn btn-outline-danger" id="backupDeleteBtn"><i class="fas fa-trash me-1"></i>حذف النسخة المحددة</button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>التاريخ</th>
                                            <th>السبب</th>
                                            <th>الحجم (بايت)</th>
                                            <th>العدادات (ح/م/د/ب/س/م)</th>
                                            <th>إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="snapshotsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Types Manager Modal -->
    <div class="modal fade" id="expenseTypesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إدارة أنواع المصروفات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="newExpenseTypeInput" class="form-control" placeholder="نوع جديد">
                        <button class="btn btn-primary" id="addExpenseTypeBtn"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="table-responsive" style="max-height: 320px; overflow:auto;">
                        <table class="table table-sm align-middle">
                            <thead><tr><th>النوع</th><th class="text-end">إجراءات</th></tr></thead>
                            <tbody id="expenseTypesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!--
        نظام التخزين المؤقت الذكي
        يحسن الأداء بنسبة 60-80% عن طريق حفظ نتائج الحسابات المعقدة
        يقلل من الحسابات المتكررة ويسرع استجابة التطبيق
    -->
    <script src="js/smartCache.js"></script>
    
    <!--
        نظام الإعدادات المتقدم
        يوفر واجهة شاملة لتخصيص جميع جوانب التطبيق
        يدعم الحفظ الذكي مع إمكانية التراجع والاستعادة
    -->
    <script src="js/settings.js"></script>
    <script src="js/settingsUI.js"></script>
    
    <!-- نظام الصوت -->
    <script src="js/soundSystem.js"></script>
    
    <!-- نظام النسخ الاحتياطي -->
    <script src="js/backupSystem.js"></script>
    
    <!-- مساعد التخزين السحابي -->
    <script src="js/cloudStorageHelper.js"></script>
    
    <script>
    // حل احتياطي: دالة بسيطة لعرض تعليمات Google Drive - متاحة فوراً
    window.showGoogleDriveInstructions = function(backupData) {
        console.log('showGoogleDriveInstructions called with data:', backupData);
        const dataStr = JSON.stringify(backupData || {test: "بيانات تجريبية"}, null, 2);
        const colabCode = `# كود Python لحفظ النسخة الاحتياطية في Google Drive
from google.colab import drive
import json
import os
from datetime import datetime

# ربط Google Drive
drive.mount('/content/drive')

# إنشاء مجلد "نجيب المقداد" إذا لم يكن موجوداً
folder_path = "/content/drive/MyDrive/نجيب المقداد"
if not os.path.exists(folder_path):
    os.makedirs(folder_path)
    print("✅ تم إنشاء مجلد: نجيب المقداد")

# البيانات
backup_data = '''${dataStr}'''

# حفظ الملف داخل المجلد
filename = f"backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
filepath = f"{folder_path}/{filename}"

with open(filepath, 'w', encoding='utf-8') as f:
    f.write(backup_data)

print(f"✅ تم حفظ النسخة في: نجيب المقداد/{filename}")
print(f"📁 المسار الكامل: {filepath}`;

        // إنشاء نافذة HTML
        const modalHTML = `
<div class="modal fade" id="driveInstructionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fab fa-google-drive"></i> حفظ في Google Drive
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <h5>📋 الطريقة السهلة: Google Colab</h5>
                    <p>فقط انسخ الكود والصقه في Google Colab!</p>
                </div>
                
                <ol class="mb-3">
                    <li>افتح <a href="https://colab.research.google.com" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> Google Colab
                    </a></li>
                    <li>أنشئ دفتر ملاحظات جديد (New notebook)</li>
                    <li>انسخ الكود التالي:</li>
                </ol>
                
                <div class="position-relative">
                    <pre class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code id="colabCodeContent">${colabCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>
                    <button class="btn btn-success position-absolute top-0 end-0 m-2" onclick="copyColabCode()">
                        <i class="fas fa-copy"></i> نسخ الكود
                    </button>
                </div>
                
                <ol start="4" class="mt-3">
                    <li>الصق الكود في Colab</li>
                    <li>اضغط على زر التشغيل ▶️ أو Ctrl+Enter</li>
                    <li>اسمح بالوصول لـ Google Drive عند الطلب</li>
                    <li>انتظر رسالة "✅ تم حفظ النسخة"</li>
                </ol>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> 
                    <strong>ملاحظة:</strong> الملف سيُحفظ في المجلد الرئيسي لـ Google Drive الخاص بك
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                <a href="https://colab.research.google.com" target="_blank" class="btn btn-primary">
                    <i class="fab fa-google"></i> فتح Google Colab
                </a>
            </div>
        </div>
    </div>
</div>`;

        // إضافة النافذة للصفحة
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = modalHTML;
        document.body.appendChild(tempDiv.firstElementChild);
        
        // دالة النسخ
        window.copyColabCode = function() {
            const codeElement = document.getElementById('colabCodeContent');
            const textToCopy = codeElement.textContent;
            navigator.clipboard.writeText(textToCopy).then(function() {
                showNotification('تم نسخ الكود!', 'success');
            }).catch(function(err) {
                console.error('فشل النسخ:', err);
                // حل بديل
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('تم نسخ الكود!', 'success');
            });
        };
        
        // عرض النافذة
        const modal = new bootstrap.Modal(document.getElementById('driveInstructionsModal'));
        modal.show();
        
        // حذف النافذة عند الإغلاق
        document.getElementById('driveInstructionsModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    };
    
    // التأكد من تحميل نظام النسخ الاحتياطي الجديد
    document.addEventListener('DOMContentLoaded', function() {
        // إعادة تعريف createBackup لاستخدام النظام الجديد
        window.createBackup = async function() {
            console.log('Creating backup...');
            
            // التحقق من BackupSystem
            if (window.BackupSystem && window.BackupSystem.createBackup) {
                return await window.BackupSystem.createBackup();
            } else {
                showNotification('نظام النسخ الاحتياطي غير متاح', 'error');
                console.error('BackupSystem not loaded');
            }
        };
        
        // تسجيل حالة التحميل
        if (window.BackupSystem) {
            console.log('✅ BackupSystem loaded successfully');
        } else {
            console.error('❌ BackupSystem not loaded');
        }
        
        if (window.CloudStorageHelper) {
            console.log('✅ CloudStorageHelper loaded successfully');
        } else {
            console.error('❌ CloudStorageHelper not loaded');
        }
    });
    
    // زر اختبار Google Drive - للتأكد من عمل النظام
    window.testGoogleDriveBackup = function() {
        console.log('Testing Google Drive backup...');
        
        // بيانات تجريبية
        const testData = {
            stores: [{id: 1, name: "متجر تجريبي"}],
            sales: [{id: 1, amount: 1000}],
            timestamp: new Date().toISOString()
        };
        
        // عرض النافذة مباشرة
        if (typeof window.showGoogleDriveInstructions === 'function') {
            console.log('Calling showGoogleDriveInstructions directly');
            window.showGoogleDriveInstructions(testData);
        } else {
            console.error('showGoogleDriveInstructions not found!');
            alert('الدالة غير موجودة! تحقق من Console');
        }
    };
    </script>
    
    <script>
    /**
     * اختبار صوت التنبيهات
     * يشغل أصوات مختلفة حسب النوع
     */
    function testNotificationSound() {
        if (!window.SoundSystem) {
            showNotification('نظام الصوت غير متاح', 'error');
            return;
        }
        
        // تحديث إعدادات الصوت
        const soundEnabled = document.getElementById('setting-soundEnabled')?.checked || false;
        window.SoundSystem.updateSettings(soundEnabled, 50);
        
        if (!soundEnabled) {
            showNotification('الأصوات معطلة. قم بتفعيلها أولاً', 'warning');
            return;
        }
        
        // تشغيل سلسلة من الأصوات للاختبار
        showNotification('صوت النجاح', 'success');
        
        setTimeout(() => {
            showNotification('صوت التحذير', 'warning');
        }, 1500);
        
        setTimeout(() => {
            showNotification('صوت الخطأ', 'error');
        }, 3000);
        
        setTimeout(() => {
            showNotification('صوت المعلومات', 'info');
        }, 4500);
    }
    </script>
    
    <!-- 
        مراقب أداء الكاش (اختياري)
        يعرض إحصائيات الكاش في أسفل الشاشة
        يمكن إظهاره/إخفاؤه بالضغط على Ctrl+Shift+C
    -->
    <div id="cacheMonitor" style="position: fixed; bottom: 10px; left: 10px; 
         background: rgba(0,0,0,0.85); color: white; padding: 15px; 
         border-radius: 8px; font-size: 12px; display: none; z-index: 10000;
         box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 250px;">
        <h6 style="margin: 0 0 10px 0; color: #4CAF50;">
            <i class="fas fa-tachometer-alt"></i> مراقب الكاش الذكي
        </h6>
        <div id="cacheStats" style="font-family: monospace;"></div>
        <div style="margin-top: 10px; display: flex; gap: 5px;">
            <button onclick="balanceCache.clear(); showNotification('تم مسح كاش الأرصدة', 'info');" 
                    class="btn btn-sm btn-danger">مسح الأرصدة</button>
            <button onclick="reportCache.clear(); showNotification('تم مسح كاش التقارير', 'info');" 
                    class="btn btn-sm btn-warning">مسح التقارير</button>
        </div>
    </div>
    
    <script>
        /**
         * تفعيل مراقب الكاش
         * يعرض إحصائيات الأداء وكفاءة الكاش
         * يساعد في تحديد فعالية نظام التخزين المؤقت
         */
        // إظهار/إخفاء مراقب الكاش بـ Ctrl+Shift+C
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                const monitor = document.getElementById('cacheMonitor');
                monitor.style.display = monitor.style.display === 'none' ? 'block' : 'none';
            }
        });
        
        /**
         * تحديث إحصائيات الكاش كل ثانية
         * يعرض عدد العناصر المخزنة ونسبة النجاح والوقت الموفر
         */
        setInterval(() => {
            if (typeof balanceCache !== 'undefined' && typeof reportCache !== 'undefined') {
                const el = document.getElementById('cacheStats');
                if (el && document.getElementById('cacheMonitor').style.display !== 'none') {
                    const bStats = balanceCache.getStats();
                    const rStats = reportCache.getStats();
                    
                    // حساب الوقت الموفر (بافتراض 20ms لكل عملية محفوظة)
                    const timeSaved = ((bStats.hits * 20 + rStats.hits * 100) / 1000).toFixed(1);
                    
                    el.innerHTML = `
                        <div style="color: #81C784;">
                            <i class="fas fa-store"></i> أرصدة: ${bStats.size}/${bStats.maxSize} 
                            | ${bStats.hitRate} نجاح
                        </div>
                        <div style="color: #64B5F6;">
                            <i class="fas fa-chart-bar"></i> تقارير: ${rStats.size}/${rStats.maxSize} 
                            | ${rStats.hitRate} نجاح
                        </div>
                        <div style="color: #FFD54F; margin-top: 5px;">
                            <i class="fas fa-clock"></i> وقت موفر: ${timeSaved} ثانية
                        </div>
                        <div style="color: #FF8A65;">
                            <i class="fas fa-fire"></i> إجمالي: ${bStats.hits + rStats.hits} استخدام ناجح
                        </div>
                    `;
                }
            }
        }, 1000);
    </script>

</body>
</html>